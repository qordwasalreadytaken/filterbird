<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FilterPhoenix - Visual Filter Builder</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: #1a1a1a;
            color: #e0e0e0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: #2a2a2a;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        h1 {
            margin: 0 0 10px 0;
            color: #fff;
        }

        .subtitle {
            color: #999;
            font-size: 14px;
        }

        .layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
        }

        .editor-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .section {
            background: #2a2a2a;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .section-header {
            padding: 15px 20px;
            background: #333;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            border-bottom: 1px solid #444;
        }

        .section-header:hover {
            background: #3a3a3a;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
        }

        .section-toggle {
            font-size: 20px;
            color: #999;
            transition: transform 0.2s;
        }

        .section.expanded .section-toggle {
            transform: rotate(90deg);
        }

        .section-content {
            display: none;
            padding: 15px 20px;
        }

        .section.expanded .section-content {
            display: block;
        }

        .preset-controls {
            margin-bottom: 15px;
            padding: 10px;
            background: #252525;
            border-radius: 4px;
        }

        .preset-controls label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            color: #aaa;
        }

        .preset-select {
            width: 100%;
            padding: 8px;
            background: #333;
            border: 1px solid #444;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 14px;
        }

        .item-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .item-row {
            padding: 10px;
            background: #252525;
            border-radius: 4px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .custom-color-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .custom-label {
            font-size: 11px;
            color: #999;
        }

        .colors-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .item-row:hover {
            background: #2a2a2a;
        }

        .item-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .item-name {
            font-size: 14px;
            color: #ddd;
        }

        .color-picker-wrapper {
            display: flex;
            align-items: center;
            gap: 5px;
            position: relative;
        }

        .color-clear-btn {
            width: 18px;
            height: 18px;
            padding: 0;
            background: #444;
            border: 1px solid #555;
            border-radius: 3px;
            color: #aaa;
            cursor: pointer;
            font-size: 12px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .color-clear-btn:hover {
            background: #555;
            color: #fff;
        }

        .color-label {
            font-size: 11px;
            color: #999;
            min-width: 50px;
        }

        .color-input {
            width: 50px;
            height: 28px;
            border: 1px solid #444;
            border-radius: 3px;
            cursor: pointer;
            background: #333;
        }

        .color-select {
            width: 100px;
            height: 28px;
            padding: 4px;
            border: 1px solid #444;
            border-radius: 3px;
            background: #333;
            color: #e0e0e0;
            font-size: 11px;
            cursor: pointer;
        }

        .output-panel {
            position: sticky;
            top: 20px;
            height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
        }

        .output-section {
            background: #2a2a2a;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }

        .output-header {
            padding: 15px 20px;
            background: #333;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .output-title {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
        }

        .output-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            background: #4a4a4a;
            border: 1px solid #555;
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #555;
        }

        .btn-primary {
            background: #0066cc;
            border-color: #0066cc;
        }

        .btn-primary:hover {
            background: #0052a3;
        }

        .output-textarea {
            flex: 1;
            padding: 15px;
            background: #1a1a1a;
            border: none;
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            resize: none;
            line-height: 1.5;
        }

        .output-textarea:focus {
            outline: none;
        }

        .output-textarea.highlight-active {
            background: linear-gradient(to right, #2a4a2a 0%, #1a1a1a 100%);
            transition: background 0.3s ease;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-container {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            animation: modalFadeIn 0.2s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-header {
            padding: 20px;
            background: #333;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            margin: 0;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: #999;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            line-height: 1;
        }

        .modal-close:hover {
            background: #444;
            color: #fff;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-section {
            margin-bottom: 25px;
        }

        .modal-section:last-child {
            margin-bottom: 0;
        }

        .modal-section-title {
            font-size: 14px;
            font-weight: 600;
            color: #ccc;
            margin: 0 0 12px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid #444;
        }

        .modal-control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .modal-checkbox-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        .modal-checkbox-label {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 8px;
            background: #252525;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .modal-checkbox-label:hover {
            background: #2d2d2d;
        }

        .modal-checkbox-label input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
        }

        .modal-checkbox-label input[type="checkbox"]:checked + span {
            color: #0066cc;
            font-weight: bold;
        }

        .modal-button-group {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .modal-btn {
            padding: 6px 12px;
            background: #444;
            border: 1px solid #555;
            border-radius: 4px;
            color: #ddd;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .modal-btn:hover {
            background: #555;
        }

        .modal-color-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: #252525;
            border-radius: 4px;
        }

        .modal-color-label {
            font-size: 12px;
            color: #999;
            min-width: 80px;
        }

        .modal-color-input {
            width: 60px;
            height: 30px;
            border: 1px solid #444;
            border-radius: 4px;
            cursor: pointer;
            background: #333;
        }

        .modal-select {
            flex: 1;
            padding: 6px 8px;
            background: #333;
            border: 1px solid #444;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 12px;
            cursor: pointer;
        }

        .modal-clear-btn {
            padding: 6px 12px;
            background: #444;
            border: 1px solid #555;
            border-radius: 4px;
            color: #aaa;
            font-size: 11px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .modal-clear-btn:hover {
            background: #555;
            color: #fff;
        }

        .settings-btn {
            width: 28px;
            height: 28px;
            padding: 0;
            background: #444;
            border: 1px solid #555;
            border-radius: 4px;
            color: #aaa;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .settings-btn:hover {
            background: #555;
            color: #fff;
            transform: rotate(30deg);
        }

        .socket-checkbox-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .socket-checkbox-label {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            background: #252525;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .socket-checkbox-label:hover {
            background: #2d2d2d;
        }

        .socket-checkbox-label input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
        }

        .item-count {
            font-size: 12px;
            color: #777;
            margin-left: 5px;
        }

        /* Hide default file input */
        input[type="file"] {
            display: none;
        }

        .filter-info {
            padding: 10px 20px;
            background: #252525;
            border-top: 1px solid #444;
            font-size: 12px;
            color: #999;
        }

        .global-settings {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .global-settings h3 {
            margin: 0 0 15px 0;
            color: #fff;
            font-size: 16px;
        }

        .filter-levels-config {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #444;
        }

        .filter-levels-config.active {
            display: block;
        }

        .level-names-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .level-name-input {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .level-name-input label {
            font-size: 11px;
            color: #999;
        }

        .level-name-input input {
            padding: 6px 8px;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 3px;
            color: #e0e0e0;
            font-size: 12px;
        }

        .levels-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 10px;
        }

        .levels-selector.disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        .levels-label {
            font-size: 11px;
            color: #999;
        }

        .level-checkboxes {
            display: flex;
            gap: 4px;
        }

        .level-checkbox-wrapper {
            position: relative;
            display: inline-block;
        }

        .level-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .level-checkbox-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10px;
            color: #666;
            pointer-events: none;
            font-weight: bold;
        }

        .level-checkbox:checked + .level-checkbox-label {
            color: #0066cc;
        }

        .btn-link {
            background: none;
            border: none;
            color: #0066cc;
            cursor: pointer;
            font-size: 11px;
            padding: 2px 6px;
            text-decoration: underline;
        }

        .btn-link:hover {
            color: #0052a3;
        }

        /* Newer level filter styles */
        .item-main {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .levels-container {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .level-all-btn, .level-none-btn {
            padding: 2px 8px;
            background: #3a3a3a;
            border: 1px solid #555;
            border-radius: 3px;
            color: #aaa;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.2s;
        }

        .level-all-btn:hover, .level-none-btn:hover {
            background: #4a4a4a;
            color: #fff;
        }

        label.level-checkbox {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            transition: background 0.2s;
        }

        label.level-checkbox:hover {
            background: #3a3a3a;
        }

        label.level-checkbox input[type="checkbox"] {
            width: 14px;
            height: 14px;
            margin: 0;
            cursor: pointer;
        }

        label.level-checkbox span {
            font-size: 11px;
            color: #aaa;
            user-select: none;
        }

        label.level-checkbox input[type="checkbox"]:checked + span {
            color: #0066cc;
            font-weight: bold;
        }

        .custom-container, .notify-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .custom-checkbox, .notify-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .notify-label {
            font-size: 11px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>FilterPhoenix - Visual Filter Builder - Alpha/Test Version</h1>
            <div class="subtitle">Point-and-click interface for creating simple Path of Diablo item filters</div>
            <div class="subtitle" style="color: #ff4444;">This is not yet ready for production use, but testing and feedback are appreciated.</div>
        </header>

        <div class="layout">
            <div class="editor-panel">
                <!-- Global Settings -->
                <div class="global-settings">
                    <h3>Global Settings</h3>
                    <div>
                        <label>
                            <input type="checkbox" id="enable-filter-levels" onchange="toggleFilterLevels(this.checked)">
                            Enable Filter Levels (1-10)
                        </label>
                    </div>
                    <div class="filter-levels-config" id="filter-levels-config">
                        <p style="font-size: 12px; color: #999; margin: 0 0 10px 0;">Name your filter levels (used for strictness control, only named filterlevels will be used):</p>
                        <div class="level-names-grid" id="level-names-grid">
                            <!-- Level name inputs will be generated here -->
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <label title="Hides inferior (INF) items">
                            <input type="checkbox" id="hide-junk" onchange="toggleHideJunk(this.checked)" checked>
                            Hide Junk
                        </label>
                    </div>
                    <div style="margin-top: 8px;">
                        <label title="Shows anything not explicitly hidden by another line">
                            <input type="checkbox" id="show-all" onchange="toggleShowAll(this.checked)" checked>
                            End the filter with show anything not explicitly hidden
                        </label>
                    </div>
                </div>

                <!-- Utility Items Section -->
                <div class="section" id="utility-section">
                    <div class="section-header" onclick="toggleSection('utility-section')">
                        <div>
                            <span class="section-title">Utility Items</span>
                            <span class="item-count" id="utility-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyUtilityPreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                                <option value="essential-only">Essential Only (Potions + Scrolls)</option>
                                <option value="endgame">Endgame (Hide low potions)</option>
                            </select>
                        </div>
                        <div class="item-list" id="utility-items"></div>
                    </div>
                </div>

                <!-- Runes Section -->
                <div class="section" id="runes-section">
                    <div class="section-header" onclick="toggleSection('runes-section')">
                        <div>
                            <span class="section-title">Runes</span>
                            <span class="item-count" id="runes-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyRunePreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                                <option value="hide-low">Hide Low Runes (El-Ort)</option>
                                <option value="mid-plus">Mid+ Runes Only (Thul+)</option>
                                <option value="high-only">High Runes Only (Pul+)</option>
                            </select>
                        </div>
                        <div class="item-list" id="runes-items"></div>
                    </div>
                </div>

                <!-- Gems Section -->
                <div class="section" id="gems-section">
                    <div class="section-header" onclick="toggleSection('gems-section')">
                        <div>
                            <span class="section-title">Gems</span>
                            <span class="item-count" id="gems-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyGemPreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                                <option value="perfect-only">Perfect Only</option>
                                <option value="flawless-plus">Flawless+</option>
                                <option value="regular-plus">Regular+</option>
                            </select>
                        </div>
                        <div class="item-list" id="gems-items"></div>
                    </div>
                </div>

                <!-- PoD/Keys/Maps/Quest & Misc Section -->
                <div class="section" id="misc-section">
                    <div class="section-header" onclick="toggleSection('misc-section')">
                        <div>
                            <span class="section-title">PoD/Keys/Maps/Quest & Misc Items</span>
                            <span class="item-count" id="misc-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyMiscPreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                                <option value="essentials">Essentials (Keys/Organs/Essences/Orbs)</option>
                            </select>
                        </div>
                        <div class="item-list" id="misc-items"></div>
                    </div>
                </div>

                <!-- Unique Jewelry & Charms Section -->
                <div class="section" id="jewelry-charms-section">
                    <div class="section-header" onclick="toggleSection('jewelry-charms-section')">
                        <div>
                            <span class="section-title">Unique Jewelry & Charms</span>
                            <span class="item-count" id="jewelry-charms-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyJewelryCharmsPreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                            </select>
                        </div>
                        <div class="item-list" id="jewelry-charms-items"></div>
                    </div>
                </div>

                <!-- Class-Specific Uniques Section -->
                <div class="section" id="class-uniques-section">
                    <div class="section-header" onclick="toggleSection('class-uniques-section')">
                        <div>
                            <span class="section-title">Class-Specific Unique Items</span>
                            <span class="item-count" id="class-uniques-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyClassUniquesPreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                            </select>
                        </div>
                        <div class="item-list" id="class-uniques-items"></div>
                    </div>
                </div>

                <!-- Elite Unique Weapons Section -->
                <div class="section" id="elite-weapons-section">
                    <div class="section-header" onclick="toggleSection('elite-weapons-section')">
                        <div>
                            <span class="section-title">Elite Unique Weapons</span>
                            <span class="item-count" id="elite-weapons-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyEliteWeaponsPreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                            </select>
                        </div>
                        <div class="item-list" id="elite-weapons-items"></div>
                    </div>
                </div>

                <!-- Elite Unique Armor Section -->
                <div class="section" id="elite-armor-section">
                    <div class="section-header" onclick="toggleSection('elite-armor-section')">
                        <div>
                            <span class="section-title">Elite Unique Armor</span>
                            <span class="item-count" id="elite-armor-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyEliteArmorPreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                            </select>
                        </div>
                        <div class="item-list" id="elite-armor-items"></div>
                    </div>
                </div>

                <!-- Exceptional Unique Weapons Section -->
                <div class="section" id="exc-weapons-section">
                    <div class="section-header" onclick="toggleSection('exc-weapons-section')">
                        <div>
                            <span class="section-title">Exceptional Unique Weapons</span>
                            <span class="item-count" id="exc-weapons-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyExcWeaponsPreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                            </select>
                        </div>
                        <div class="item-list" id="exc-weapons-items"></div>
                    </div>
                </div>

                <!-- Exceptional Unique Armor Section -->
                <div class="section" id="exc-armor-section">
                    <div class="section-header" onclick="toggleSection('exc-armor-section')">
                        <div>
                            <span class="section-title">Exceptional Unique Armor</span>
                            <span class="item-count" id="exc-armor-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyExcArmorPreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                            </select>
                        </div>
                        <div class="item-list" id="exc-armor-items"></div>
                    </div>
                </div>

                <!-- Normal Unique Weapons Section -->
                <div class="section" id="norm-weapons-section">
                    <div class="section-header" onclick="toggleSection('norm-weapons-section')">
                        <div>
                            <span class="section-title">Normal Unique Weapons</span>
                            <span class="item-count" id="norm-weapons-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyNormWeaponsPreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                            </select>
                        </div>
                        <div class="item-list" id="norm-weapons-items"></div>
                    </div>
                </div>

                <!-- Normal Unique Armor Section -->
                <div class="section" id="norm-armor-section">
                    <div class="section-header" onclick="toggleSection('norm-armor-section')">
                        <div>
                            <span class="section-title">Normal Unique Armor</span>
                            <span class="item-count" id="norm-armor-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyNormArmorPreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                            </select>
                        </div>
                        <div class="item-list" id="norm-armor-items"></div>
                    </div>
                </div>

                <!-- High-Level Sets Section -->
                <div class="section" id="high-sets-section">
                    <div class="section-header" onclick="toggleSection('high-sets-section')">
                        <div>
                            <span class="section-title">High-Level Set Items</span>
                            <span class="item-count" id="high-sets-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyHighSetsPreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                            </select>
                        </div>
                        <div class="item-list" id="high-sets-items"></div>
                    </div>
                </div>

                <!-- Mid-Level Sets Section -->
                <div class="section" id="mid-sets-section">
                    <div class="section-header" onclick="toggleSection('mid-sets-section')">
                        <div>
                            <span class="section-title">Mid-Level Set Items</span>
                            <span class="item-count" id="mid-sets-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyMidSetsPreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                            </select>
                        </div>
                        <div class="item-list" id="mid-sets-items"></div>
                    </div>
                </div>

                <!-- Low-Level Sets Section -->
                <div class="section" id="low-sets-section">
                    <div class="section-header" onclick="toggleSection('low-sets-section')">
                        <div>
                            <span class="section-title">Low-Level Set Items</span>
                            <span class="item-count" id="low-sets-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyLowSetsPreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                            </select>
                        </div>
                        <div class="item-list" id="low-sets-items"></div>
                    </div>
                </div>

                <!-- Magic Jewelry Section -->
                <div class="section" id="magic-jewelry-section">
                    <div class="section-header" onclick="toggleSection('magic-jewelry-section')">
                        <div>
                            <span class="section-title">Magic Jewelry & Jewels</span>
                            <span class="item-count" id="magic-jewelry-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyMagicJewelryPreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                                <option value="high-ilvl">High ILVL Only</option>
                            </select>
                        </div>
                        <div class="item-list" id="magic-jewelry-items"></div>
                    </div>
                </div>

                <!-- Magic Charms Section -->
                <div class="section" id="magic-charms-section">
                    <div class="section-header" onclick="toggleSection('magic-charms-section')">
                        <div>
                            <span class="section-title">Magic Charms</span>
                            <span class="item-count" id="magic-charms-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyMagicCharmsPreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                                <option value="high-ilvl">High ILVL Only</option>
                            </select>
                        </div>
                        <div class="item-list" id="magic-charms-items"></div>
                    </div>
                </div>

                <!-- Magic Crafting Bases Section -->
                <div class="section" id="magic-crafting-section">
                    <div class="section-header" onclick="toggleSection('magic-crafting-section')">
                        <div>
                            <span class="section-title">Magic Crafting Bases</span>
                            <span class="item-count" id="magic-crafting-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyMagicCraftingPreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                            </select>
                        </div>
                        <div class="item-list" id="magic-crafting-items"></div>
                    </div>
                </div>

                <!-- Rare Jewelry Section -->
                <div class="section" id="rare-jewelry-section">
                    <div class="section-header" onclick="toggleSection('rare-jewelry-section')">
                        <div>
                            <span class="section-title">Rare Jewelry & Jewels</span>
                            <span class="item-count" id="rare-jewelry-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyRareJewelryPreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                            </select>
                        </div>
                        <div class="item-list" id="rare-jewelry-items"></div>
                    </div>
                </div>

                <!-- Rare Class Items Section -->
                <div class="section" id="rare-class-items-section">
                    <div class="section-header" onclick="toggleSection('rare-class-items-section')">
                        <div>
                            <span class="section-title">Rare Class-Specific Items</span>
                            <span class="item-count" id="rare-class-items-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyRareClassItemsPreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                            </select>
                        </div>
                        <div class="item-list" id="rare-class-items-items"></div>
                    </div>
                </div>

                <!-- Rare Elite Bases Section -->
                <div class="section" id="rare-elite-bases-section">
                    <div class="section-header" onclick="toggleSection('rare-elite-bases-section')">
                        <div>
                            <span class="section-title">Rare Elite Bases</span>
                            <span class="item-count" id="rare-elite-bases-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyRareEliteBasesPreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                            </select>
                        </div>
                        <div class="item-list" id="rare-elite-bases-items"></div>
                    </div>
                </div>

                <!-- NMAG RUNEWORD BASES -->
                <div class="section-divider" style="margin: 30px 0; text-align: center; color: #666; font-weight: bold; font-size: 16px;">
                    === Popular RUNEWORD BASES NMAG ===
                </div>

                <!-- Weapons -->
                <div class="section" id="nmag-polearms-section">
                    <div class="section-header" onclick="toggleSection('nmag-polearms-section')">
                        <div>
                            <span class="section-title">NMAG: Polearms (Insight, Infinity, Obedience)</span>
                            <span class="item-count" id="nmag-polearms-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyNmagPolearmsPreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                                <option value="eth-only">ETH Only</option>
                                <option value="4sock">4-Socket Only</option>
                            </select>
                        </div>
                        <div class="item-list" id="nmag-polearms-items"></div>
                    </div>
                </div>

                <div class="section" id="nmag-swords-section">
                    <div class="section-header" onclick="toggleSection('nmag-swords-section')">
                        <div>
                            <span class="section-title">NMAG: Swords (Spirit, Grief)</span>
                            <span class="item-count" id="nmag-swords-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyNmagSwordsPreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                                <option value="elite-only">Elite Only</option>
                            </select>
                        </div>
                        <div class="item-list" id="nmag-swords-items"></div>
                    </div>
                </div>

                <div class="section" id="nmag-axes-section">
                    <div class="section-header" onclick="toggleSection('nmag-axes-section')">
                        <div>
                            <span class="section-title">NMAG: Axes (Grief, Beast, Death)</span>
                            <span class="item-count" id="nmag-axes-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyNmagAxesPreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                            </select>
                        </div>
                        <div class="item-list" id="nmag-axes-items"></div>
                    </div>
                </div>

                <div class="section" id="nmag-maces-section">
                    <div class="section-header" onclick="toggleSection('nmag-maces-section')">
                        <div>
                            <span class="section-title">NMAG: Maces (BoTD, Heart of the Oak)</span>
                            <span class="item-count" id="nmag-maces-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyNmagMacesPreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                            </select>
                        </div>
                        <div class="item-list" id="nmag-maces-items"></div>
                    </div>
                </div>

                <div class="section" id="nmag-staves-section">
                    <div class="section-header" onclick="toggleSection('nmag-staves-section')">
                        <div>
                            <span class="section-title">NMAG: Staves (CTA, Memory)</span>
                            <span class="item-count" id="nmag-staves-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyNmagStavesPreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                            </select>
                        </div>
                        <div class="item-list" id="nmag-staves-items"></div>
                    </div>
                </div>

                <div class="section" id="nmag-bows-section">
                    <div class="section-header" onclick="toggleSection('nmag-bows-section')">
                        <div>
                            <span class="section-title">NMAG: Bows (Faith, Ice, Brand, Insight)</span>
                            <span class="item-count" id="nmag-bows-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyNmagBowsPreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                            </select>
                        </div>
                        <div class="item-list" id="nmag-bows-items"></div>
                    </div>
                </div>

                <!-- Armor -->
                <div class="section" id="nmag-light-armor-section">
                    <div class="section-header" onclick="toggleSection('nmag-light-armor-section')">
                        <div>
                            <span class="section-title">NMAG: Light Armor (Enigma, Fortitude, CoH)</span>
                            <span class="item-count" id="nmag-light-armor-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyNmagLightArmorPreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                                <option value="elite-only">Elite Only</option>
                            </select>
                        </div>
                        <div class="item-list" id="nmag-light-armor-items"></div>
                    </div>
                </div>

                <div class="section" id="nmag-heavy-armor-section">
                    <div class="section-header" onclick="toggleSection('nmag-heavy-armor-section')">
                        <div>
                            <span class="section-title">NMAG: Heavy Armor (Fortitude, CoH, Bramble)</span>
                            <span class="item-count" id="nmag-heavy-armor-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyNmagHeavyArmorPreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                            </select>
                        </div>
                        <div class="item-list" id="nmag-heavy-armor-items"></div>
                    </div>
                </div>

                <!-- Shields -->
                <div class="section" id="nmag-shields-generic-section">
                    <div class="section-header" onclick="toggleSection('nmag-shields-generic-section')">
                        <div>
                            <span class="section-title">NMAG: Shields - Generic (Spirit, Splendor, Rhyme)</span>
                            <span class="item-count" id="nmag-shields-generic-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyNmagShieldsGenericPreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                            </select>
                        </div>
                        <div class="item-list" id="nmag-shields-generic-items"></div>
                    </div>
                </div>

                <div class="section" id="nmag-shields-paladin-section">
                    <div class="section-header" onclick="toggleSection('nmag-shields-paladin-section')">
                        <div>
                            <span class="section-title">NMAG: Shields - Paladin (Spirit, Exile)</span>
                            <span class="item-count" id="nmag-shields-paladin-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyNmagShieldsPaladinPreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                            </select>
                        </div>
                        <div class="item-list" id="nmag-shields-paladin-items"></div>
                    </div>
                </div>

                <!-- Helms & Class-Specific -->
                <div class="section" id="nmag-helms-section">
                    <div class="section-header" onclick="toggleSection('nmag-helms-section')">
                        <div>
                            <span class="section-title">NMAG: Helms (Delirium, Dream)</span>
                            <span class="item-count" id="nmag-helms-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyNmagHelmsPreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                            </select>
                        </div>
                        <div class="item-list" id="nmag-helms-items"></div>
                    </div>
                </div>

                <div class="section" id="nmag-class-specific-section">
                    <div class="section-header" onclick="toggleSection('nmag-class-specific-section')">
                        <div>
                            <span class="section-title">NMAG: Class-Specific</span>
                            <span class="item-count" id="nmag-class-specific-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyNmagClassSpecificPreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                            </select>
                        </div>
                        <div class="item-list" id="nmag-class-specific-items"></div>
                    </div>
                </div>

                <!-- NMAG Other base items -->
                <div class="section-divider" style="margin: 30px 0; text-align: center; color: #666; font-weight: bold; font-size: 16px;">
                    === Other NMAG base items ===
                </div>

            </div>

            <!-- Output Panel -->
            <div class="output-panel">
                <div class="output-section">
                    <div class="output-header">
                        <span class="output-title">Filter Output</span>
                        <div class="output-actions">
                            <label for="import-file" class="btn">Import Filter</label>
                            <input type="file" id="import-file" accept=".filter" onchange="importFilter(event)">
                            <button class="btn btn-primary" onclick="exportFilter()">Export</button>
                            <button class="btn" onclick="copyToClipboard()">Copy</button>
                        </div>
                    </div>
                    <textarea class="output-textarea" id="filter-output" 
                        placeholder="Your filter will appear here... You can edit it manually."></textarea>
                    <div class="filter-info">
                        Lines: <span id="line-count">0</span> | 
                        Characters: <span id="char-count">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="data/item_metadata.js"></script>
    <script>
        // Available font colors for filter
        const FONT_COLORS = [
            'WHITE', 'RED', 'GREEN', 'BLUE', 'GOLD', 'GRAY', 'BLACK', 'TAN',
            'ORANGE', 'YELLOW', 'PURPLE', 'DGREEN', 'DARK_GREEN', 'BOLD',
            'CORAL', 'SAGE', 'TEAL', 'LGRAY', 'LIGHT_GRAY', 'NAVY', 'DBLUE',
            'DARK_BLUE', 'COBALT', 'DARK_PURPLE', 'DPURPLE', 'BROWN'
        ];

        // Item data
        const utilityItems = [
            { name: "Full Rejuvenation Potion", code: "rvl", category: "potion" },
            { name: "Rejuvenation Potion", code: "rvs", category: "potion" },
            { name: "Super Healing Potion", code: "hp5", category: "potion" },
            { name: "Greater Healing Potion", code: "hp4", category: "potion" },
            { name: "Healing Potion", code: "hp3", category: "potion" },
            { name: "Lesser Healing Potion", code: "hp2", category: "potion" },
            { name: "Minor Healing Potion", code: "hp1", category: "potion" },
            { name: "Super Mana Potion", code: "mp5", category: "potion" },
            { name: "Greater Mana Potion", code: "mp4", category: "potion" },
            { name: "Mana Potion", code: "mp3", category: "potion" },
            { name: "Lesser Mana Potion", code: "mp2", category: "potion" },
            { name: "Minor Mana Potion", code: "mp1", category: "potion" },
            { name: "Antidote Potion", code: "yps", category: "potion" },
            { name: "Thawing Potion", code: "wms", category: "potion" },
            { name: "Stamina Potion", code: "vps", category: "potion" },
            { name: "Tome of Town Portal", code: "tbk", category: "scroll" },
            { name: "Tome of Identify", code: "ibk", category: "scroll" },
            { name: "Scroll of Town Portal", code: "tsc", category: "scroll" },
            { name: "Scroll of Identify", code: "isc", category: "scroll" },
            { name: "Key", code: "key", category: "key" },
        ];

        const runeItems = [
            { name: "El Rune", code: "r01", level: 11, tier: 1 },
            { name: "Eld Rune", code: "r02", level: 11, tier: 1 },
            { name: "Tir Rune", code: "r03", level: 13, tier: 1 },
            { name: "Nef Rune", code: "r04", level: 13, tier: 1 },
            { name: "Eth Rune", code: "r05", level: 15, tier: 1 },
            { name: "Ith Rune", code: "r06", level: 15, tier: 1 },
            { name: "Tal Rune", code: "r07", level: 17, tier: 1 },
            { name: "Ral Rune", code: "r08", level: 19, tier: 1 },
            { name: "Ort Rune", code: "r09", level: 21, tier: 1 },
            { name: "Thul Rune", code: "r10", level: 23, tier: 2 },
            { name: "Amn Rune", code: "r11", level: 25, tier: 2 },
            { name: "Sol Rune", code: "r12", level: 27, tier: 2 },
            { name: "Shael Rune", code: "r13", level: 29, tier: 2 },
            { name: "Dol Rune", code: "r14", level: 31, tier: 2 },
            { name: "Hel Rune", code: "r15", level: 0, tier: 2 },
            { name: "Io Rune", code: "r16", level: 35, tier: 2 },
            { name: "Lum Rune", code: "r17", level: 37, tier: 2 },
            { name: "Ko Rune", code: "r18", level: 39, tier: 2 },
            { name: "Fal Rune", code: "r19", level: 41, tier: 2 },
            { name: "Lem Rune", code: "r20", level: 43, tier: 3 },
            { name: "Pul Rune", code: "r21", level: 45, tier: 3 },
            { name: "Um Rune", code: "r22", level: 47, tier: 3 },
            { name: "Mal Rune", code: "r23", level: 49, tier: 3 },
            { name: "Ist Rune", code: "r24", level: 51, tier: 3 },
            { name: "Gul Rune", code: "r25", level: 53, tier: 3 },
            { name: "Vex Rune", code: "r26", level: 55, tier: 3 },
            { name: "Ohm Rune", code: "r27", level: 57, tier: 3 },
            { name: "Lo Rune", code: "r28", level: 59, tier: 3 },
            { name: "Sur Rune", code: "r29", level: 61, tier: 3 },
            { name: "Ber Rune", code: "r30", level: 63, tier: 3 },
            { name: "Jah Rune", code: "r31", level: 65, tier: 3 },
            { name: "Cham Rune", code: "r32", level: 67, tier: 3 },
            { name: "Zod Rune", code: "r33", level: 69, tier: 3 },
        ];

        const gemItems = [
            { name: "Perfect Sapphire", code: "gpb", level: 5, type: "sapphire" },
            { name: "Perfect Emerald", code: "gpg", level: 5, type: "emerald" },
            { name: "Perfect Topaz", code: "gpy", level: 5, type: "topaz" },
            { name: "Perfect Ruby", code: "gpr", level: 5, type: "ruby" },
            { name: "Perfect Amethyst", code: "gpv", level: 5, type: "amethyst" },
            { name: "Perfect Diamond", code: "gpw", level: 5, type: "diamond" },
            { name: "Perfect Skull", code: "skz", level: 5, type: "skull" },
            { name: "Flawless Sapphire", code: "glb", level: 4, type: "sapphire" },
            { name: "Flawless Emerald", code: "glg", level: 4, type: "emerald" },
            { name: "Flawless Topaz", code: "gly", level: 4, type: "topaz" },
            { name: "Flawless Ruby", code: "glr", level: 4, type: "ruby" },
            { name: "Flawless Amethyst", code: "gzv", level: 4, type: "amethyst" },
            { name: "Flawless Diamond", code: "glw", level: 4, type: "diamond" },
            { name: "Flawless Skull", code: "skl", level: 4, type: "skull" },
            { name: "Sapphire", code: "gsb", level: 3, type: "sapphire" },
            { name: "Emerald", code: "gsg", level: 3, type: "emerald" },
            { name: "Topaz", code: "gsy", level: 3, type: "topaz" },
            { name: "Ruby", code: "gsr", level: 3, type: "ruby" },
            { name: "Amethyst", code: "gsv", level: 3, type: "amethyst" },
            { name: "Diamond", code: "gsw", level: 3, type: "diamond" },
            { name: "Skull", code: "sku", level: 3, type: "skull" },
            { name: "Flawed Sapphire", code: "gfb", level: 2, type: "sapphire" },
            { name: "Flawed Emerald", code: "gfg", level: 2, type: "emerald" },
            { name: "Flawed Topaz", code: "gfy", level: 2, type: "topaz" },
            { name: "Flawed Ruby", code: "gfr", level: 2, type: "ruby" },
            { name: "Flawed Amethyst", code: "gfv", level: 2, type: "amethyst" },
            { name: "Flawed Diamond", code: "gfw", level: 2, type: "diamond" },
            { name: "Flawed Skull", code: "skf", level: 2, type: "skull" },
            { name: "Chipped Sapphire", code: "gcb", level: 1, type: "sapphire" },
            { name: "Chipped Emerald", code: "gcg", level: 1, type: "emerald" },
            { name: "Chipped Topaz", code: "gcy", level: 1, type: "topaz" },
            { name: "Chipped Ruby", code: "gcr", level: 1, type: "ruby" },
            { name: "Chipped Amethyst", code: "gcv", level: 1, type: "amethyst" },
            { name: "Chipped Diamond", code: "gcw", level: 1, type: "diamond" },
            { name: "Chipped Skull", code: "skc", level: 1, type: "skull" },
        ];

        const miscItems = [
            { name: "Synthesized Items", code: "SYNTH", category: "synth" },
            { name: "Orb of Corruption", code: "cx5", category: "orb" },
            { name: "Orb of Alteration", code: "cx9", category: "orb" },
            { name: "Key of Terror", code: "pk1", category: "key" },
            { name: "Key of Hatred", code: "pk2", category: "key" },
            { name: "Key of Destruction", code: "pk3", category: "key" },
            { name: "Diablo's Horn", code: "dhn", category: "organ" },
            { name: "Baal's Eye", code: "bey", category: "organ" },
            { name: "Mephisto's Brain", code: "mbr", category: "organ" },
            { name: "Twisted Essence of Suffering", code: "tes", category: "essence" },
            { name: "Charged Essence of Hatred", code: "ceh", category: "essence" },
            { name: "Burning Essence of Terror", code: "bet", category: "essence" },
            { name: "Festering Essence of Destruction", code: "fed", category: "essence" },
            { name: "Token of Absolution", code: "toa", category: "essence" },
            { name: "All Maps", code: "MAP", category: "map" },
            { name: "All Quest Items", code: "QUEST", category: "quest" },
            { name: "All Crafted Items", code: "CRAFT", category: "crafted" },
        ];

        // Unique items data - organized by category
        const jewelryAndCharms = [
            { name: "Unique Rings", code: "rin" },
            { name: "Unique Amulets", code: "amu" },
            { name: "Unique Jewels", code: "jew" },
            { name: "Unique Small Charms", code: "cm1" },
            { name: "Unique Large Charms", code: "cm2" },
            { name: "Unique Grand Charms", code: "cm3" },
        ];

        const classSpecificUniques = [
            { name: "Titan's Revenge", code: "7ja" },
            { name: "Thunderstroke", code: "7ja" },
            { name: "Lycander's Flank", code: "7ja" },
            { name: "Stoneraven", code: "9ja" },
            { name: "Blood Raven's Charge", code: "9am" },
            { name: "Lycander's Aim", code: "8lw" },
            { name: "Bartuc's Cut-Throat", code: "7bt" },
            { name: "Jade Talon", code: "7wc" },
            { name: "Shadow Killer", code: "9ar" },
            { name: "Firelizard's Talons", code: "9wc" },
            { name: "The Oculus", code: "6cs" },
            { name: "Eschuta's Temper", code: "ob9" },
            { name: "Death's Fathom", code: "obd" },
            { name: "Homunculus", code: "ne9" },
            { name: "Darkforce Spawn", code: "ned" },
            { name: "Boneflame", code: "nee" },
            { name: "Herald of Zakarum", code: "paf" },
            { name: "Alma Negra", code: "paf" },
            { name: "Dragonscale", code: "pae" },
            { name: "Arreat's Face", code: "ba5" },
            { name: "Demonhorn's Edge", code: "ba4" },
            { name: "Wolfhowl", code: "baa" },
            { name: "Halaberd's Reign", code: "bac" },
            { name: "Jalal's Mane", code: "dr5" },
            { name: "Cerebus' Bite", code: "dr9" },
            { name: "Spirit Keeper", code: "dra" },
            { name: "Ravenlore", code: "drb" },
        ];

        const eliteUniqueWeapons = [
            { name: "Doombringer", code: "7cr" },
            { name: "The Grandfather", code: "7fb" },
            { name: "Lightsabre", code: "7gd" },
            { name: "Azurewrath", code: "7gd" },
            { name: "Frostwind", code: "7cs" },
            { name: "Flamebellow", code: "7b7" },
            { name: "Bloodmoon", code: "72h" },
            { name: "Djinn Slayer", code: "7dj" },
            { name: "Razor's Edge", code: "7ta" },
            { name: "Rune Master", code: "7et" },
            { name: "Cranebeak", code: "7ws" },
            { name: "Death Cleaver", code: "7wa" },
            { name: "Ethereal Edge", code: "7ha" },
            { name: "Hellslayer", code: "7ga" },
            { name: "Messerschmidt's Reaver", code: "7la" },
            { name: "Executioner's Justice", code: "7gi" },
            { name: "Nord's Tenderizer", code: "7tr" },
            { name: "Demon Limb", code: "7wh" },
            { name: "Baranar's Star", code: "7fl" },
            { name: "Horizon's Tornado", code: "7sc" },
            { name: "Stormlash", code: "7sc" },
            { name: "Stone Crusher", code: "7m7" },
            { name: "Schaefer's Hammer", code: "7m7" },
            { name: "Windhammer", code: "7o7" },
            { name: "Earth Shifter", code: "7gm" },
            { name: "The Cranium Basher", code: "7gm" },
            { name: "Wizardspike", code: "7dg" },
            { name: "Fleshripper", code: "7kr" },
            { name: "Ghostflame", code: "7di" },
            { name: "Ondal's Wisdom", code: "6ss" },
            { name: "Mang Song's Lesson", code: "6cs" },
            { name: "Boneshade", code: "7wn" },
            { name: "Death's Web", code: "7yw" },
            { name: "Heaven's Light", code: "7sc" },
            { name: "The Redeemer", code: "7sc" },
            { name: "Astreon's Iron Ward", code: "7qs" },
            { name: "Bonehew", code: "7o7" },
            { name: "Stormspire", code: "7gt" },
            { name: "The Reaper's Toll", code: "7s8" },
            { name: "Tomb Reaver", code: "7pa" },
            { name: "Arioc's Needle", code: "7h7" },
            { name: "Viperfork", code: "7p7" },
            { name: "Steel Pillar", code: "7vo" },
            { name: "Demon's Arch", code: "7bk" },
            { name: "Wraith Flight", code: "7gl" },
            { name: "Gargoyle's Bite", code: "7ts" },
            { name: "Gimmershred", code: "7ta" },
            { name: "Lacerator", code: "7tw" },
            { name: "Warshrike", code: "7bk" },
            { name: "Eaglehorn", code: "6l7" },
            { name: "Widowmaker", code: "6hb" },
            { name: "Windforce", code: "6lw" },
            { name: "Hellrack", code: "6hx" },
            { name: "Gut Siphon", code: "6rx" },
        ];

        const eliteUniqueArmor = [
            { name: "Andariel's Visage", code: "bac" },
            { name: "Crown of Ages", code: "urn" },
            { name: "Giant Skull", code: "baf" },
            { name: "Griffon's Eye", code: "ci3" },
            { name: "Nightwing's Veil", code: "ba9" },
            { name: "Vampire Gaze", code: "ba7" },
            { name: "Harlequin Crest", code: "ba8" },
            { name: "Steel Shade", code: "ba6" },
            { name: "Templar's Might", code: "uar" },
            { name: "Tyrael's Might", code: "uar" },
            { name: "Leviathan", code: "uui" },
            { name: "Steel Carapace", code: "uul" },
            { name: "Ormus' Robes", code: "uui" },
            { name: "Arkaine's Valor", code: "utp" },
            { name: "The Gladiator's Bane", code: "uea" },
            { name: "Corpsemourn", code: "ung" },
            { name: "Guardian Angel", code: "utp" },
            { name: "Skullder's Ire", code: "urs" },
            { name: "Stormshield", code: "uit" },
            { name: "Head Hunter's Glory", code: "paf" },
            { name: "Medusa's Gaze", code: "pae" },
            { name: "Spirit Ward", code: "paf" },
            { name: "Blackoak Shield", code: "paf" },
            { name: "Spike Thorn", code: "paf" },
            { name: "Steelrend", code: "uhg" },
            { name: "Hellmouth", code: "ulg" },
            { name: "Dracul's Grasp", code: "uvg" },
            { name: "Soul Drainer", code: "umg" },
            { name: "Shadowdancer", code: "umb" },
            { name: "Sandstorm Trek", code: "uhb" },
            { name: "Marrowwalk", code: "uvb" },
            { name: "War Traveler", code: "utb" },
            { name: "Gore Rider", code: "ulb" },
            { name: "Arachnid Mesh", code: "ulc" },
            { name: "Nosferatu's Coil", code: "uvc" },
            { name: "Verdungo's Hearty Cord", code: "umc" },
            { name: "String of Ears", code: "ulc" },
            { name: "Thundergod's Vigor", code: "uhc" },
        ];

        const exceptionalUniqueWeapons = [
            { name: "Bloodletter", code: "9ss" },
            { name: "Coldsteel Eye", code: "9sm" },
            { name: "Hexfire", code: "9sb" },
            { name: "Blade of Ali Baba", code: "9fc" },
            { name: "Ginther's Rift", code: "9cr" },
            { name: "Headstriker", code: "9bs" },
            { name: "Plague Bearer", code: "9ls" },
            { name: "The Atlantean", code: "9wd" },
            { name: "Crainte Vomir", code: "92h" },
            { name: "Bing Sz Wang", code: "9cm" },
            { name: "The Vile Husk", code: "9gs" },
            { name: "Cloudcrack", code: "9b9" },
            { name: "Todesfaelle Flamme", code: "9fb" },
            { name: "Swordguard", code: "9gd" },
            { name: "Coldkill", code: "9ha" },
            { name: "Butcher's Pupil", code: "9ax" },
            { name: "Islestrike", code: "92a" },
            { name: "Pompeii's Wrath", code: "9mp" },
            { name: "Guardian Naga", code: "9mt" },
            { name: "Warlord's Trust", code: "9ma" },
            { name: "Spellsteel", code: "9ba" },
            { name: "Stormrider", code: "9bt" },
            { name: "Boneslayer Blade", code: "9ga" },
            { name: "The Minotaur", code: "9gi" },
            { name: "Dark Clan Crusher", code: "9cl" },
            { name: "Fleshrender", code: "9sp" },
            { name: "Sureshrill Frost", code: "9ma" },
            { name: "Moonfall", code: "9mt" },
            { name: "Baezil's Vortex", code: "9fl" },
            { name: "Earthshaker", code: "9wh" },
            { name: "Bloodtree Stump", code: "9m9" },
            { name: "The Gavel of Pain", code: "9mt" },
            { name: "Spineripper", code: "9dg" },
            { name: "Heart Carver", code: "9di" },
            { name: "Blackbog's Sharp", code: "9kr" },
            { name: "Stormspike", code: "9bl" },
            { name: "Razorswitch", code: "9s8" },
            { name: "Ribcracker", code: "9st" },
            { name: "Chromatic Ire", code: "9s9" },
            { name: "Warpspear", code: "9sb" },
            { name: "Skull Collector", code: "9ss" },
            { name: "Suicide Branch", code: "9bw" },
            { name: "Carin Shard", code: "9gw" },
            { name: "Arm of King Leoric", code: "9tw" },
            { name: "Blackhand Key", code: "9qr" },
            { name: "Zakarum's Hand", code: "9sc" },
            { name: "The Fetid Sprinkler", code: "9qs" },
            { name: "Hand of Blessed Light", code: "9ws" },
            { name: "The Meat Scraper", code: "9pa" },
            { name: "Blackleach Blade", code: "9h9" },
            { name: "Athena's Wrath", code: "9s7" },
            { name: "Pierre Tombale Couant", code: "9vo" },
            { name: "Husoldal Evo", code: "9s8" },
            { name: "Grim's Burning Dead", code: "9p9" },
            { name: "The Impaler", code: "9sr" },
            { name: "Kelpie Snare", code: "9tr" },
            { name: "Soulfeast Tine", code: "9br" },
            { name: "Hone Sundan", code: "9st" },
            { name: "Spire of Honor", code: "9p9" },
            { name: "Deathbit", code: "9b8" },
            { name: "The Scalper", code: "9ta" },
            { name: "Endlesshail", code: "8sb" },
            { name: "Witchwild String", code: "8lb" },
            { name: "Cliffkiller", code: "8cb" },
            { name: "Magewrath", code: "8s8" },
            { name: "Goldstrike Arch", code: "8l8" },
            { name: "Langer Briser", code: "8lx" },
            { name: "Pus Spitter", code: "8mx" },
            { name: "Buriza-Do Kyanon", code: "8hx" },
            { name: "Demon Machine", code: "8rx" },
        ];

        const exceptionalUniqueArmor = [
            { name: "Blackhorn's Face", code: "xh9" },
            { name: "Crown of Thieves", code: "xhm" },
            { name: "Kira's Guardian", code: "ci2" },
            { name: "Stealskull", code: "xrn" },
            { name: "Veil of Steel", code: "xsk" },
            { name: "Peasant Crown", code: "xow" },
            { name: "Rockstopper", code: "xh9" },
            { name: "Valkyrie Wing", code: "xlm" },
            { name: "Duriel's Shell", code: "xrs" },
            { name: "Shaftstop", code: "xpl" },
            { name: "Toothrow", code: "xui" },
            { name: "Atma's Wail", code: "xul" },
            { name: "Black Hades", code: "xmb" },
            { name: "Iron Pelt", code: "xlt" },
            { name: "Crow Caw", code: "xtu" },
            { name: "Spirit Forge", code: "xng" },
            { name: "Skin of the Vipermagi", code: "xea" },
            { name: "Skin of the Flayed One", code: "xla" },
            { name: "Rattlecage", code: "xhb" },
            { name: "Goldskin", code: "xtp" },
            { name: "Silks of the Victor", code: "xth" },
            { name: "The Spirit Shroud", code: "xuc" },
            { name: "Radament's Sphere", code: "pa9" },
            { name: "Lidless Wall", code: "paf" },
            { name: "Stormchaser", code: "paf" },
            { name: "Gerke's Sanctuary", code: "paf" },
            { name: "Tiamat's Rebuke", code: "paf" },
            { name: "Lance Guard", code: "paf" },
            { name: "Venom Grip", code: "xlg" },
            { name: "Gravepalm", code: "xmg" },
            { name: "Ghoulhide", code: "xhg" },
            { name: "Lava Gout", code: "xtg" },
            { name: "Hellmouth", code: "ulg" },
            { name: "Infernostride", code: "xlb" },
            { name: "Waterwalk", code: "xmb" },
            { name: "Silkweave", code: "xhb" },
            { name: "War Traveler", code: "xtb" },
            { name: "Gloomstrap", code: "zlb" },
            { name: "Snowclash", code: "ztb" },
            { name: "Goldwrap", code: "zmb" },
            { name: "Bladebuckle", code: "zhb" },
            { name: "String of Ears", code: "zlb" },
        ];

        const normalUniqueWeapons = [
            { name: "Rixot's Keen", code: "ssd" },
            { name: "Blood Crescent", code: "scm" },
            { name: "Skewer of Krintiz", code: "sbr" },
            { name: "Gleamscythe", code: "flc" },
            { name: "Griswold's Edge", code: "bsd" },
            { name: "Hellplague", code: "lsd" },
            { name: "Culwen's Point", code: "wsd" },
            { name: "Shadowfang", code: "2hs" },
            { name: "Soulflay", code: "clm" },
            { name: "Kinemil's Awl", code: "gis" },
            { name: "Blacktongue", code: "bsw" },
            { name: "Ripsaw", code: "flb" },
            { name: "The Patriarch", code: "gsd" },
            { name: "The Gnasher", code: "hax" },
            { name: "Deathspade", code: "axe" },
            { name: "Bladebone", code: "2ax" },
            { name: "Skull Splitter", code: "mpi" },
            { name: "Rakescar", code: "wax" },
            { name: "Axe of Fechmar", code: "lax" },
            { name: "Goreshovel", code: "bax" },
            { name: "The Chieftain", code: "btx" },
            { name: "Brainhew", code: "gax" },
            { name: "Humongous", code: "gix" },
            { name: "Felloak", code: "clb" },
            { name: "Stoutnail", code: "spc" },
            { name: "Crushflange", code: "mac" },
            { name: "Bloodrise", code: "mst" },
            { name: "The General's Tan Do Li Ga", code: "fla" },
            { name: "Ironstone", code: "whm" },
            { name: "Bonesnap", code: "mau" },
            { name: "Steeldriver", code: "gma" },
            { name: "Gull", code: "dgr" },
            { name: "The Diggler", code: "dir" },
            { name: "The Jade Tan Do", code: "kri" },
            { name: "Spectral Shard", code: "bld" },
            { name: "Bane Ash", code: "sst" },
            { name: "Serpent Lord", code: "lst" },
            { name: "Spire of Lazarus", code: "cst" },
            { name: "The Salamander", code: "bst" },
            { name: "The Iron Jang Bong", code: "wst" },
            { name: "Torch of Iro", code: "wnd" },
            { name: "Maelstrom", code: "ywn" },
            { name: "Gravenspine", code: "bwn" },
            { name: "Ume's Lament", code: "gwn" },
            { name: "Knell Striker", code: "scp" },
            { name: "Rusthandle", code: "gsc" },
            { name: "Stormeye", code: "wsp" },
            { name: "Dimoak's Hew", code: "bar" },
            { name: "Steelgoad", code: "vou" },
            { name: "Soul Harvest", code: "scy" },
            { name: "The Battlebranch", code: "pax" },
            { name: "Woestave", code: "hal" },
            { name: "The Grim Reaper", code: "wsc" },
            { name: "The Dragon Chang", code: "spr" },
            { name: "Razortine", code: "tri" },
            { name: "Bloodthief", code: "brn" },
            { name: "Lance of Yaggai", code: "spt" },
            { name: "The Tannr Gorerod", code: "pik" },
            { name: "Pluckeye", code: "sbw" },
            { name: "Witherstring", code: "hbw" },
            { name: "Raven Claw", code: "lbw" },
            { name: "Rogue's Bow", code: "cbw" },
            { name: "Stormstrike", code: "sbb" },
            { name: "Wizendraw", code: "lbb" },
            { name: "Hellclap", code: "swb" },
            { name: "Blastbark", code: "lwb" },
            { name: "Skystrike", code: "8sb" },
            { name: "Riphook", code: "lxb" },
            { name: "Kuko Shakaku", code: "mxb" },
            { name: "Leadcrow", code: "lxb" },
            { name: "Ichorsting", code: "mxb" },
            { name: "Hellcast", code: "hxb" },
            { name: "Doomslinger", code: "rxb" },
        ];

        const normalUniqueArmor = [
            { name: "Biggin's Bonnet", code: "cap" },
            { name: "Tarnhelm", code: "skp" },
            { name: "Coif of Glory", code: "hlm" },
            { name: "Duskdeep", code: "fhl" },
            { name: "Howltusk", code: "ghm" },
            { name: "Undead Crown", code: "crn" },
            { name: "Wormskull", code: "msk" },
            { name: "Greyform", code: "qui" },
            { name: "Blinkbat's Form", code: "lea" },
            { name: "The Centurion", code: "hla" },
            { name: "Twitchthroe", code: "stu" },
            { name: "Darkglow", code: "rng" },
            { name: "Hawkmail", code: "scl" },
            { name: "Sparking Mail", code: "chn" },
            { name: "Venom Ward", code: "brs" },
            { name: "Iceblink", code: "spl" },
            { name: "Boneflesh", code: "plt" },
            { name: "Rockfleece", code: "fld" },
            { name: "Rattlecage", code: "gth" },
            { name: "Goldskin", code: "ful" },
            { name: "Victors Silk", code: "aar" },
            { name: "Heavenly Garb", code: "ltp" },
            { name: "Pelta Lunata", code: "buc" },
            { name: "Umbral Disk", code: "sml" },
            { name: "Stormguild", code: "lrg" },
            { name: "Steelclash", code: "kit" },
            { name: "Swordback Hold", code: "spk" },
            { name: "Bverrit Keep", code: "tow" },
            { name: "Wall of the Eyeless", code: "gts" },
            { name: "The Ward", code: "lrg" },
            { name: "Visceratuant", code: "buc" },
            { name: "Moser's Blessed Circle", code: "xml" },
            { name: "The Hand of Broc", code: "lgl" },
            { name: "Bloodfist", code: "hgl" },
            { name: "Chance Guards", code: "mgl" },
            { name: "Magefist", code: "tgl" },
            { name: "Frostburn", code: "hgl" },
            { name: "Hotspur", code: "lbt" },
            { name: "Gorefoot", code: "hbt" },
            { name: "Treads of Cthon", code: "mbt" },
            { name: "Goblin Toe", code: "tbt" },
            { name: "Tearhaunch", code: "hbt" },
            { name: "Lenymo", code: "lbl" },
            { name: "Snakecord", code: "vbl" },
            { name: "Nightsmoke", code: "hbl" },
            { name: "Goldwrap", code: "hbl" },
            { name: "Bladebuckle", code: "mbl" },
        ];

        // Set items data - organized by level/tier
        const highLevelSets = [
            // Immortal King's (Barbarian)
            { name: "Immortal King's Will", code: "ba5", set: "IK" },
            { name: "Immortal King's Soul Cage", code: "uar", set: "IK" },
            { name: "Immortal King's Detail", code: "uhc", set: "IK" },
            { name: "Immortal King's Forge", code: "ulg", set: "IK" },
            { name: "Immortal King's Pillar", code: "uhb", set: "IK" },
            { name: "Immortal King's Stone Crusher", code: "2ha", set: "IK" },
            // Tal Rasha's (Sorceress)
            { name: "Tal Rasha's Horadric Crest", code: "xh9", set: "TR" },
            { name: "Tal Rasha's Guardianship", code: "utp", set: "TR" },
            { name: "Tal Rasha's Fine-Spun Cloth", code: "ulc", set: "TR" },
            { name: "Tal Rasha's Lidless Eye", code: "ob9", set: "TR" },
            { name: "Tal Rasha's Adjudication", code: "amu", set: "TR" },
            // Griswold's (Paladin)
            { name: "Griswold's Valor", code: "urn", set: "Gris" },
            { name: "Griswold's Heart", code: "uar", set: "Gris" },
            { name: "Griswold's Redemption", code: "pa9", set: "Gris" },
            { name: "Griswold's Honor", code: "pa9", set: "Gris" },
            // Trang-Oul's (Necromancer)
            { name: "Trang-Oul's Guise", code: "baf", set: "TO" },
            { name: "Trang-Oul's Scales", code: "uui", set: "TO" },
            { name: "Trang-Oul's Wing", code: "paf", set: "TO" },
            { name: "Trang-Oul's Claws", code: "uvg", set: "TO" },
            { name: "Trang-Oul's Girth", code: "uvc", set: "TO" },
            // M'avina's (Amazon)
            { name: "M'avina's True Sight", code: "ci3", set: "Mav" },
            { name: "M'avina's Embrace", code: "uea", set: "Mav" },
            { name: "M'avina's Icy Clutch", code: "ulg", set: "Mav" },
            { name: "M'avina's Tenet", code: "umc", set: "Mav" },
            { name: "M'avina's Caster", code: "6lw", set: "Mav" },
            // Natalya's (Assassin)
            { name: "Natalya's Totem", code: "ba7", set: "Nat" },
            { name: "Natalya's Shadow", code: "utp", set: "Nat" },
            { name: "Natalya's Mark", code: "7wc", set: "Nat" },
            { name: "Natalya's Soul", code: "uhb", set: "Nat" },
            // Aldur's (Druid)
            { name: "Aldur's Stony Gaze", code: "dr5", set: "Ald" },
            { name: "Aldur's Deception", code: "utp", set: "Ald" },
            { name: "Aldur's Rhythm", code: "7sc", set: "Ald" },
            { name: "Aldur's Advance", code: "utb", set: "Ald" },
            // The Disciple
            { name: "Laying of Hands", code: "xlg", set: "Disciple" },
            { name: "Rite of Passage", code: "utb", set: "Disciple" },
            { name: "Dark Adherent", code: "utp", set: "Disciple" },
            { name: "Credendum", code: "umc", set: "Disciple" },
            { name: "Telling of Beads", code: "amu", set: "Disciple" },
            // Sazabi's
            { name: "Sazabi's Mental Sheath", code: "xlm", set: "Sazabi" },
            { name: "Sazabi's Ghost Liberator", code: "7cr", set: "Sazabi" },
            { name: "Sazabi's Cobalt Redeemer", code: "paf", set: "Sazabi" },
            // Bul-Kathos'
            { name: "Bul-Kathos' Sacred Charge", code: "7fb", set: "BK" },
            { name: "Bul-Kathos' Tribal Guardian", code: "7fb", set: "BK" },
        ];

        const midLevelSets = [
            // Hwanin's Majesty
            { name: "Hwanin's Splendor", code: "xhl", set: "Hwanin" },
            { name: "Hwanin's Refuge", code: "xtp", set: "Hwanin" },
            { name: "Hwanin's Blessing", code: "zhb", set: "Hwanin" },
            { name: "Hwanin's Justice", code: "9bl", set: "Hwanin" },
            // Naj's Ancient Vestige
            { name: "Naj's Circlet", code: "ci1", set: "Naj" },
            { name: "Naj's Light Plate", code: "xar", set: "Naj" },
            { name: "Naj's Puzzler", code: "6ss", set: "Naj" },
            // Orphan's Call
            { name: "Guillaume's Face", code: "xlm", set: "Orphan" },
            { name: "Whitstan's Guard", code: "paf", set: "Orphan" },
            { name: "Magnus' Skin", code: "xng", set: "Orphan" },
            { name: "Wilhelm's Pride", code: "zhb", set: "Orphan" },
            // Sander's Folly
            { name: "Sander's Paragon", code: "cap", set: "Sander" },
            { name: "Sander's Riprap", code: "hbt", set: "Sander" },
            { name: "Sander's Taboo", code: "vgl", set: "Sander" },
            { name: "Sander's Superstition", code: "9wn", set: "Sander" },
            // Cow King's Leathers
            { name: "Cow King's Horns", code: "xap", set: "Cow" },
            { name: "Cow King's Hide", code: "xtu", set: "Cow" },
            { name: "Cow King's Hooves", code: "xhb", set: "Cow" },
            // Heaven's Brethren
            { name: "Dangoon's Teaching", code: "7ma", set: "Brethren" },
            { name: "Taebaek's Glory", code: "xhb", set: "Brethren" },
            { name: "Haemosu's Adamant", code: "xar", set: "Brethren" },
            { name: "Ondal's Almighty", code: "9sp", set: "Brethren" },
        ];

        const lowLevelSets = [
            // Angelic Raiment
            { name: "Angelic Halo", code: "rin", set: "Angelic" },
            { name: "Angelic Wings", code: "amu", set: "Angelic" },
            { name: "Angelic Sickle", code: "sbr", set: "Angelic" },
            { name: "Angelic Mantle", code: "rng", set: "Angelic" },
            // Arcanna's Tricks
            { name: "Arcanna's Head", code: "skp", set: "Arcanna" },
            { name: "Arcanna's Flesh", code: "ltp", set: "Arcanna" },
            { name: "Arcanna's Deathwand", code: "wnd", set: "Arcanna" },
            { name: "Arcanna's Sign", code: "amu", set: "Arcanna" },
            // Arctic Gear
            { name: "Arctic Horn", code: "ci0", set: "Arctic" },
            { name: "Arctic Furs", code: "qui", set: "Arctic" },
            { name: "Arctic Binding", code: "lbl", set: "Arctic" },
            { name: "Arctic Mitts", code: "lgl", set: "Arctic" },
            // Berserker's Arsenal
            { name: "Berserker's Headgear", code: "hlm", set: "Berserker" },
            { name: "Berserker's Hauberk", code: "spl", set: "Berserker" },
            { name: "Berserker's Hatchet", code: "2ax", set: "Berserker" },
            // Cathan's Traps
            { name: "Cathan's Visage", code: "msk", set: "Cathan" },
            { name: "Cathan's Mesh", code: "chn", set: "Cathan" },
            { name: "Cathan's Rule", code: "sst", set: "Cathan" },
            { name: "Cathan's Sigil", code: "amu", set: "Cathan" },
            { name: "Cathan's Seal", code: "rin", set: "Cathan" },
            // Civerb's Vestments
            { name: "Civerb's Cudgel", code: "gsc", set: "Civerb" },
            { name: "Civerb's Icon", code: "amu", set: "Civerb" },
            { name: "Civerb's Ward", code: "lrg", set: "Civerb" },
            // Cleglaw's Brace
            { name: "Cleglaw's Tooth", code: "lsd", set: "Cleglaw" },
            { name: "Cleglaw's Claw", code: "sml", set: "Cleglaw" },
            { name: "Cleglaw's Pincers", code: "mgl", set: "Cleglaw" },
            // Death's Disguise
            { name: "Death's Touch", code: "lea", set: "Death" },
            { name: "Death's Guard", code: "tgl", set: "Death" },
            { name: "Death's Hand", code: "hgl", set: "Death" },
            // Hsarus' Defense
            { name: "Hsarus' Iron Heel", code: "chn", set: "Hsarus" },
            { name: "Hsarus' Iron Fist", code: "vbt", set: "Hsarus" },
            { name: "Hsarus' Iron Stay", code: "vbl", set: "Hsarus" },
            // Infernal Tools
            { name: "Infernal Cranium", code: "cap", set: "Infernal" },
            { name: "Infernal Torch", code: "9wn", set: "Infernal" },
            { name: "Infernal Sign", code: "7tw", set: "Infernal" },
            // Iratha's Finery
            { name: "Iratha's Coil", code: "crn", set: "Iratha" },
            { name: "Iratha's Cuff", code: "lgl", set: "Iratha" },
            { name: "Iratha's Cord", code: "lbl", set: "Iratha" },
            { name: "Iratha's Collar", code: "amu", set: "Iratha" },
            // Isenhart's Armory
            { name: "Isenhart's Horns", code: "fhl", set: "Isenhart" },
            { name: "Isenhart's Case", code: "brs", set: "Isenhart" },
            { name: "Isenhart's Parry", code: "spk", set: "Isenhart" },
            { name: "Isenhart's Lightbrand", code: "bsw", set: "Isenhart" },
            // Milabrega's Regalia
            { name: "Milabrega's Diadem", code: "crn", set: "Milabrega" },
            { name: "Milabrega's Robe", code: "aar", set: "Milabrega" },
            { name: "Milabrega's Orb", code: "pa8", set: "Milabrega" },
            { name: "Milabrega's Rod", code: "wsp", set: "Milabrega" },
            // Sigon's Complete Steel
            { name: "Sigon's Visor", code: "ghm", set: "Sigon" },
            { name: "Sigon's Shelter", code: "gth", set: "Sigon" },
            { name: "Sigon's Guard", code: "tow", set: "Sigon" },
            { name: "Sigon's Gage", code: "hgl", set: "Sigon" },
            { name: "Sigon's Sabot", code: "hbt", set: "Sigon" },
            { name: "Sigon's Wrap", code: "hbl", set: "Sigon" },
            // Tancred's Battlegear
            { name: "Tancred's Skull", code: "bwn", set: "Tancred" },
            { name: "Tancred's Spine", code: "ful", set: "Tancred" },
            { name: "Tancred's Hobnails", code: "tbt", set: "Tancred" },
            { name: "Tancred's Weird", code: "amu", set: "Tancred" },
            { name: "Tancred's Crowbill", code: "mpi", set: "Tancred" },
            // Vidala's Rig
            { name: "Vidala's Barb", code: "amu", set: "Vidala" },
            { name: "Vidala's Fetlock", code: "lbt", set: "Vidala" },
            { name: "Vidala's Ambush", code: "lea", set: "Vidala" },
            { name: "Vidala's Snare", code: "lbw", set: "Vidala" },
        ];

        // Magic items data
        const magicJewelry = [
            { name: "Magic Amulets (ILVL 82+)", code: "amu", minIlvl: 82, desc: "High-level crafting/gambling" },
            { name: "Magic Amulets (ILVL 60-81)", code: "amu", minIlvl: 60, maxIlvl: 81, desc: "Mid-level amulets" },
            { name: "Magic Amulets (ILVL <60)", code: "amu", maxIlvl: 59, desc: "Low-level amulets" },
            { name: "Magic Rings (ILVL 71+)", code: "rin", minIlvl: 71, desc: "High-level crafting" },
            { name: "Magic Rings (ILVL 42-70)", code: "rin", minIlvl: 42, maxIlvl: 70, desc: "Mid-level rings" },
            { name: "Magic Rings (ILVL <42)", code: "rin", maxIlvl: 41, desc: "Low-level rings" },
            { name: "Magic Jewels", code: "jew", desc: "All magic jewels" },
        ];

        const magicCharms = [
            { name: "Grand Charms (ILVL 78+)", code: "cm3", minIlvl: 78, desc: "High-level skillers" },
            { name: "Grand Charms (ILVL 50-77)", code: "cm3", minIlvl: 50, maxIlvl: 77, desc: "Skiller range" },
            { name: "Grand Charms (ILVL <50)", code: "cm3", maxIlvl: 49, desc: "Low-level grands" },
            { name: "Large Charms (ILVL 80+)", code: "cm2", minIlvl: 80, desc: "High-level" },
            { name: "Large Charms (ILVL <80)", code: "cm2", maxIlvl: 79, desc: "Lower-level" },
            { name: "Small Charms (ILVL 90+)", code: "cm1", minIlvl: 90, desc: "Perfect stat range" },
            { name: "Small Charms (ILVL 48-89)", code: "cm1", minIlvl: 48, maxIlvl: 89, desc: "Good stat range" },
            { name: "Small Charms (ILVL <48)", code: "cm1", maxIlvl: 47, desc: "Low-level" },
        ];

        const magicCraftingBases = [
            { name: "Vampirebone Gloves (ILVL 85+)", code: "vgl", minIlvl: 85, desc: "Crafting Base" },
            { name: "Sharkskin Gloves (ILVL 85+)", code: "xvg", minIlvl: 85, desc: "Crafting Base" },
            { name: "Bramble Mitts (ILVL 85+)", code: "uvg", minIlvl: 85, desc: "Crafting Base" },
            { name: "Chain Gloves (ILVL 85+)", code: "mgl", minIlvl: 85, desc: "Crafting Base" },
            { name: "Heavy Bracers (ILVL 85+)", code: "xmg", minIlvl: 85, desc: "Crafting Base" },
            { name: "Vambraces (ILVL 85+)", code: "umg", minIlvl: 85, desc: "Crafting Base" },
            { name: "Demonhide Gloves (ILVL 85+)", code: "xlg", minIlvl: 85, desc: "Crafting Base" },
            { name: "Wyrmhide Boots (ILVL 85+)", code: "ulb", minIlvl: 85, desc: "Crafting Base" },
            { name: "Demonhide Boots (ILVL 85+)", code: "xlb", minIlvl: 85, desc: "Crafting Base" },
            { name: "Battle Boots (ILVL 85+)", code: "tbt", minIlvl: 85, desc: "Crafting Base" },
            { name: "Scarabshell Boots (ILVL 85+)", code: "xtb", minIlvl: 85, desc: "Crafting Base" },
            { name: "Boneweave Boots (ILVL 85+)", code: "utb", minIlvl: 85, desc: "Crafting Base" },
            { name: "Vampirefang Belt (ILVL 85+)", code: "uvc", minIlvl: 85, desc: "Crafting Base" },
            { name: "Mithril Coil (ILVL 85+)", code: "zmb", minIlvl: 85, desc: "Crafting Base" },
            { name: "Mesh Belt (ILVL 85+)", code: "umc", minIlvl: 85, desc: "Crafting Base" },
            { name: "Berserker Axe (ILVL 85+)", code: "72a", minIlvl: 85, desc: "Crafting Base" },
            { name: "Phase Blade (ILVL 85+)", code: "7sb", minIlvl: 85, desc: "Crafting Base" },
        ];

        // Rare items data
        const rareJewelry = [
            { name: "Rare Amulets", code: "amu", desc: "All rare amulets" },
            { name: "Rare Rings", code: "rin", desc: "All rare rings" },
            { name: "Rare Jewels", code: "jew", desc: "All rare jewels" },
        ];

        const rareClassItems = [
            { name: "Circlets (All)", code: "EQ7", desc: "All circlets/coronets/tiaras" },
            { name: "Claws (ILVL 50+)", code: "CL5", minIlvl: 50, desc: "Assassin claws" },
            { name: "Orbs (ILVL 50+)", code: "WP11", minIlvl: 50, desc: "Sorceress orbs" },
            { name: "Javelins (ILVL 56+)", code: "7ja", minIlvl: 56, desc: "Elite javelins" },
            { name: "Matriarchal Javelin (ILVL 56+)", code: "jav", minIlvl: 56, desc: "Elite javelin" },
            { name: "Bows (ILVL 56+)", code: "7wa", minIlvl: 56, desc: "Elite bows" },
            { name: "Matriarchal Bow (ILVL 56+)", code: "wax", minIlvl: 56, desc: "Elite bow" },
            { name: "Paladin Shields (Elite)", code: "CL3", tier: "elite", desc: "Elite paladin shields" },
        ];

        const rareEliteBases = [
            { name: "Elite Gloves (ILVL 50+)", code: "EQ4", tier: "elite", minIlvl: 50, desc: "Elite gloves" },
            { name: "Elite Boots (ILVL 50+)", code: "EQ5", tier: "elite", minIlvl: 50, desc: "Elite boots" },
            { name: "Elite Belts (ILVL 50+)", code: "EQ6", tier: "elite", minIlvl: 50, desc: "Elite belts" },
            { name: "Elite Helms (ILVL 50+)", code: "EQ1", tier: "elite", minIlvl: 50, desc: "Elite helms" },
            { name: "Elite Armors (ILVL 50+)", code: "EQ2", tier: "elite", minIlvl: 50, desc: "Elite body armor" },
            { name: "Elite Shields (ILVL 50+)", code: "EQ3", tier: "elite", minIlvl: 50, desc: "Elite shields" },
        ];

        // NMAG Runeword Bases
        const nmagPolearms = [
            { name: "Thresher", code: "7s8", quality: "elite", rw: "Insight, Infinity, Obedience" },
            { name: "Giant Thresher", code: "7wc", quality: "elite", rw: "Insight, Infinity" },
            { name: "Cryptic Axe", code: "7pa", quality: "elite", rw: "Insight, Infinity, Obedience" },
            { name: "Mancatcher", code: "7vo", quality: "elite", rw: "Insight, Infinity" },
            { name: "Colossus Voulge", code: "7h7", quality: "elite", rw: "Insight, Infinity" },
            { name: "Great Poleaxe", code: "7o7", quality: "elite", rw: "Insight, Infinity" },
        ];

        const nmagSwords = [
            { name: "Phase Blade", code: "7cr", quality: "elite", rw: "Spirit, Grief, Last Wish" },
            { name: "Colossus Blade", code: "7gd", quality: "elite", rw: "Grief, Breath of the Dying" },
            { name: "Colossus Sword", code: "7fb", quality: "elite", rw: "Grief" },
            { name: "Crystal Sword", code: "crs", quality: "normal", rw: "Spirit" },
            { name: "Broad Sword", code: "bsd", quality: "normal", rw: "Spirit" },
            { name: "Long Sword", code: "lsd", quality: "normal", rw: "Spirit" },
        ];

        const nmagAxes = [
            { name: "Berserker Axe", code: "7wa", quality: "elite", rw: "Grief, Beast, Death" },
            { name: "Ettin Axe", code: "72a", quality: "elite", rw: "Honor, Crescent Moon" },
        ];

        const nmagMaces = [
            { name: "Thunder Maul", code: "7gm", quality: "elite", rw: "BOTD" },
            { name: "Scourge", code: "7m7", quality: "elite", rw: "Grief, Crescent Moon" },
            { name: "Flail", code: "fla", quality: "normal", rw: "CTA, Heart of the Oak" },
        ];

        const nmagStaves = [
            { name: "Archon Staff", code: "6ws", quality: "elite", rw: "CTA, Memory" },
            { name: "War Staff", code: "wst", quality: "exceptional", rw: "CTA, Memory" },
        ];

        const nmagBows = [
            { name: "Matriarchal Bow", code: "amc", quality: "elite", rw: "Faith, Ice, Brand" },
            { name: "Grand Matron Bow", code: "amb", quality: "elite", rw: "Faith, Ice, Brand" },
            { name: "Hydra Bow", code: "6hb", quality: "elite", rw: "Faith, Ice" },
            { name: "Crusader Bow", code: "6cb", quality: "elite", rw: "Faith, Ice" },
        ];

        const nmagLightArmor = [
            { name: "Archon Plate", code: "utp", quality: "elite", rw: "Enigma, Fortitude, CoH" },
            { name: "Dusk Shroud", code: "uui", quality: "elite", rw: "Enigma, Fortitude" },
            { name: "Wyrmhide", code: "utu", quality: "elite", rw: "Enigma, Fortitude" },
            { name: "Mage Plate", code: "xtp", quality: "exceptional", rw: "Stealth, Smoke" },
            { name: "Light Plate", code: "ltp", quality: "normal", rw: "Stealth, Enigma" },
        ];

        const nmagHeavyArmor = [
            { name: "Sacred Armor", code: "uar", quality: "elite", rw: "Fortitude, CoH, Bramble" },
            { name: "Lacquered Plate", code: "ula", quality: "elite", rw: "Fortitude" },
            { name: "Great Hauberk", code: "urs", quality: "elite", rw: "Fortitude" },
        ];

        const nmagShieldsGeneric = [
            { name: "Monarch", code: "uit", quality: "elite", rw: "Spirit, Dream" },
            { name: "Bone Shield", code: "bsh", quality: "elite", rw: "Splendor, Rhyme" },
            { name: "Grim Shield", code: "xsh", quality: "elite", rw: "Splendor, Rhyme" },
        ];

        const nmagShieldsPaladin = [
            { name: "Sacred Targe", code: "pa9", quality: "elite", rw: "Spirit, Exile" },
            { name: "Sacred Rondache", code: "paa", quality: "elite", rw: "Spirit, Exile" },
            { name: "Kurast Shield", code: "pab", quality: "elite", rw: "Spirit, Exile" },
            { name: "Zakarum Shield", code: "paf", quality: "elite", rw: "Spirit, Exile" },
            { name: "Vortex Shield", code: "pac", quality: "elite", rw: "Spirit, Exile" },
        ];

        const nmagHelms = [
            { name: "Demonhead", code: "uh9", quality: "elite", rw: "Delirium, Dream" },
            { name: "Bone Visage", code: "usk", quality: "elite", rw: "Delirium, Dream" },
        ];

        const nmagClassSpecific = [
            { name: "Druid Pelts", code: "CL1", quality: "elite", rw: "Delirium, Metamorphosis" },
            { name: "Necro Shrunken Heads", code: "CL2", quality: "elite", rw: "Splendor, Rhyme" },
            { name: "Assassin Claws", code: "CL5", quality: "elite", rw: "Chaos, Fury, Plague" },
            { name: "Sorceress Orbs", code: "WP11", quality: "elite", rw: "Plague" },
        ];

        // Global settings state
        const globalSettings = {
            enableFilterLevels: false,
            levelNames: [
                '', '', '', '', '',
                '', '', '', '', ''
            ],
            hideJunk: true,
            showAll: true
        };

        // State management
        const filterState = {
            utility: {},
            runes: {},
            gems: {},
            misc: {},
            jewelryCharms: {},
            classUniques: {},
            eliteWeapons: {},
            eliteArmor: {},
            excWeapons: {},
            excArmor: {},
            normWeapons: {},
            normArmor: {},
            highSets: {},
            midSets: {},
            lowSets: {},
            magicJewelry: {},
            magicCharms: {},
            magicCrafting: {},
            rareJewelry: {},
            rareClassItems: {},
            rareEliteBases: {},
            nmagPolearms: {},
            nmagSwords: {},
            nmagAxes: {},
            nmagMaces: {},
            nmagStaves: {},
            nmagBows: {},
            nmagLightArmor: {},
            nmagHeavyArmor: {},
            nmagShieldsGeneric: {},
            nmagShieldsPaladin: {},
            nmagHelms: {},
            nmagClassSpecific: {}
        };

        // Initialize utility items state
        utilityItems.forEach(item => {
            filterState.utility[item.code] = {
                show: true,
                useCustomColors: false,
                chatNotification: false,
                biggerClickbox: false,
                fontColor: 'WHITE',
                borderColor: null,
                backgroundColor: null,
                filterLevels: [true, true, true, true, true, true, true, true, true, true]
            };
        });

        // Initialize rune items state
        runeItems.forEach(item => {
            filterState.runes[item.code] = {
                show: true,
                useCustomColors: false,
                chatNotification: false,
                biggerClickbox: false,
                fontColor: 'ORANGE',
                borderColor: null,
                backgroundColor: null,
                filterLevels: [true, true, true, true, true, true, true, true, true, true]
            };
        });

        // Initialize gems state
        gemItems.forEach(item => {
            filterState.gems[item.code] = {
                show: true,
                useCustomColors: false,
                chatNotification: false,
                biggerClickbox: false,
                fontColor: 'WHITE',
                borderColor: null,
                backgroundColor: null,
                filterLevels: [true, true, true, true, true, true, true, true, true, true]
            };
        });

        // Initialize misc items state
        miscItems.forEach(item => {
            filterState.misc[item.code] = {
                show: true,
                useCustomColors: false,
                chatNotification: false,
                biggerClickbox: false,
                fontColor: 'PURPLE',
                borderColor: null,
                backgroundColor: null,
                filterLevels: [true, true, true, true, true, true, true, true, true, true]
            };
        });

        // Initialize unique items state
        jewelryAndCharms.forEach(item => {
            const key = item.name.replace(/[^a-zA-Z0-9]/g, '_');
            filterState.jewelryCharms[key] = {
                name: item.name,
                code: item.code,
                show: true,
                useCustomColors: false,
                chatNotification: false,
                fontColor: 'DARK_GREEN',
                borderColor: null,
                backgroundColor: null,
                filterLevels: [true, true, true, true, true, true, true, true, true, true]
            };
        });

        classSpecificUniques.forEach(item => {
            // Use name as key since same code may be used by multiple items
            const key = item.name.replace(/[^a-zA-Z0-9]/g, '_');
            filterState.classUniques[key] = {
                name: item.name,
                code: item.code,
                show: true,
                useCustomColors: false,
                chatNotification: false,
                fontColor: 'DARK_GREEN',
                borderColor: null,
                backgroundColor: null,
                filterLevels: [true, true, true, true, true, true, true, true, true, true]
            };
        });

        eliteUniqueWeapons.forEach(item => {
            const key = item.name.replace(/[^a-zA-Z0-9]/g, '_');
            filterState.eliteWeapons[key] = {
                name: item.name,
                code: item.code,
                show: true,
                useCustomColors: false,
                chatNotification: false,
                fontColor: 'DARK_GREEN',
                borderColor: null,
                backgroundColor: null,
                filterLevels: [true, true, true, true, true, true, true, true, true, true]
            };
        });

        eliteUniqueArmor.forEach(item => {
            const key = item.name.replace(/[^a-zA-Z0-9]/g, '_');
            filterState.eliteArmor[key] = {
                name: item.name,
                code: item.code,
                show: true,
                useCustomColors: false,
                chatNotification: false,
                fontColor: 'DARK_GREEN',
                borderColor: null,
                backgroundColor: null,
                filterLevels: [true, true, true, true, true, true, true, true, true, true]
            };
        });

        exceptionalUniqueWeapons.forEach(item => {
            const key = item.name.replace(/[^a-zA-Z0-9]/g, '_');
            filterState.excWeapons[key] = {
                name: item.name,
                code: item.code,
                show: true,
                useCustomColors: false,
                chatNotification: false,
                fontColor: 'DARK_GREEN',
                borderColor: null,
                backgroundColor: null,
                filterLevels: [true, true, true, true, true, true, true, true, true, true]
            };
        });

        exceptionalUniqueArmor.forEach(item => {
            const key = item.name.replace(/[^a-zA-Z0-9]/g, '_');
            filterState.excArmor[key] = {
                name: item.name,
                code: item.code,
                show: true,
                useCustomColors: false,
                chatNotification: false,
                fontColor: 'DARK_GREEN',
                borderColor: null,
                backgroundColor: null,
                filterLevels: [true, true, true, true, true, true, true, true, true, true]
            };
        });

        normalUniqueWeapons.forEach(item => {
            const key = item.name.replace(/[^a-zA-Z0-9]/g, '_');
            filterState.normWeapons[key] = {
                name: item.name,
                code: item.code,
                show: true,
                useCustomColors: false,
                chatNotification: false,
                fontColor: 'DARK_GREEN',
                borderColor: null,
                backgroundColor: null,
                filterLevels: [true, true, true, true, true, true, true, true, true, true]
            };
        });

        normalUniqueArmor.forEach(item => {
            const key = item.name.replace(/[^a-zA-Z0-9]/g, '_');
            filterState.normArmor[key] = {
                name: item.name,
                code: item.code,
                show: true,
                useCustomColors: false,
                chatNotification: false,
                fontColor: 'DARK_GREEN',
                borderColor: null,
                backgroundColor: null,
                filterLevels: [true, true, true, true, true, true, true, true, true, true]
            };
        });

        // Initialize state for set items
        highLevelSets.forEach(item => {
            const key = item.code + '_' + item.set;
            filterState.highSets[key] = {
                name: item.name,
                code: item.code,
                set: item.set,
                show: true,
                useCustomColors: false,
                chatNotification: false,
                fontColor: 'DARK_GREEN',
                borderColor: null,
                backgroundColor: null,
                filterLevels: [true, true, true, true, true, true, true, true, true, true]
            };
        });

        midLevelSets.forEach(item => {
            const key = item.code + '_' + item.set;
            filterState.midSets[key] = {
                name: item.name,
                code: item.code,
                set: item.set,
                show: true,
                useCustomColors: false,
                chatNotification: false,
                fontColor: 'DARK_GREEN',
                borderColor: null,
                backgroundColor: null,
                filterLevels: [true, true, true, true, true, true, true, true, true, true]
            };
        });

        lowLevelSets.forEach(item => {
            const key = item.code + '_' + item.set;
            filterState.lowSets[key] = {
                name: item.name,
                code: item.code,
                set: item.set,
                show: true,
                useCustomColors: false,
                chatNotification: false,
                fontColor: 'DARK_GREEN',
                borderColor: null,
                backgroundColor: null,
                filterLevels: [true, true, true, true, true, true, true, true, true, true]
            };
        });

        // Initialize state for magic items
        magicJewelry.forEach((item, idx) => {
            const key = item.code + '_' + idx;
            filterState.magicJewelry[key] = {
                name: item.name,
                code: item.code,
                minIlvl: item.minIlvl,
                maxIlvl: item.maxIlvl,
                desc: item.desc,
                show: true,
                useCustomColors: false,
                chatNotification: false,
                fontColor: 'BLUE',
                borderColor: null,
                backgroundColor: null,
                filterLevels: [true, true, true, true, true, true, true, true, true, true]
            };
        });

        magicCharms.forEach((item, idx) => {
            const key = item.code + '_' + idx;
            filterState.magicCharms[key] = {
                name: item.name,
                code: item.code,
                minIlvl: item.minIlvl,
                maxIlvl: item.maxIlvl,
                desc: item.desc,
                show: true,
                useCustomColors: false,
                chatNotification: false,
                fontColor: 'BLUE',
                borderColor: null,
                backgroundColor: null,
                filterLevels: [true, true, true, true, true, true, true, true, true, true]
            };
        });

        magicCraftingBases.forEach((item, idx) => {
            const key = item.code + '_' + idx;
            filterState.magicCrafting[key] = {
                name: item.name,
                code: item.code,
                minIlvl: item.minIlvl,
                maxIlvl: item.maxIlvl,
                desc: item.desc,
                show: true,
                useCustomColors: false,
                chatNotification: false,
                fontColor: 'BLUE',
                borderColor: null,
                backgroundColor: null,
                filterLevels: [true, true, true, true, true, true, true, true, true, true]
            };
        });

        // Initialize state for rare items
        rareJewelry.forEach((item, idx) => {
            const key = item.code + '_' + idx;
            filterState.rareJewelry[key] = {
                name: item.name,
                code: item.code,
                desc: item.desc,
                show: true,
                useCustomColors: false,
                chatNotification: false,
                fontColor: 'YELLOW',
                borderColor: null,
                backgroundColor: null,
                filterLevels: [true, true, true, true, true, true, true, true, true, true]
            };
        });

        rareClassItems.forEach((item, idx) => {
            const key = item.code + '_' + idx;
            filterState.rareClassItems[key] = {
                name: item.name,
                code: item.code,
                minIlvl: item.minIlvl,
                tier: item.tier,
                desc: item.desc,
                show: true,
                useCustomColors: false,
                chatNotification: false,
                fontColor: 'YELLOW',
                borderColor: null,
                backgroundColor: null,
                filterLevels: [true, true, true, true, true, true, true, true, true, true]
            };
        });

        rareEliteBases.forEach((item, idx) => {
            const key = item.code + '_' + idx;
            filterState.rareEliteBases[key] = {
                name: item.name,
                code: item.code,
                minIlvl: item.minIlvl,
                tier: item.tier,
                desc: item.desc,
                show: true,
                useCustomColors: false,
                chatNotification: false,
                fontColor: 'YELLOW',
                borderColor: null,
                backgroundColor: null,
                filterLevels: [true, true, true, true, true, true, true, true, true, true]
            };
        });

        // Initialize NMAG runeword bases state
        const initializeNmagState = (items, stateCategory) => {
            items.forEach((item, idx) => {
                const key = item.code + '_' + idx;
                filterState[stateCategory][key] = {
                    name: item.name,
                    code: item.code,
                    quality: item.quality,
                    rw: item.rw,
                    show: true,
                    ethFilter: 'both',  // 'both', 'eth-only', 'non-eth'
                    sockFilter: [],     // Array of selected socket counts: ['0', '3', '4', etc]
                    edFilter: 'any',    // 'any', '10+', '12+', '13+', '14+', '15'
                    useCustomColors: false,
                    chatNotification: false,
                    fontColor: 'WHITE',
                    borderColor: null,
                    backgroundColor: null,
                    filterLevels: [true, true, true, true, true, true, true, true, true, true]
                };
            });
        };

        initializeNmagState(nmagPolearms, 'nmagPolearms');
        initializeNmagState(nmagSwords, 'nmagSwords');
        initializeNmagState(nmagAxes, 'nmagAxes');
        initializeNmagState(nmagMaces, 'nmagMaces');
        initializeNmagState(nmagStaves, 'nmagStaves');
        initializeNmagState(nmagBows, 'nmagBows');
        initializeNmagState(nmagLightArmor, 'nmagLightArmor');
        initializeNmagState(nmagHeavyArmor, 'nmagHeavyArmor');
        initializeNmagState(nmagShieldsGeneric, 'nmagShieldsGeneric');
        initializeNmagState(nmagShieldsPaladin, 'nmagShieldsPaladin');
        initializeNmagState(nmagHelms, 'nmagHelms');
        initializeNmagState(nmagClassSpecific, 'nmagClassSpecific');

        // Render items
        function renderUtilityItems() {
            const container = document.getElementById('utility-items');
            container.innerHTML = '';
            
            utilityItems.forEach(item => {
                const state = filterState.utility[item.code];
                const row = document.createElement('div');
                row.className = 'item-row';
                
                // Build font color options
                const fontOptions = FONT_COLORS.map(color => 
                    `<option value="${color}" ${state.fontColor === color ? 'selected' : ''}>${color}</option>`
                ).join('');
                
                // Build filter levels checkboxes (only for named levels)
                const levelCheckboxes = state.filterLevels
                    .map((checked, idx) => {
                        if (!globalSettings.levelNames[idx]) return null;
                        return `
                            <div class="level-checkbox-wrapper" title="${globalSettings.levelNames[idx]}">
                                <input type="checkbox" class="level-checkbox" 
                                    ${checked ? 'checked' : ''}
                                    onchange="updateItemLevel('utility', '${item.code}', ${idx}, this.checked)">
                                <span class="level-checkbox-label">${idx + 1}</span>
                            </div>
                        `;
                    })
                    .filter(cb => cb !== null)
                    .join('');
                
                row.innerHTML = `
                    <input type="checkbox" class="item-checkbox" 
                        ${state.show ? 'checked' : ''} 
                        onchange="updateItemState('utility', '${item.code}', 'show', this.checked)">
                    <span class="item-name">${item.name}</span>
                    <div class="levels-selector ${!globalSettings.enableFilterLevels ? 'disabled' : ''}">
                        <span class="levels-label">FilterLevels:</span>
                        <button class="btn-link" onclick="setAllLevels('utility', '${item.code}', true); event.preventDefault();" title="Select all levels">All</button>
                        <button class="btn-link" onclick="setAllLevels('utility', '${item.code}', false); event.preventDefault();" title="Deselect all levels">None</button>
                        <div class="level-checkboxes">
                            ${levelCheckboxes}
                        </div>
                    </div>
                    <button class="settings-btn" 
                        onclick="openItemSettings('utility', '${item.code}', \`${item.name}\`, 'simple')" 
                        title="Configure item settings">⚙</button>
                `;
                container.appendChild(row);
            });

            updateItemCount('utility');
        }

        function renderRuneItems() {
            const container = document.getElementById('runes-items');
            container.innerHTML = '';
            
            runeItems.forEach(item => {
                const state = filterState.runes[item.code];
                const row = document.createElement('div');
                row.className = 'item-row';
                
                // Build font color options
                const fontOptions = FONT_COLORS.map(color => 
                    `<option value="${color}" ${state.fontColor === color ? 'selected' : ''}>${color}</option>`
                ).join('');
                
                // Build filter levels checkboxes (only for named levels)
                const levelCheckboxes = state.filterLevels
                    .map((checked, idx) => {
                        if (!globalSettings.levelNames[idx]) return null;
                        return `
                            <div class="level-checkbox-wrapper" title="${globalSettings.levelNames[idx]}">
                                <input type="checkbox" class="level-checkbox" 
                                    ${checked ? 'checked' : ''}
                                    onchange="updateItemLevel('runes', '${item.code}', ${idx}, this.checked)">
                                <span class="level-checkbox-label">${idx + 1}</span>
                            </div>
                        `;
                    })
                    .filter(cb => cb !== null)
                    .join('');
                
                row.innerHTML = `
                    <input type="checkbox" class="item-checkbox" 
                        ${state.show ? 'checked' : ''} 
                        onchange="updateItemState('runes', '${item.code}', 'show', this.checked)">
                    <span class="item-name">${item.name}</span>
                    <div class="levels-selector ${!globalSettings.enableFilterLevels ? 'disabled' : ''}">
                        <span class="levels-label">FilterLevels:</span>
                        <button class="btn-link" onclick="setAllLevels('runes', '${item.code}', true); event.preventDefault();" title="Select all levels">All</button>
                        <button class="btn-link" onclick="setAllLevels('runes', '${item.code}', false); event.preventDefault();" title="Deselect all levels">None</button>
                        <div class="level-checkboxes">
                            ${levelCheckboxes}
                        </div>
                    </div>
                    <button class="settings-btn" 
                        onclick="openItemSettings('runes', '${item.code}', \`${item.name}\`, 'simple')" 
                        title="Configure item settings">⚙</button>
                `;
                container.appendChild(row);
            });

            updateItemCount('runes');
        }

        function renderGemsItems() {
            const container = document.getElementById('gems-items');
            container.innerHTML = '';
            
            gemItems.forEach(item => {
                const state = filterState.gems[item.code];
                const row = document.createElement('div');
                row.className = 'item-row';
                
                // Build font color options
                const fontOptions = FONT_COLORS.map(color => 
                    `<option value="${color}" ${state.fontColor === color ? 'selected' : ''}>${color}</option>`
                ).join('');
                
                // Build filter levels checkboxes (only for named levels)
                const levelCheckboxes = state.filterLevels
                    .map((checked, idx) => {
                        if (!globalSettings.levelNames[idx]) return null;
                        return `
                            <div class="level-checkbox-wrapper" title="${globalSettings.levelNames[idx]}">
                                <input type="checkbox" class="level-checkbox" 
                                    ${checked ? 'checked' : ''}
                                    onchange="updateItemLevel('gems', '${item.code}', ${idx}, this.checked)">
                                <span class="level-checkbox-label">${idx + 1}</span>
                            </div>
                        `;
                    })
                    .filter(cb => cb !== null)
                    .join('');
                
                row.innerHTML = `
                    <input type="checkbox" class="item-checkbox" 
                        ${state.show ? 'checked' : ''} 
                        onchange="updateItemState('gems', '${item.code}', 'show', this.checked)">
                    <span class="item-name">${item.name}</span>
                    <div class="levels-selector ${!globalSettings.enableFilterLevels ? 'disabled' : ''}">
                        <span class="levels-label">FilterLevels:</span>
                        <button class="btn-link" onclick="setAllLevels('gems', '${item.code}', true); event.preventDefault();" title="Select all levels">All</button>
                        <button class="btn-link" onclick="setAllLevels('gems', '${item.code}', false); event.preventDefault();" title="Deselect all levels">None</button>
                        <div class="level-checkboxes">
                            ${levelCheckboxes}
                        </div>
                    </div>
                    <button class="settings-btn" 
                        onclick="openItemSettings('gems', '${item.code}', \`${item.name}\`, 'simple')" 
                        title="Configure item settings">⚙</button>
                `;
                container.appendChild(row);
            });

            updateItemCount('gems');
        }

        function renderMiscItems() {
            const container = document.getElementById('misc-items');
            container.innerHTML = '';
            
            miscItems.forEach(item => {
                const state = filterState.misc[item.code];
                const row = document.createElement('div');
                row.className = 'item-row';
                
                // Build font color options
                const fontOptions = FONT_COLORS.map(color => 
                    `<option value="${color}" ${state.fontColor === color ? 'selected' : ''}>${color}</option>`
                ).join('');
                
                // Build filter levels checkboxes (only for named levels)
                const levelCheckboxes = state.filterLevels
                    .map((checked, idx) => {
                        if (!globalSettings.levelNames[idx]) return null;
                        return `
                            <div class="level-checkbox-wrapper" title="${globalSettings.levelNames[idx]}">
                                <input type="checkbox" class="level-checkbox" 
                                    ${checked ? 'checked' : ''}
                                    onchange="updateItemLevel('misc', '${item.code}', ${idx}, this.checked)">
                                <span class="level-checkbox-label">${idx + 1}</span>
                            </div>
                        `;
                    })
                    .filter(cb => cb !== null)
                    .join('');
                
                row.innerHTML = `
                    <input type="checkbox" class="item-checkbox" 
                        ${state.show ? 'checked' : ''} 
                        onchange="updateItemState('misc', '${item.code}', 'show', this.checked)">
                    <span class="item-name">${item.name}</span>
                    <div class="levels-selector ${!globalSettings.enableFilterLevels ? 'disabled' : ''}">
                        <span class="levels-label">FilterLevels:</span>
                        <button class="btn-link" onclick="setAllLevels('misc', '${item.code}', true); event.preventDefault();" title="Select all levels">All</button>
                        <button class="btn-link" onclick="setAllLevels('misc', '${item.code}', false); event.preventDefault();" title="Deselect all levels">None</button>
                        <div class="level-checkboxes">
                            ${levelCheckboxes}
                        </div>
                    </div>
                    <button class="settings-btn" 
                        onclick="openItemSettings('misc', '${item.code}', \`${item.name}\`, 'simple')" 
                        title="Configure item settings">⚙</button>
                `;
                container.appendChild(row);
            });

            updateItemCount('misc');
        }

        // Helper to find item code from key for different categories
        function findItemCodeByKey(category, key, items) {
            const item = items.find(i => {
                const itemKey = (category === 'highSets' || category === 'midSets' || category === 'lowSets') 
                    ? i.code + '_' + i.set
                    : i.name.replace(/[^a-zA-Z0-9]/g, '_');
                return itemKey === key;
            });
            return item ? item.code : null;
        }

        // Update state and regenerate filter
        function updateItemState(category, code, property, value) {
            filterState[category][code][property] = value;
            
            // Re-render if useCustomColors changed to update UI
            if (property === 'useCustomColors') {
                if (category === 'utility') {
                    renderUtilityItems();
                } else if (category === 'runes') {
                    renderRuneItems();
                } else if (category === 'gems') {
                    renderGemsItems();
                } else if (category === 'misc') {
                    renderMiscItems();
                }
            }
            
            updateItemCount(category);
            generateFilter();
            // Delay highlighting to ensure DOM updates complete
            setTimeout(() => highlightItemInOutput(code), 100);
        }

        // Clear a color value
        function clearColor(category, code, property) {
            filterState[category][code][property] = null;
            if (category === 'utility') {
                renderUtilityItems();
            } else if (category === 'runes') {
                renderRuneItems();
            } else if (category === 'gems') {
                renderGemsItems();
            } else if (category === 'misc') {
                renderMiscItems();
            }
            generateFilter();
            setTimeout(() => highlightItemInOutput(code), 100);
        }

        // Clear font color to default
        function clearFontColor(category, code) {
            let defaultColor = 'WHITE';
            if (category === 'runes') defaultColor = 'ORANGE';
            else if (category === 'misc') defaultColor = 'PURPLE';
            
            filterState[category][code].fontColor = defaultColor;
            if (category === 'utility') {
                renderUtilityItems();
            } else if (category === 'runes') {
                renderRuneItems();
            } else if (category === 'gems') {
                renderGemsItems();
            } else if (category === 'misc') {
                renderMiscItems();
            }
            generateFilter();
            setTimeout(() => highlightItemInOutput(code), 100);
        }

        // Update item counts
        function updateItemCount(category) {
            const state = filterState[category];
            const total = Object.keys(state).length;
            const shown = Object.values(state).filter(item => item.show).length;
            document.getElementById(`${category}-count`).textContent = `(${shown}/${total} shown)`;
        }

        // Section toggling
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            section.classList.toggle('expanded');
        }

        // Presets
        function applyUtilityPreset(preset) {
            if (!preset) return;

            const essentialCodes = ['rvl', 'rvs', 'hp5', 'mp5', 'tbk', 'ibk', 'tsc', 'isc'];
            const lowPotions = ['hp1', 'hp2', 'hp3', 'mp1', 'mp2', 'mp3'];

            switch(preset) {
                case 'show-all':
                    Object.keys(filterState.utility).forEach(code => {
                        filterState.utility[code].show = true;
                    });
                    break;
                case 'hide-all':
                    Object.keys(filterState.utility).forEach(code => {
                        filterState.utility[code].show = false;
                    });
                    break;
                case 'essential-only':
                    Object.keys(filterState.utility).forEach(code => {
                        filterState.utility[code].show = essentialCodes.includes(code);
                    });
                    break;
                case 'endgame':
                    Object.keys(filterState.utility).forEach(code => {
                        filterState.utility[code].show = !lowPotions.includes(code);
                    });
                    break;
            }

            renderUtilityItems();
            generateFilter();
        }

        function applyRunePreset(preset) {
            if (!preset) return;

            switch(preset) {
                case 'show-all':
                    Object.keys(filterState.runes).forEach(code => {
                        filterState.runes[code].show = true;
                    });
                    break;
                case 'hide-all':
                    Object.keys(filterState.runes).forEach(code => {
                        filterState.runes[code].show = false;
                    });
                    break;
                case 'hide-low':
                    runeItems.forEach(item => {
                        filterState.runes[item.code].show = item.code > 'r09'; // After Ort
                    });
                    break;
                case 'mid-plus':
                    runeItems.forEach(item => {
                        filterState.runes[item.code].show = item.code >= 'r10'; // Thul+
                    });
                    break;
                case 'high-only':
                    runeItems.forEach(item => {
                        filterState.runes[item.code].show = item.code >= 'r21'; // Pul+
                    });
                    break;
            }

            renderRuneItems();
            generateFilter();
        }

        function applyGemPreset(preset) {
            if (!preset) return;

            switch(preset) {
                case 'show-all':
                    Object.keys(filterState.gems).forEach(code => {
                        filterState.gems[code].show = true;
                    });
                    break;
                case 'hide-all':
                    Object.keys(filterState.gems).forEach(code => {
                        filterState.gems[code].show = false;
                    });
                    break;
                case 'perfect-only':
                    gemItems.forEach(item => {
                        filterState.gems[item.code].show = item.level === 5;
                    });
                    break;
                case 'flawless-plus':
                    gemItems.forEach(item => {
                        filterState.gems[item.code].show = item.level >= 4;
                    });
                    break;
                case 'regular-plus':
                    gemItems.forEach(item => {
                        filterState.gems[item.code].show = item.level >= 3;
                    });
                    break;
            }

            renderGemsItems();
            generateFilter();
        }

        function applyMiscPreset(preset) {
            if (!preset) return;

            const essentials = ['cx5', 'cx9', 'pk1', 'pk2', 'pk3', 'dhn', 'bey', 'mbr', 'tes', 'ceh', 'bet', 'fed'];

            switch(preset) {
                case 'show-all':
                    Object.keys(filterState.misc).forEach(code => {
                        filterState.misc[code].show = true;
                    });
                    break;
                case 'hide-all':
                    Object.keys(filterState.misc).forEach(code => {
                        filterState.misc[code].show = false;
                    });
                    break;
                case 'essentials':
                    Object.keys(filterState.misc).forEach(code => {
                        filterState.misc[code].show = essentials.includes(code);
                    });
                    break;
            }

            renderMiscItems();
            generateFilter();
        }

        // ====== UNIQUE ITEMS FUNCTIONS ======

        // Generic render function for all unique item categories
        function renderUniqueItems(items, stateCategory, containerId, countId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            items.forEach(item => {
                const key = item.name.replace(/[^a-zA-Z0-9]/g, '_');
                const state = filterState[stateCategory][key];
                const row = document.createElement('div');
                row.className = 'item-row';
                
                // Build filter levels checkboxes (only for named levels)
                const levelCheckboxes = state.filterLevels
                    .map((checked, idx) => {
                        if (!globalSettings.levelNames[idx]) return null;
                        return `
                            <div class="level-checkbox-wrapper" title="${globalSettings.levelNames[idx]}">
                                <input type="checkbox" class="level-checkbox" 
                                    ${checked ? 'checked' : ''}
                                    onchange="updateItemLevel('${stateCategory}', '${key}', ${idx}, this.checked)">
                                <span class="level-checkbox-label">${idx + 1}</span>
                            </div>
                        `;
                    })
                    .filter(cb => cb !== null)
                    .join('');
                
                row.innerHTML = `
                    <input type="checkbox" class="item-checkbox" 
                        ${state.show ? 'checked' : ''} 
                        onchange="updateUniqueItemState('${stateCategory}', '${key}', 'show', this.checked)">
                    <span class="item-name">${item.name}</span>
                    <div class="levels-selector ${!globalSettings.enableFilterLevels ? 'disabled' : ''}">
                        <span class="levels-label">Levels:</span>
                        <button class="btn-link" onclick="setAllLevels('${stateCategory}', '${key}', true); event.preventDefault();" title="Select all levels">All</button>
                        <button class="btn-link" onclick="setAllLevels('${stateCategory}', '${key}', false); event.preventDefault();" title="Deselect all levels">None</button>
                        <div class="level-checkboxes">
                            ${levelCheckboxes}
                        </div>
                    </div>
                    <button class="settings-btn" 
                        onclick="openItemSettings('${stateCategory}', '${key}', '${item.name.replace(/'/g, "\\'")}', 'unique')" 
                        title="Configure item settings">⚙</button>
                `;
                container.appendChild(row);
            });

            updateUniqueCount(stateCategory, countId);
        }

        function renderJewelryCharmsItems() {
            renderUniqueItems(jewelryAndCharms, 'jewelryCharms', 'jewelry-charms-items', 'jewelry-charms');
        }

        function renderClassUniquesItems() {
            renderUniqueItems(classSpecificUniques, 'classUniques', 'class-uniques-items', 'class-uniques');
        }

        function renderEliteWeaponsItems() {
            renderUniqueItems(eliteUniqueWeapons, 'eliteWeapons', 'elite-weapons-items', 'elite-weapons');
        }

        function renderEliteArmorItems() {
            renderUniqueItems(eliteUniqueArmor, 'eliteArmor', 'elite-armor-items', 'elite-armor');
        }

        function renderExcWeaponsItems() {
            renderUniqueItems(exceptionalUniqueWeapons, 'excWeapons', 'exc-weapons-items', 'exc-weapons');
        }

        function renderExcArmorItems() {
            renderUniqueItems(exceptionalUniqueArmor, 'excArmor', 'exc-armor-items', 'exc-armor');
        }

        function renderNormWeaponsItems() {
            renderUniqueItems(normalUniqueWeapons, 'normWeapons', 'norm-weapons-items', 'norm-weapons');
        }

        function renderNormArmorItems() {
            renderUniqueItems(normalUniqueArmor, 'normArmor', 'norm-armor-items', 'norm-armor');
        }

        // Generic set items rendering function (uses SET keyword instead of UNI)
        function renderSetItems(items, stateCategory, containerId, countId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            container.innerHTML = '';
            let shownCount = 0;

            items.forEach(item => {
                const key = item.code + '_' + item.set;
                const state = filterState[stateCategory][key];
                if (state.show) shownCount++;

                const row = document.createElement('div');
                row.className = 'item-row';

                // Build filter levels checkboxes (only for named levels)
                const levelCheckboxes = state.filterLevels
                    .map((checked, idx) => {
                        if (!globalSettings.levelNames[idx]) return null;
                        return `
                            <div class="level-checkbox-wrapper" title="${globalSettings.levelNames[idx]}">
                                <input type="checkbox" class="level-checkbox" 
                                    ${checked ? 'checked' : ''}
                                    onchange="updateItemLevel('${stateCategory}', '${key}', ${idx}, this.checked)">
                                <span class="level-checkbox-label">${idx + 1}</span>
                            </div>
                        `;
                    })
                    .filter(cb => cb !== null)
                    .join('');

                row.innerHTML = `
                    <input type="checkbox" class="item-checkbox" ${state.show ? 'checked' : ''}
                        onchange="updateSetItemState('${stateCategory}', '${key}', 'show', this.checked)">
                    <span class="item-name">${state.name}</span>
                    <div class="levels-selector ${!globalSettings.enableFilterLevels ? 'disabled' : ''}">
                        <span class="levels-label">Levels:</span>
                        <button class="btn-link" onclick="setAllLevels('${stateCategory}', '${key}', true); event.preventDefault();" title="Select all levels">All</button>
                        <button class="btn-link" onclick="setAllLevels('${stateCategory}', '${key}', false); event.preventDefault();" title="Deselect all levels">None</button>
                        <div class="level-checkboxes">
                            ${levelCheckboxes}
                        </div>
                    </div>
                    <button class="settings-btn" 
                        onclick="openItemSettings('${stateCategory}', '${key}', '${state.name.replace(/'/g, "\\'")}', 'set')" 
                        title="Configure item settings">⚙</button>
                `;

                container.appendChild(row);
            });

            document.getElementById(countId).textContent = `(${shownCount}/${items.length} shown)`;
        }

        // Specific set rendering functions
        function renderHighSetsItems() {
            renderSetItems(highLevelSets, 'highSets', 'high-sets-items', 'high-sets-count');
        }

        function renderMidSetsItems() {
            renderSetItems(midLevelSets, 'midSets', 'mid-sets-items', 'mid-sets-count');
        }

        function renderLowSetsItems() {
            renderSetItems(lowLevelSets, 'lowSets', 'low-sets-items', 'low-sets-count');
        }

        // Generic magic/rare items rendering function
        function renderMagicRareItems(items, stateCategory, containerId, countId, defaultColor) {
            const container = document.getElementById(containerId);
            if (!container) return;

            container.innerHTML = '';
            let shownCount = 0;

            // Determine if this is magic or rare based on defaultColor
            const itemType = defaultColor === 'BLUE' ? 'magic' : 'rare';

            items.forEach((item, idx) => {
                const key = item.code + '_' + idx;
                const state = filterState[stateCategory][key];
                if (state.show) shownCount++;

                const row = document.createElement('div');
                row.className = 'item-row';

                // Build filter levels checkboxes (only for named levels)
                const levelCheckboxes = state.filterLevels
                    .map((checked, idx) => {
                        if (!globalSettings.levelNames[idx]) return null;
                        return `
                            <div class="level-checkbox-wrapper" title="${globalSettings.levelNames[idx]}">
                                <input type="checkbox" class="level-checkbox" 
                                    ${checked ? 'checked' : ''}
                                    onchange="updateItemLevel('${stateCategory}', '${key}', ${idx}, this.checked)">
                                <span class="level-checkbox-label">${idx + 1}</span>
                            </div>
                        `;
                    })
                    .filter(cb => cb !== null)
                    .join('');

                row.innerHTML = `
                    <input type="checkbox" class="item-checkbox" ${state.show ? 'checked' : ''}
                        onchange="updateMagicRareItemState('${stateCategory}', '${key}', 'show', this.checked)">
                    <span class="item-name">${state.name}</span>
                    <div class="levels-selector ${!globalSettings.enableFilterLevels ? 'disabled' : ''}">
                        <span class="levels-label">Levels:</span>
                        <button class="btn-link" onclick="setAllLevels('${stateCategory}', '${key}', true); event.preventDefault();" title="Select all levels">All</button>
                        <button class="btn-link" onclick="setAllLevels('${stateCategory}', '${key}', false); event.preventDefault();" title="Deselect all levels">None</button>
                        <div class="level-checkboxes">
                            ${levelCheckboxes}
                        </div>
                    </div>
                    <button class="settings-btn" 
                        onclick="openItemSettings('${stateCategory}', '${key}', '${state.name.replace(/'/g, "\\'")}', '${itemType}')" 
                        title="Configure item settings">⚙</button>
                `;

                container.appendChild(row);
            });

            document.getElementById(countId).textContent = `(${shownCount}/${items.length} shown)`;
        }

        // Specific render functions for magic/rare items
        function renderMagicJewelryItems() {
            renderMagicRareItems(magicJewelry, 'magicJewelry', 'magic-jewelry-items', 'magic-jewelry-count', 'BLUE');
        }

        function renderMagicCharmsItems() {
            renderMagicRareItems(magicCharms, 'magicCharms', 'magic-charms-items', 'magic-charms-count', 'BLUE');
        }

        function renderMagicCraftingItems() {
            renderMagicRareItems(magicCraftingBases, 'magicCrafting', 'magic-crafting-items', 'magic-crafting-count', 'BLUE');
        }

        function renderRareJewelryItems() {
            renderMagicRareItems(rareJewelry, 'rareJewelry', 'rare-jewelry-items', 'rare-jewelry-count', 'YELLOW');
        }

        function renderRareClassItemsItems() {
            renderMagicRareItems(rareClassItems, 'rareClassItems', 'rare-class-items-items', 'rare-class-items-count', 'YELLOW');
        }

        function renderRareEliteBasesItems() {
            renderMagicRareItems(rareEliteBases, 'rareEliteBases', 'rare-elite-bases-items', 'rare-elite-bases-count', 'YELLOW');
        }

        // Generate socket checkboxes based on max_sockets from bases object
        function generateSocketCheckboxes(itemCode, selectedSockets, stateCategory, key) {
            // Look up max sockets from bases object in item_metadata.js
            // The state contains the item name, we need to convert it to the bases key format
            const state = filterState[stateCategory][key];
            const basesKey = state.name.replace(/ /g, '_'); // "Colossus Blade" -> "Colossus_Blade"
            const baseItem = bases[basesKey];
            let maxSockets = baseItem?.max_sockets || 6;
            
            // Override max sockets for class-specific items
            if (stateCategory === 'nmagClassSpecific') {
                if (state.name.includes('Necro') || state.name.includes('Shrunken Head')) {
                    maxSockets = 2;
                } else {
                    maxSockets = 3;
                }
            }
            
            // Available socket options: 0, 2, 3, 4, 5, 6 but limited by max_sockets
            const socketOptions = ['0', '2', '3', '4', '5', '6'].filter(sock => {
                const sockNum = parseInt(sock);
                return sock === '0' || sockNum <= maxSockets;
            });
            
            let html = '<div style="display: flex; align-items: center; gap: 4px; font-size: 11px;">';
            html += '<span style="margin-right: 2px;">Sockets:</span>';
            
            socketOptions.forEach(sock => {
                const isChecked = selectedSockets.includes(sock);
                html += `
                    <label style="display: flex; align-items: center; gap: 2px; cursor: pointer;">
                        <input type="checkbox" 
                            ${isChecked ? 'checked' : ''}
                            onchange="toggleNmagSocket('${stateCategory}', '${key}', '${sock}', this.checked)"
                            style="margin: 0; cursor: pointer;">
                        <span>${sock}</span>
                    </label>
                `;
            });
            
            html += '</div>';
            return html;
        }

        // Generic NMAG runeword bases rendering function
        function renderNmagItems(items, stateCategory, containerId, countId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            container.innerHTML = '';
            let shownCount = 0;

            items.forEach((item, idx) => {
                const key = item.code + '_' + idx;
                const state = filterState[stateCategory][key];
                if (state.show) shownCount++;

                const row = document.createElement('div');
                row.className = 'item-row';

                // Build filter levels checkboxes (only for named levels)
                const levelCheckboxes = state.filterLevels
                    .map((checked, idx) => {
                        if (!globalSettings.levelNames[idx]) return null;
                        return `
                            <div class="level-checkbox-wrapper" title="${globalSettings.levelNames[idx]}">
                                <input type="checkbox" class="level-checkbox" 
                                    ${checked ? 'checked' : ''}
                                    onchange="updateItemLevel('${stateCategory}', '${key}', ${idx}, this.checked)">
                                <span class="level-checkbox-label">${idx + 1}</span>
                            </div>
                        `;
                    })
                    .filter(cb => cb !== null)
                    .join('');

                row.innerHTML = `
                    <input type="checkbox" class="item-checkbox" ${state.show ? 'checked' : ''}
                        onchange="updateNmagItemState('${stateCategory}', '${key}', 'show', this.checked)">
                    <span class="item-name">${state.name}</span>
                    <span style="color: #888; font-size: 11px; margin-left: 8px;">[${state.quality}]</span>
                    <div class="levels-selector ${!globalSettings.enableFilterLevels ? 'disabled' : ''}">
                        <span class="levels-label">Levels:</span>
                        <button class="btn-link" onclick="setAllLevels('${stateCategory}', '${key}', true); event.preventDefault();" title="Select all levels">All</button>
                        <button class="btn-link" onclick="setAllLevels('${stateCategory}', '${key}', false); event.preventDefault();" title="Deselect all levels">None</button>
                        <div class="level-checkboxes">
                            ${levelCheckboxes}
                        </div>
                    </div>
                    <button class="settings-btn" 
                        onclick="openItemSettings('${stateCategory}', '${key}', '${state.name.replace(/'/g, "\\'")}', 'nmag')" 
                        title="Configure item settings">⚙</button>
                `;

                container.appendChild(row);
            });

            const total = items.length;
            document.getElementById(countId).textContent = `(${shownCount}/${total} shown)`;
        }

        function renderNmagPolearmsItems() {
            renderNmagItems(nmagPolearms, 'nmagPolearms', 'nmag-polearms-items', 'nmag-polearms-count');
        }

        function renderNmagSwordsItems() {
            renderNmagItems(nmagSwords, 'nmagSwords', 'nmag-swords-items', 'nmag-swords-count');
        }

        function renderNmagAxesItems() {
            renderNmagItems(nmagAxes, 'nmagAxes', 'nmag-axes-items', 'nmag-axes-count');
        }

        function renderNmagMacesItems() {
            renderNmagItems(nmagMaces, 'nmagMaces', 'nmag-maces-items', 'nmag-maces-count');
        }

        function renderNmagStavesItems() {
            renderNmagItems(nmagStaves, 'nmagStaves', 'nmag-staves-items', 'nmag-staves-count');
        }

        function renderNmagBowsItems() {
            renderNmagItems(nmagBows, 'nmagBows', 'nmag-bows-items', 'nmag-bows-count');
        }

        function renderNmagLightArmorItems() {
            renderNmagItems(nmagLightArmor, 'nmagLightArmor', 'nmag-light-armor-items', 'nmag-light-armor-count');
        }

        function renderNmagHeavyArmorItems() {
            renderNmagItems(nmagHeavyArmor, 'nmagHeavyArmor', 'nmag-heavy-armor-items', 'nmag-heavy-armor-count');
        }

        function renderNmagShieldsGenericItems() {
            renderNmagItems(nmagShieldsGeneric, 'nmagShieldsGeneric', 'nmag-shields-generic-items', 'nmag-shields-generic-count');
        }

        function renderNmagShieldsPaladinItems() {
            renderNmagItems(nmagShieldsPaladin, 'nmagShieldsPaladin', 'nmag-shields-paladin-items', 'nmag-shields-paladin-count');
        }

        function renderNmagHelmsItems() {
            renderNmagItems(nmagHelms, 'nmagHelms', 'nmag-helms-items', 'nmag-helms-count');
        }

        function renderNmagClassSpecificItems() {
            renderNmagItems(nmagClassSpecific, 'nmagClassSpecific', 'nmag-class-specific-items', 'nmag-class-specific-count');
        }

        // Helper functions for unique items
        function updateUniqueItemState(category, key, field, value) {
            filterState[category][key][field] = value;
            
            if (category === 'jewelryCharms') {
                renderJewelryCharmsItems();
            } else if (category === 'classUniques') {
                renderClassUniquesItems();
            } else if (category === 'eliteWeapons') {
                renderEliteWeaponsItems();
            } else if (category === 'eliteArmor') {
                renderEliteArmorItems();
            } else if (category === 'excWeapons') {
                renderExcWeaponsItems();
            } else if (category === 'excArmor') {
                renderExcArmorItems();
            } else if (category === 'normWeapons') {
                renderNormWeaponsItems();
            } else if (category === 'normArmor') {
                renderNormArmorItems();
            }
            
            generateFilter();
            
            // Find item code and highlight
            const itemArrays = {
                'jewelryCharms': jewelryAndCharms,
                'classUniques': classSpecificUniques,
                'eliteWeapons': eliteUniqueWeapons,
                'eliteArmor': eliteUniqueArmor,
                'excWeapons': exceptionalUniqueWeapons,
                'excArmor': exceptionalUniqueArmor,
                'normWeapons': normalUniqueWeapons,
                'normArmor': normalUniqueArmor
            };
            const code = findItemCodeByKey(category, key, itemArrays[category]);
            if (code) setTimeout(() => highlightItemInOutput(code, 'UNI'), 100);
        }

        function clearUniqueFontColor(category, key) {
            filterState[category][key].fontColor = 'DARK_GREEN';
            
            if (category === 'jewelryCharms') {
                renderJewelryCharmsItems();
            } else if (category === 'classUniques') {
                renderClassUniquesItems();
            } else if (category === 'eliteWeapons') {
                renderEliteWeaponsItems();
            } else if (category === 'eliteArmor') {
                renderEliteArmorItems();
            } else if (category === 'excWeapons') {
                renderExcWeaponsItems();
            } else if (category === 'excArmor') {
                renderExcArmorItems();
            } else if (category === 'normWeapons') {
                renderNormWeaponsItems();
            } else if (category === 'normArmor') {
                renderNormArmorItems();
            }
            
            generateFilter();
            
            const itemArrays = {
                'jewelryCharms': jewelryAndCharms,
                'classUniques': classSpecificUniques,
                'eliteWeapons': eliteUniqueWeapons,
                'eliteArmor': eliteUniqueArmor,
                'excWeapons': exceptionalUniqueWeapons,
                'excArmor': exceptionalUniqueArmor,
                'normWeapons': normalUniqueWeapons,
                'normArmor': normalUniqueArmor
            };
            const code = findItemCodeByKey(category, key, itemArrays[category]);
            if (code) setTimeout(() => highlightItemInOutput(code, 'UNI'), 100);
        }

        function clearUniqueColor(category, key, colorType) {
            filterState[category][key][colorType] = null;
            
            if (category === 'jewelryCharms') {
                renderJewelryCharmsItems();
            } else if (category === 'classUniques') {
                renderClassUniquesItems();
            } else if (category === 'eliteWeapons') {
                renderEliteWeaponsItems();
            } else if (category === 'eliteArmor') {
                renderEliteArmorItems();
            } else if (category === 'excWeapons') {
                renderExcWeaponsItems();
            } else if (category === 'excArmor') {
                renderExcArmorItems();
            } else if (category === 'normWeapons') {
                renderNormWeaponsItems();
            } else if (category === 'normArmor') {
                renderNormArmorItems();
            }
            
            generateFilter();
            
            const itemArrays = {
                'jewelryCharms': jewelryAndCharms,
                'classUniques': classSpecificUniques,
                'eliteWeapons': eliteUniqueWeapons,
                'eliteArmor': eliteUniqueArmor,
                'excWeapons': exceptionalUniqueWeapons,
                'excArmor': exceptionalUniqueArmor,
                'normWeapons': normalUniqueWeapons,
                'normArmor': normalUniqueArmor
            };
            const code = findItemCodeByKey(category, key, itemArrays[category]);
            if (code) setTimeout(() => highlightItemInOutput(code, 'UNI'), 100);
        }

        function updateUniqueCount(category, countId) {
            const state = filterState[category];
            const total = Object.keys(state).length;
            const shown = Object.values(state).filter(item => item.show).length;
            document.getElementById(`${countId}-count`).textContent = `(${shown}/${total} shown)`;
        }

        // Update set item state and re-render
        function updateSetItemState(category, key, field, value, index = null) {
            if (index !== null) {
                filterState[category][key][field][index] = value;
            } else {
                filterState[category][key][field] = value;
            }

            // Re-render the appropriate section
            if (category === 'highSets') {
                renderHighSetsItems();
            } else if (category === 'midSets') {
                renderMidSetsItems();
            } else if (category === 'lowSets') {
                renderLowSetsItems();
            }
            
            generateFilter();
            
            const itemArrays = {
                'highSets': highLevelSets,
                'midSets': midLevelSets,
                'lowSets': lowLevelSets
            };
            const code = findItemCodeByKey(category, key, itemArrays[category]);
            if (code) setTimeout(() => highlightItemInOutput(code, 'SET'), 100);
        }

        // Clear set item font color (reset to DARK_GREEN)
        function clearSetFontColor(category, key) {
            filterState[category][key].fontColor = 'DARK_GREEN';
            if (category === 'highSets') {
                renderHighSetsItems();
            } else if (category === 'midSets') {
                renderMidSetsItems();
            } else if (category === 'lowSets') {
                renderLowSetsItems();
            }
            generateFilter();
            
            const itemArrays = {
                'highSets': highLevelSets,
                'midSets': midLevelSets,
                'lowSets': lowLevelSets
            };
            const code = findItemCodeByKey(category, key, itemArrays[category]);
            if (code) setTimeout(() => highlightItemInOutput(code, 'SET'), 100);
        }

        // Clear set item border or background color
        function clearSetColor(category, key, colorType) {
            filterState[category][key][colorType] = null;
            if (category === 'highSets') {
                renderHighSetsItems();
            } else if (category === 'midSets') {
                renderMidSetsItems();
            } else if (category === 'lowSets') {
                renderLowSetsItems();
            }
            generateFilter();
            
            const itemArrays = {
                'highSets': highLevelSets,
                'midSets': midLevelSets,
                'lowSets': lowLevelSets
            };
            const code = findItemCodeByKey(category, key, itemArrays[category]);
            if (code) setTimeout(() => highlightItemInOutput(code, 'SET'), 100);
        }

        // Set all filter levels for a set item
        function setAllSetLevels(category, key, enabled) {
            for (let i = 0; i < 10; i++) {
                filterState[category][key].filterLevels[i] = enabled;
            }
            if (category === 'highSets') {
                renderHighSetsItems();
            } else if (category === 'midSets') {
                renderMidSetsItems();
            } else if (category === 'lowSets') {
                renderLowSetsItems();
            }
            generateFilter();
            
            const itemArrays = {
                'highSets': highLevelSets,
                'midSets': midLevelSets,
                'lowSets': lowLevelSets
            };
            const code = findItemCodeByKey(category, key, itemArrays[category]);
            if (code) setTimeout(() => highlightItemInOutput(code, 'SET'), 100);
        }

        // Preset functions for unique items
        function applyUniquePreset(category, items, preset) {
            items.forEach(item => {
                const key = item.name.replace(/[^a-zA-Z0-9]/g, '_');
                if (preset === 'show-all') {
                    filterState[category][key].show = true;
                } else if (preset === 'hide-all') {
                    filterState[category][key].show = false;
                }
            });
            
            // Re-render the appropriate section
            if (category === 'jewelryCharms') {
                renderJewelryCharmsItems();
            } else if (category === 'classUniques') {
                renderClassUniquesItems();
            } else if (category === 'eliteWeapons') {
                renderEliteWeaponsItems();
            } else if (category === 'eliteArmor') {
                renderEliteArmorItems();
            } else if (category === 'excWeapons') {
                renderExcWeaponsItems();
            } else if (category === 'excArmor') {
                renderExcArmorItems();
            } else if (category === 'normWeapons') {
                renderNormWeaponsItems();
            } else if (category === 'normArmor') {
                renderNormArmorItems();
            }
            
            generateFilter();
        }

        function applyJewelryCharmsPreset(preset) {
            if (!preset) return;
            applyUniquePreset('jewelryCharms', jewelryAndCharms, preset);
        }

        function applyClassUniquesPreset(preset) {
            if (!preset) return;
            applyUniquePreset('classUniques', classSpecificUniques, preset);
        }

        function applyEliteWeaponsPreset(preset) {
            if (!preset) return;
            applyUniquePreset('eliteWeapons', eliteUniqueWeapons, preset);
        }

        function applyEliteArmorPreset(preset) {
            if (!preset) return;
            applyUniquePreset('eliteArmor', eliteUniqueArmor, preset);
        }

        function applyExcWeaponsPreset(preset) {
            if (!preset) return;
            applyUniquePreset('excWeapons', exceptionalUniqueWeapons, preset);
        }

        function applyExcArmorPreset(preset) {
            if (!preset) return;
            applyUniquePreset('excArmor', exceptionalUniqueArmor, preset);
        }

        function applyNormWeaponsPreset(preset) {
            if (!preset) return;
            applyUniquePreset('normWeapons', normalUniqueWeapons, preset);
        }

        function applyNormArmorPreset(preset) {
            if (!preset) return;
            applyUniquePreset('normArmor', normalUniqueArmor, preset);
        }

        // Preset functions for set items
        function applyHighSetsPreset(preset) {
            if (!preset) return;
            highLevelSets.forEach(item => {
                const key = item.code + '_' + item.set;
                if (preset === 'show-all') {
                    filterState.highSets[key].show = true;
                } else if (preset === 'hide-all') {
                    filterState.highSets[key].show = false;
                }
            });
            renderHighSetsItems();
            generateFilter();
        }

        function applyMidSetsPreset(preset) {
            if (!preset) return;
            midLevelSets.forEach(item => {
                const key = item.code + '_' + item.set;
                if (preset === 'show-all') {
                    filterState.midSets[key].show = true;
                } else if (preset === 'hide-all') {
                    filterState.midSets[key].show = false;
                }
            });
            renderMidSetsItems();
            generateFilter();
        }

        function applyLowSetsPreset(preset) {
            if (!preset) return;
            lowLevelSets.forEach(item => {
                const key = item.code + '_' + item.set;
                if (preset === 'show-all') {
                    filterState.lowSets[key].show = true;
                } else if (preset === 'hide-all') {
                    filterState.lowSets[key].show = false;
                }
            });
            renderLowSetsItems();
            generateFilter();
        }

        // State update functions for magic/rare items
        function updateMagicRareItemState(category, key, field, value, index = null) {
            if (index !== null) {
                filterState[category][key][field][index] = value;
            } else {
                filterState[category][key][field] = value;
            }

            // Re-render the appropriate section
            if (category === 'magicJewelry') {
                renderMagicJewelryItems();
            } else if (category === 'magicCharms') {
                renderMagicCharmsItems();
            } else if (category === 'magicCrafting') {
                renderMagicCraftingItems();
            } else if (category === 'rareJewelry') {
                renderRareJewelryItems();
            } else if (category === 'rareClassItems') {
                renderRareClassItemsItems();
            } else if (category === 'rareEliteBases') {
                renderRareEliteBasesItems();
            }
            
            generateFilter();
            
            // Extract code from key format "code_index"
            const code = key.split('_')[0];
            const prefix = category.startsWith('magic') ? 'MAG' : 'RARE';
            if (code) setTimeout(() => highlightItemInOutput(code, prefix), 100);
        }

        function clearMagicRareFontColor(category, key, defaultColor) {
            filterState[category][key].fontColor = defaultColor;
            if (category === 'magicJewelry') {
                renderMagicJewelryItems();
            } else if (category === 'magicCharms') {
                renderMagicCharmsItems();
            } else if (category === 'magicCrafting') {
                renderMagicCraftingItems();
            } else if (category === 'rareJewelry') {
                renderRareJewelryItems();
            } else if (category === 'rareClassItems') {
                renderRareClassItemsItems();
            } else if (category === 'rareEliteBases') {
                renderRareEliteBasesItems();
            }
            generateFilter();
            
            const code = key.split('_')[0];
            const prefix = category.startsWith('magic') ? 'MAG' : 'RARE';
            if (code) setTimeout(() => highlightItemInOutput(code, prefix), 100);
        }

        function clearMagicRareColor(category, key, colorType) {
            filterState[category][key][colorType] = null;
            if (category === 'magicJewelry') {
                renderMagicJewelryItems();
            } else if (category === 'magicCharms') {
                renderMagicCharmsItems();
            } else if (category === 'magicCrafting') {
                renderMagicCraftingItems();
            } else if (category === 'rareJewelry') {
                renderRareJewelryItems();
            } else if (category === 'rareClassItems') {
                renderRareClassItemsItems();
            } else if (category === 'rareEliteBases') {
                renderRareEliteBasesItems();
            }
            generateFilter();
            
            const code = key.split('_')[0];
            const prefix = category.startsWith('magic') ? 'MAG' : 'RARE';
            if (code) setTimeout(() => highlightItemInOutput(code, prefix), 100);
        }

        function setAllMagicRareLevels(category, key, enabled) {
            for (let i = 0; i < 10; i++) {
                filterState[category][key].filterLevels[i] = enabled;
            }
            if (category === 'magicJewelry') {
                renderMagicJewelryItems();
            } else if (category === 'magicCharms') {
                renderMagicCharmsItems();
            } else if (category === 'magicCrafting') {
                renderMagicCraftingItems();
            } else if (category === 'rareJewelry') {
                renderRareJewelryItems();
            } else if (category === 'rareClassItems') {
                renderRareClassItemsItems();
            } else if (category === 'rareEliteBases') {
                renderRareEliteBasesItems();
            }
            generateFilter();
            
            const code = key.split('_')[0];
            const prefix = category.startsWith('magic') ? 'MAG' : 'RARE';
            if (code) setTimeout(() => highlightItemInOutput(code, prefix), 100);
        }

        // Preset functions for magic/rare items
        function applyMagicJewelryPreset(preset) {
            if (!preset) return;
            magicJewelry.forEach((item, idx) => {
                const key = item.code + '_' + idx;
                if (preset === 'show-all') {
                    filterState.magicJewelry[key].show = true;
                } else if (preset === 'hide-all') {
                    filterState.magicJewelry[key].show = false;
                } else if (preset === 'high-ilvl') {
                    filterState.magicJewelry[key].show = !item.maxIlvl || item.minIlvl >= 71;
                }
            });
            renderMagicJewelryItems();
            generateFilter();
        }

        function applyMagicCharmsPreset(preset) {
            if (!preset) return;
            magicCharms.forEach((item, idx) => {
                const key = item.code + '_' + idx;
                if (preset === 'show-all') {
                    filterState.magicCharms[key].show = true;
                } else if (preset === 'hide-all') {
                    filterState.magicCharms[key].show = false;
                } else if (preset === 'high-ilvl') {
                    filterState.magicCharms[key].show = !item.maxIlvl || item.minIlvl >= 50;
                }
            });
            renderMagicCharmsItems();
            generateFilter();
        }

        function applyMagicCraftingPreset(preset) {
            if (!preset) return;
            magicCraftingBases.forEach((item, idx) => {
                const key = item.code + '_' + idx;
                if (preset === 'show-all') {
                    filterState.magicCrafting[key].show = true;
                } else if (preset === 'hide-all') {
                    filterState.magicCrafting[key].show = false;
                }
            });
            renderMagicCraftingItems();
            generateFilter();
        }

        function applyRareJewelryPreset(preset) {
            if (!preset) return;
            rareJewelry.forEach((item, idx) => {
                const key = item.code + '_' + idx;
                if (preset === 'show-all') {
                    filterState.rareJewelry[key].show = true;
                } else if (preset === 'hide-all') {
                    filterState.rareJewelry[key].show = false;
                }
            });
            renderRareJewelryItems();
            generateFilter();
        }

        function applyRareClassItemsPreset(preset) {
            if (!preset) return;
            rareClassItems.forEach((item, idx) => {
                const key = item.code + '_' + idx;
                if (preset === 'show-all') {
                    filterState.rareClassItems[key].show = true;
                } else if (preset === 'hide-all') {
                    filterState.rareClassItems[key].show = false;
                }
            });
            renderRareClassItemsItems();
            generateFilter();
        }

        function applyRareEliteBasesPreset(preset) {
            if (!preset) return;
            rareEliteBases.forEach((item, idx) => {
                const key = item.code + '_' + idx;
                if (preset === 'show-all') {
                    filterState.rareEliteBases[key].show = true;
                } else if (preset === 'hide-all') {
                    filterState.rareEliteBases[key].show = false;
                }
            });
            renderRareEliteBasesItems();
            generateFilter();
        }

        // State update functions for NMAG items
        function updateNmagItemState(category, key, field, value, index = null) {
            if (index !== null) {
                filterState[category][key][field][index] = value;
            } else {
                filterState[category][key][field] = value;
            }

            // Re-render the appropriate section
            const renderMap = {
                'nmagPolearms': renderNmagPolearmsItems,
                'nmagSwords': renderNmagSwordsItems,
                'nmagAxes': renderNmagAxesItems,
                'nmagMaces': renderNmagMacesItems,
                'nmagStaves': renderNmagStavesItems,
                'nmagBows': renderNmagBowsItems,
                'nmagLightArmor': renderNmagLightArmorItems,
                'nmagHeavyArmor': renderNmagHeavyArmorItems,
                'nmagShieldsGeneric': renderNmagShieldsGenericItems,
                'nmagShieldsPaladin': renderNmagShieldsPaladinItems,
                'nmagHelms': renderNmagHelmsItems,
                'nmagClassSpecific': renderNmagClassSpecificItems
            };
            if (renderMap[category]) renderMap[category]();
            generateFilter();
            
            const code = key.split('_')[0];
            if (code) setTimeout(() => highlightItemInOutput(code, 'NMAG'), 100);
        }

        // Toggle socket selection for NMAG items
        function toggleNmagSocket(category, key, socketValue, checked) {
            const state = filterState[category][key];
            if (checked) {
                if (!state.sockFilter.includes(socketValue)) {
                    state.sockFilter.push(socketValue);
                }
            } else {
                state.sockFilter = state.sockFilter.filter(s => s !== socketValue);
            }
            generateFilter();
            
            const code = key.split('_')[0];
            if (code) setTimeout(() => highlightItemInOutput(code, 'NMAG'), 100);
        }

        function clearNmagFontColor(category, key) {
            filterState[category][key].fontColor = 'WHITE';
            const renderMap = {
                'nmagPolearms': renderNmagPolearmsItems,
                'nmagSwords': renderNmagSwordsItems,
                'nmagAxes': renderNmagAxesItems,
                'nmagMaces': renderNmagMacesItems,
                'nmagStaves': renderNmagStavesItems,
                'nmagLightArmor': renderNmagLightArmorItems,
                'nmagHeavyArmor': renderNmagHeavyArmorItems,
                'nmagShieldsGeneric': renderNmagShieldsGenericItems,
                'nmagShieldsPaladin': renderNmagShieldsPaladinItems,
                'nmagHelms': renderNmagHelmsItems,
                'nmagClassSpecific': renderNmagClassSpecificItems
            };
            if (renderMap[category]) renderMap[category]();
            generateFilter();
            
            const code = key.split('_')[0];
            if (code) setTimeout(() => highlightItemInOutput(code, 'NMAG'), 100);
        }

        function clearNmagColor(category, key, colorType) {
            filterState[category][key][colorType] = null;
            const renderMap = {
                'nmagPolearms': renderNmagPolearmsItems,
                'nmagSwords': renderNmagSwordsItems,
                'nmagAxes': renderNmagAxesItems,
                'nmagMaces': renderNmagMacesItems,
                'nmagStaves': renderNmagStavesItems,
                'nmagLightArmor': renderNmagLightArmorItems,
                'nmagHeavyArmor': renderNmagHeavyArmorItems,
                'nmagShieldsGeneric': renderNmagShieldsGenericItems,
                'nmagShieldsPaladin': renderNmagShieldsPaladinItems,
                'nmagHelms': renderNmagHelmsItems,
                'nmagClassSpecific': renderNmagClassSpecificItems
            };
            if (renderMap[category]) renderMap[category]();
            generateFilter();
            
            const code = key.split('_')[0];
            if (code) setTimeout(() => highlightItemInOutput(code, 'NMAG'), 100);
        }

        function setAllNmagLevels(category, key, enabled) {
            for (let i = 0; i < 10; i++) {
                filterState[category][key].filterLevels[i] = enabled;
            }
            const renderMap = {
                'nmagPolearms': renderNmagPolearmsItems,
                'nmagSwords': renderNmagSwordsItems,
                'nmagAxes': renderNmagAxesItems,
                'nmagMaces': renderNmagMacesItems,
                'nmagStaves': renderNmagStavesItems,
                'nmagLightArmor': renderNmagLightArmorItems,
                'nmagHeavyArmor': renderNmagHeavyArmorItems,
                'nmagShieldsGeneric': renderNmagShieldsGenericItems,
                'nmagShieldsPaladin': renderNmagShieldsPaladinItems,
                'nmagHelms': renderNmagHelmsItems,
                'nmagClassSpecific': renderNmagClassSpecificItems
            };
            if (renderMap[category]) renderMap[category]();
            generateFilter();
            
            const code = key.split('_')[0];
            if (code) setTimeout(() => highlightItemInOutput(code, 'NMAG'), 100);
        }

        // Preset functions for NMAG items
        function applyNmagPolearmsPreset(preset) {
            if (!preset) return;
            nmagPolearms.forEach((item, idx) => {
                const key = item.code + '_' + idx;
                if (preset === 'show-all') {
                    filterState.nmagPolearms[key].show = true;
                } else if (preset === 'hide-all') {
                    filterState.nmagPolearms[key].show = false;
                } else if (preset === 'eth-only') {
                    filterState.nmagPolearms[key].show = true;
                    filterState.nmagPolearms[key].ethFilter = 'eth-only';
                } else if (preset === '4sock') {
                    filterState.nmagPolearms[key].show = true;
                    filterState.nmagPolearms[key].sockFilter = '4';
                }
            });
            renderNmagPolearmsItems();
            generateFilter();
        }

        function applyNmagSwordsPreset(preset) {
            if (!preset) return;
            nmagSwords.forEach((item, idx) => {
                const key = item.code + '_' + idx;
                if (preset === 'show-all') {
                    filterState.nmagSwords[key].show = true;
                } else if (preset === 'hide-all') {
                    filterState.nmagSwords[key].show = false;
                } else if (preset === 'elite-only') {
                    filterState.nmagSwords[key].show = item.quality === 'elite';
                }
            });
            renderNmagSwordsItems();
            generateFilter();
        }

        function applyNmagAxesPreset(preset) {
            if (!preset) return;
            nmagAxes.forEach((item, idx) => {
                const key = item.code + '_' + idx;
                if (preset === 'show-all') {
                    filterState.nmagAxes[key].show = true;
                } else if (preset === 'hide-all') {
                    filterState.nmagAxes[key].show = false;
                }
            });
            renderNmagAxesItems();
            generateFilter();
        }

        function applyNmagMacesPreset(preset) {
            if (!preset) return;
            nmagMaces.forEach((item, idx) => {
                const key = item.code + '_' + idx;
                if (preset === 'show-all') {
                    filterState.nmagMaces[key].show = true;
                } else if (preset === 'hide-all') {
                    filterState.nmagMaces[key].show = false;
                }
            });
            renderNmagMacesItems();
            generateFilter();
        }

        function applyNmagStavesPreset(preset) {
            if (!preset) return;
            nmagStaves.forEach((item, idx) => {
                const key = item.code + '_' + idx;
                if (preset === 'show-all') {
                    filterState.nmagStaves[key].show = true;
                } else if (preset === 'hide-all') {
                    filterState.nmagStaves[key].show = false;
                }
            });
            renderNmagStavesItems();
            generateFilter();
        }

        function applyNmagBowsPreset(preset) {
            if (!preset) return;
            nmagBows.forEach((item, idx) => {
                const key = item.code + '_' + idx;
                if (preset === 'show-all') {
                    filterState.nmagBows[key].show = true;
                } else if (preset === 'hide-all') {
                    filterState.nmagBows[key].show = false;
                }
            });
            renderNmagBowsItems();
            generateFilter();
        }

        function applyNmagLightArmorPreset(preset) {
            if (!preset) return;
            nmagLightArmor.forEach((item, idx) => {
                const key = item.code + '_' + idx;
                if (preset === 'show-all') {
                    filterState.nmagLightArmor[key].show = true;
                } else if (preset === 'hide-all') {
                    filterState.nmagLightArmor[key].show = false;
                } else if (preset === 'elite-only') {
                    filterState.nmagLightArmor[key].show = item.quality === 'elite';
                }
            });
            renderNmagLightArmorItems();
            generateFilter();
        }

        function applyNmagHeavyArmorPreset(preset) {
            if (!preset) return;
            nmagHeavyArmor.forEach((item, idx) => {
                const key = item.code + '_' + idx;
                if (preset === 'show-all') {
                    filterState.nmagHeavyArmor[key].show = true;
                } else if (preset === 'hide-all') {
                    filterState.nmagHeavyArmor[key].show = false;
                }
            });
            renderNmagHeavyArmorItems();
            generateFilter();
        }

        function applyNmagShieldsGenericPreset(preset) {
            if (!preset) return;
            nmagShieldsGeneric.forEach((item, idx) => {
                const key = item.code + '_' + idx;
                if (preset === 'show-all') {
                    filterState.nmagShieldsGeneric[key].show = true;
                } else if (preset === 'hide-all') {
                    filterState.nmagShieldsGeneric[key].show = false;
                }
            });
            renderNmagShieldsGenericItems();
            generateFilter();
        }

        function applyNmagShieldsPaladinPreset(preset) {
            if (!preset) return;
            nmagShieldsPaladin.forEach((item, idx) => {
                const key = item.code + '_' + idx;
                if (preset === 'show-all') {
                    filterState.nmagShieldsPaladin[key].show = true;
                } else if (preset === 'hide-all') {
                    filterState.nmagShieldsPaladin[key].show = false;
                }
            });
            renderNmagShieldsPaladinItems();
            generateFilter();
        }

        function applyNmagHelmsPreset(preset) {
            if (!preset) return;
            nmagHelms.forEach((item, idx) => {
                const key = item.code + '_' + idx;
                if (preset === 'show-all') {
                    filterState.nmagHelms[key].show = true;
                } else if (preset === 'hide-all') {
                    filterState.nmagHelms[key].show = false;
                }
            });
            renderNmagHelmsItems();
            generateFilter();
        }

        function applyNmagClassSpecificPreset(preset) {
            if (!preset) return;
            nmagClassSpecific.forEach((item, idx) => {
                const key = item.code + '_' + idx;
                if (preset === 'show-all') {
                    filterState.nmagClassSpecific[key].show = true;
                } else if (preset === 'hide-all') {
                    filterState.nmagClassSpecific[key].show = false;
                }
            });
            renderNmagClassSpecificItems();
            generateFilter();
        }

        // Generate filter output
        function generateFilter() {
            // Get current date formatted as "DD MMM"
            const now = new Date();
            const day = now.getDate();
            const month = now.toLocaleString('en-US', { month: 'short' });
            const dateStr = `${day} ${month}`;
            
            let filter = '// FilterPhoenix Visual Filter Builder\n';
            filter += '// Generated: ' + new Date().toLocaleString() + '\n\n';
            filter += 'Attribute[Author]: Filter Builder\n';
            filter += 'Attribute[Name]: You\n';
            filter += `Attribute[Date]: ${dateStr}\n\n`;

            // Add FilterLevel declarations if enabled (only for named levels)
            if (globalSettings.enableFilterLevels) {
                const namedLevels = globalSettings.levelNames
                    .map((name, idx) => ({ name, level: idx + 1 }))
                    .filter(item => item.name);
                
                if (namedLevels.length > 0) {
                    filter += '// === FILTER LEVELS ===\n\n';
                    namedLevels.forEach(item => {
                        filter += `FilterLevel[${item.level}]: ${item.name}\n`;
                    });
                    filter += '\n';
                }
            }

            // Check if any items need custom styles (for border/background colors)
            let needsCustomStyle = false;
            
            utilityItems.forEach(item => {
                const state = filterState.utility[item.code];
                if (state.show) {
                    const needsBorder = state.useCustomColors && state.borderColor !== null;
                    const needsBackground = state.useCustomColors && state.backgroundColor !== null;
                    const needsNotification = state.chatNotification;
                    if (needsBorder || needsBackground || needsNotification) {
                        needsCustomStyle = true;
                    }
                }
            });

            runeItems.forEach(item => {
                const state = filterState.runes[item.code];
                if (state.show) {
                    const needsBorder = state.useCustomColors && state.borderColor !== null;
                    const needsBackground = state.useCustomColors && state.backgroundColor !== null;
                    const needsNotification = state.chatNotification;
                    if (needsBorder || needsBackground || needsNotification) {
                        needsCustomStyle = true;
                    }
                }
            });

            gemItems.forEach(item => {
                const state = filterState.gems[item.code];
                if (state.show) {
                    const needsBorder = state.useCustomColors && state.borderColor !== null;
                    const needsBackground = state.useCustomColors && state.backgroundColor !== null;
                    const needsNotification = state.chatNotification;
                    if (needsBorder || needsBackground || needsNotification) {
                        needsCustomStyle = true;
                    }
                }
            });

            miscItems.forEach(item => {
                const state = filterState.misc[item.code];
                if (state.show) {
                    const needsBorder = state.useCustomColors && state.borderColor !== null;
                    const needsBackground = state.useCustomColors && state.backgroundColor !== null;
                    const needsNotification = state.chatNotification;
                    if (needsBorder || needsBackground || needsNotification) {
                        needsCustomStyle = true;
                    }
                }
            });

            // Generate single ItemStyle declaration if needed
            if (needsCustomStyle) {
                filter += '// === CUSTOM STYLE ===\n\n';
                filter += 'ItemStyle[CustomDisplay]: NotificationColor = WHITE\n\n';
            }

            // Utility items
            filter += '// === UTILITY ITEMS ===\n\n';
            utilityItems.forEach(item => {
                const state = filterState.utility[item.code];
                if (state.show) {
                    // Generate filter level condition if enabled
                    const filtLvlCondition = generateFilterLevelCondition(state.filterLevels);
                    let line = `ItemDisplay[${item.code}${filtLvlCondition}]:`;
                    
                    // Only add colors if custom colors are enabled
                    if (state.useCustomColors && state.fontColor !== 'WHITE') {
                        line += ` %${state.fontColor}%`;
                    }
                    
                    if (state.biggerClickbox) {
                        line += ` %NL%       %NAME%       %NL%%NL%`;
                    } else {
                        line += ` %NAME%`;
                    }
                    
                    // Add style reference for border/background/notification if needed
                    if (state.useCustomColors || state.chatNotification) {
                        const needsBorder = state.useCustomColors && state.borderColor !== null;
                        const needsBackground = state.useCustomColors && state.backgroundColor !== null;
                        const needsNotification = state.chatNotification;
                        
                        if (needsBorder || needsBackground || needsNotification) {
                            const rgbParts = [];
                            if (needsNotification) {
                                rgbParts.push(`NotificationColor = ${state.fontColor}`);
                            }
                            if (needsBorder) {
                                const rgb = hexToRGBSlash(state.borderColor);
                                rgbParts.push(`BorderColor = RGB(${rgb}), BorderSize = 3`);
                            }
                            if (needsBackground) {
                                const rgb = hexToRGBSlash(state.backgroundColor);
                                rgbParts.push(`BackgroundColor = RGB(${rgb})`);
                            }
                            line += ` <:CustomDisplay: ${rgbParts.join(', ')}:>`;
                        }
                    }
                    
                    filter += line + '\n';
                } else {
                    filter += `ItemDisplay[${item.code}]:\n`;
                }
            });

            // Runes
            filter += '\n// === RUNES ===\n\n';
            runeItems.forEach(item => {
                const state = filterState.runes[item.code];
                if (state.show) {
                    // Generate filter level condition if enabled
                    const filtLvlCondition = generateFilterLevelCondition(state.filterLevels);
                    let line = `ItemDisplay[${item.code}${filtLvlCondition}]:`;
                    
                    // Only add colors if custom colors are enabled
                    if (state.useCustomColors && state.fontColor !== 'ORANGE') {
                        line += ` %${state.fontColor}%`;
                    }
                    
                    if (state.biggerClickbox) {
                        line += ` %NL%       %NAME%       %NL%%NL%`;
                    } else {
                        line += ` %NAME%`;
                    }
                    
                    // Add style reference for border/background/notification if needed
                    if (state.useCustomColors || state.chatNotification) {
                        const needsBorder = state.useCustomColors && state.borderColor !== null;
                        const needsBackground = state.useCustomColors && state.backgroundColor !== null;
                        const needsNotification = state.chatNotification;
                        
                        if (needsBorder || needsBackground || needsNotification) {
                            const rgbParts = [];
                            if (needsNotification) {
                                rgbParts.push(`NotificationColor = ${state.fontColor}`);
                            }
                            if (needsBorder) {
                                const rgb = hexToRGBSlash(state.borderColor);
                                rgbParts.push(`BorderColor = RGB(${rgb}), BorderSize = 3`);
                            }
                            if (needsBackground) {
                                const rgb = hexToRGBSlash(state.backgroundColor);
                                rgbParts.push(`BackgroundColor = RGB(${rgb})`);
                            }
                            line += ` <:CustomDisplay: ${rgbParts.join(', ')}:>`;
                        }
                    }
                    
                    filter += line + '\n';
                } else {
                    filter += `ItemDisplay[${item.code}]:\n`;
                }
            });

            // Gems
            filter += '\n// === GEMS ===\n\n';
            gemItems.forEach(item => {
                const state = filterState.gems[item.code];
                if (state.show) {
                    // Generate filter level condition if enabled
                    const filtLvlCondition = generateFilterLevelCondition(state.filterLevels);
                    let line = `ItemDisplay[${item.code}${filtLvlCondition}]:`;
                    
                    // Only add colors if custom colors are enabled
                    if (state.useCustomColors && state.fontColor !== 'WHITE') {
                        line += ` %${state.fontColor}%`;
                    }
                    
                    if (state.biggerClickbox) {
                        line += ` %NL%       %NAME%       %NL%%NL%`;
                    } else {
                        line += ` %NAME%`;
                    }
                    
                    // Add style reference for border/background/notification if needed
                    if (state.useCustomColors || state.chatNotification) {
                        const needsBorder = state.useCustomColors && state.borderColor !== null;
                        const needsBackground = state.useCustomColors && state.backgroundColor !== null;
                        const needsNotification = state.chatNotification;
                        
                        if (needsBorder || needsBackground || needsNotification) {
                            const rgbParts = [];
                            if (needsNotification) {
                                rgbParts.push(`NotificationColor = ${state.fontColor}`);
                            }
                            if (needsBorder) {
                                const rgb = hexToRGBSlash(state.borderColor);
                                rgbParts.push(`BorderColor = RGB(${rgb}), BorderSize = 3`);
                            }
                            if (needsBackground) {
                                const rgb = hexToRGBSlash(state.backgroundColor);
                                rgbParts.push(`BackgroundColor = RGB(${rgb})`);
                            }
                            line += ` <:CustomDisplay: ${rgbParts.join(', ')}:>`;
                        }
                    }
                    
                    filter += line + '\n';
                } else {
                    filter += `ItemDisplay[${item.code}]:\n`;
                }
            });

            // PoD/Misc Items
            filter += '\n// === POD/Keys/Maps/MISC ITEMS ===\n\n';
            miscItems.forEach(item => {
                const state = filterState.misc[item.code];
                if (state.show) {
                    // Generate filter level condition if enabled
                    const filtLvlCondition = generateFilterLevelCondition(state.filterLevels);
                    let line = `ItemDisplay[${item.code}${filtLvlCondition}]:`;
                    
                    // Only add colors if custom colors are enabled
                    if (state.useCustomColors && state.fontColor !== 'PURPLE') {
                        line += ` %${state.fontColor}%`;
                    }
                    
                    if (state.biggerClickbox) {
                        line += ` %NL%       %NAME%       %NL%%NL%`;
                    } else {
                        line += ` %NAME%`;
                    }
                    
                    // Add style reference for border/background/notification if needed
                    if (state.useCustomColors || state.chatNotification) {
                        const needsBorder = state.useCustomColors && state.borderColor !== null;
                        const needsBackground = state.useCustomColors && state.backgroundColor !== null;
                        const needsNotification = state.chatNotification;
                        
                        if (needsBorder || needsBackground || needsNotification) {
                            const rgbParts = [];
                            if (needsNotification) {
                                rgbParts.push(`NotificationColor = ${state.fontColor}`);
                            }
                            if (needsBorder) {
                                const rgb = hexToRGBSlash(state.borderColor);
                                rgbParts.push(`BorderColor = RGB(${rgb}), BorderSize = 3`);
                            }
                            if (needsBackground) {
                                const rgb = hexToRGBSlash(state.backgroundColor);
                                rgbParts.push(`BackgroundColor = RGB(${rgb})`);
                            }
                            line += ` <:CustomDisplay: ${rgbParts.join(', ')}:>`;
                        }
                    }
                    
                    filter += line + '\n';
                } else {
                    filter += `ItemDisplay[${item.code}]:\n`;
                }
            });

            // === UNIQUE ITEMS ===
            filter += '\n// === UNIQUE ITEMS ===\n\n';
            
            // Helper function to generate unique item filter lines
            function generateUniqueItemLines(items, stateCategory, sectionTitle) {
                let lines = `// ${sectionTitle}\n`;
                let hasItems = false;
                
                items.forEach(item => {
                    const key = item.name.replace(/[^a-zA-Z0-9]/g, '_');
                    const state = filterState[stateCategory][key];
                    if (state.show) {
                        hasItems = true;
                        // Generate filter level condition if enabled
                        const filtLvlCondition = generateFilterLevelCondition(state.filterLevels);
                        let line = `ItemDisplay[UNI ${item.code}${filtLvlCondition}]:`;
                        
                        // Only add colors if custom colors are enabled
                        if (state.useCustomColors && state.fontColor !== 'DARK_GREEN') {
                            line += ` %${state.fontColor}%`;
                        }
                        
                        line += ` %NAME%`;
                        
                        // Add style reference for border/background/notification if needed
                        if (state.useCustomColors || state.chatNotification) {
                            const needsBorder = state.useCustomColors && state.borderColor !== null;
                            const needsBackground = state.useCustomColors && state.backgroundColor !== null;
                            const needsNotification = state.chatNotification;
                            
                            if (needsBorder || needsBackground || needsNotification) {
                                const rgbParts = [];
                                if (needsNotification) {
                                    rgbParts.push(`NotificationColor = ${state.fontColor}`);
                                }
                                if (needsBorder) {
                                    const rgb = hexToRGBSlash(state.borderColor);
                                    rgbParts.push(`BorderColor = RGB(${rgb}), BorderSize = 3`);
                                }
                                if (needsBackground) {
                                    const rgb = hexToRGBSlash(state.backgroundColor);
                                    rgbParts.push(`BackgroundColor = RGB(${rgb})`);
                                }
                                line += ` <:CustomDisplay: ${rgbParts.join(', ')}:>`;
                            }
                        }
                        
                        lines += line + '\n';
                    } else {
                        lines += `ItemDisplay[UNI ${item.code}]:\n`;
                    }
                });
                
                return hasItems ? lines + '\n' : '';
            }

            // Helper function to generate set item filter lines (uses SET keyword)
            function generateSetItemLines(items, stateCategory, sectionTitle) {
                let lines = `// ${sectionTitle}\n`;
                let hasItems = false;
                
                items.forEach(item => {
                    const key = item.code + '_' + item.set;
                    const state = filterState[stateCategory][key];
                    if (state.show) {
                        hasItems = true;
                        // Generate filter level condition if enabled
                        const filtLvlCondition = generateFilterLevelCondition(state.filterLevels);
                        let line = `ItemDisplay[SET ${item.code}${filtLvlCondition}]:`;
                        
                        // Only add colors if custom colors are enabled
                        if (state.useCustomColors && state.fontColor !== 'DARK_GREEN') {
                            line += ` %${state.fontColor}%`;
                        }
                        
                        line += ` %NAME%`;
                        
                        // Add style reference for border/background/notification if needed
                        if (state.useCustomColors || state.chatNotification) {
                            const needsBorder = state.useCustomColors && state.borderColor !== null;
                            const needsBackground = state.useCustomColors && state.backgroundColor !== null;
                            const needsNotification = state.chatNotification;
                            
                            if (needsBorder || needsBackground || needsNotification) {
                                const rgbParts = [];
                                if (needsNotification) {
                                    rgbParts.push(`NotificationColor = ${state.fontColor}`);
                                }
                                if (needsBorder) {
                                    const rgb = hexToRGBSlash(state.borderColor);
                                    rgbParts.push(`BorderColor = RGB(${rgb}), BorderSize = 3`);
                                }
                                if (needsBackground) {
                                    const rgb = hexToRGBSlash(state.backgroundColor);
                                    rgbParts.push(`BackgroundColor = RGB(${rgb})`);
                                }
                                line += ` <:CustomDisplay: ${rgbParts.join(', ')}:>`;
                            }
                        }
                        
                        lines += line + '\n';
                    } else {
                        lines += `ItemDisplay[SET ${item.code}]:\n`;
                    }
                });
                
                return hasItems ? lines + '\n' : '';
            }
            
            function generateMagicRareItemLines(items, stateCategory, sectionTitle, rarity) {
                let lines = `// ${sectionTitle}\n`;
                let hasItems = false;
                
                items.forEach((item, idx) => {
                    const key = item.code + '_' + idx;
                    const state = filterState[stateCategory][key];
                    if (state.show) {
                        hasItems = true;
                        // Generate filter level condition if enabled
                        const filtLvlCondition = generateFilterLevelCondition(state.filterLevels);
                        
                        // Build ILVL condition
                        let ilvlCondition = '';
                        if (item.minIlvl !== undefined && item.maxIlvl !== undefined) {
                            ilvlCondition = ` ILVL>${item.minIlvl} ILVL<${item.maxIlvl}`;
                        } else if (item.minIlvl !== undefined) {
                            ilvlCondition = ` ILVL>${item.minIlvl}`;
                        } else if (item.maxIlvl !== undefined) {
                            ilvlCondition = ` ILVL<${item.maxIlvl}`;
                        }
                        
                        let line = `ItemDisplay[${rarity} ${item.code} !ID${ilvlCondition}${filtLvlCondition}]:`;
                        
                        // Add font color
                        if (state.useCustomColors && state.fontColor) {
                            line += ` %${state.fontColor}%`;
                        } else if (rarity === 'MAG') {
                            line += ` %BLUE%`;
                        } else {
                            line += ` %YELLOW%`;
                        }
                        
                        line += ` %NAME%`;
                        
                        // Add ILVL display for magic jewelry and charms, description for others
                        if (stateCategory === 'magicJewelry' || stateCategory === 'magicCharms') {
                            line += ` %WHITE%[%ILVL%]`;
                        } else if (item.desc) {
                            line += ` {${item.desc}}`;
                        }
                        
                        // Add style reference for border/background/notification if needed
                        if (state.useCustomColors || state.chatNotification) {
                            const needsBorder = state.useCustomColors && state.borderColor !== null;
                            const needsBackground = state.useCustomColors && state.backgroundColor !== null;
                            const needsNotification = state.chatNotification;
                            
                            if (needsBorder || needsBackground || needsNotification) {
                                const rgbParts = [];
                                if (needsNotification) {
                                    const notifyColor = state.fontColor || (rarity === 'MAG' ? 'BLUE' : 'YELLOW');
                                    rgbParts.push(`NotificationColor = ${notifyColor}`);
                                }
                                if (needsBorder) {
                                    const rgb = hexToRGBSlash(state.borderColor);
                                    rgbParts.push(`BorderColor = RGB(${rgb}), BorderSize = 3`);
                                }
                                if (needsBackground) {
                                    const rgb = hexToRGBSlash(state.backgroundColor);
                                    rgbParts.push(`BackgroundColor = RGB(${rgb})`);
                                }
                                line += ` <:CustomDisplay: ${rgbParts.join(', ')}:>`;
                            }
                        }
                        
                        lines += line + '\n';
                    } else {
                        // Build hide condition
                        let ilvlCondition = '';
                        if (item.minIlvl !== undefined && item.maxIlvl !== undefined) {
                            ilvlCondition = ` ILVL>${item.minIlvl} ILVL<${item.maxIlvl}`;
                        } else if (item.minIlvl !== undefined) {
                            ilvlCondition = ` ILVL>${item.minIlvl}`;
                        } else if (item.maxIlvl !== undefined) {
                            ilvlCondition = ` ILVL<${item.maxIlvl}`;
                        }
                        lines += `ItemDisplay[${rarity} ${item.code} !ID${ilvlCondition}]:\n`;
                    }
                });
                
                return hasItems ? lines + '\n' : '';
            }
            
            function generateNmagItemLines(items, stateCategory, sectionTitle) {
                let lines = `// ${sectionTitle}\n`;
                let hasItems = false;
                
                items.forEach((item, idx) => {
                    const key = item.code + '_' + idx;
                    const state = filterState[stateCategory][key];
                    if (state.show) {
                        hasItems = true;
                        // Generate filter level condition if enabled
                        const filtLvlCondition = generateFilterLevelCondition(state.filterLevels);
                        
                        // Build socket condition
                        let sockCondition = '';
                        if (state.sockFilter.length > 0) {
                            if (state.sockFilter.length === 1) {
                                sockCondition = ` SOCK=${state.sockFilter[0]}`;
                            } else {
                                // Multiple socket values: (SOCK=3 OR SOCK=4)
                                const sockParts = state.sockFilter.map(s => `SOCK=${s}`).join(' OR ');
                                sockCondition = ` (${sockParts})`;
                            }
                        }
                        
                        // Build ED condition
                        let edCondition = '';
                        if (state.edFilter === '15') {
                            edCondition = ' ED=15';
                        } else if (state.edFilter === '14+') {
                            edCondition = ' ED>13';
                        } else if (state.edFilter === '13+') {
                            edCondition = ' ED>12';
                        } else if (state.edFilter === '12+') {
                            edCondition = ' ED>11';
                        } else if (state.edFilter === '10+') {
                            edCondition = ' ED>9';
                        }
                        
                        // Build style reference for border/background/notification if needed
                        let styleRef = '';
                        if (state.useCustomColors || state.chatNotification) {
                            const needsBorder = state.useCustomColors && state.borderColor !== null;
                            const needsBackground = state.useCustomColors && state.backgroundColor !== null;
                            const needsNotification = state.chatNotification;
                            
                            if (needsBorder || needsBackground || needsNotification) {
                                const rgbParts = [];
                                if (needsNotification) {
                                    const notifyColor = state.fontColor || 'WHITE';
                                    rgbParts.push(`NotificationColor = ${notifyColor}`);
                                }
                                if (needsBorder) {
                                    const rgb = hexToRGBSlash(state.borderColor);
                                    rgbParts.push(`BorderColor = RGB(${rgb}), BorderSize = 3`);
                                }
                                if (needsBackground) {
                                    const rgb = hexToRGBSlash(state.backgroundColor);
                                    rgbParts.push(`BackgroundColor = RGB(${rgb})`);
                                }
                                styleRef = ` <:CustomDisplay: ${rgbParts.join(', ')}:>`;
                            }
                        }
                        
                        // Handle ETH filter - generate two lines when 'any'
                        if (state.ethFilter === 'eth-only') {
                            // ETH only - gray font for everything
                            let line = `ItemDisplay[NMAG ${item.code} ETH${sockCondition}${edCondition}${filtLvlCondition}]: %GRAY% %NAME% [%SOCKETS%]${styleRef}`;
                            lines += line + '\n';
                        } else if (state.ethFilter === 'non-eth') {
                            // Non-ETH only - white name, gray sockets
                            let line = `ItemDisplay[NMAG ${item.code} !ETH${sockCondition}${edCondition}${filtLvlCondition}]:`;
                            if (state.useCustomColors && state.fontColor) {
                                line += ` %${state.fontColor}%`;
                            } else {
                                line += ` %WHITE%`;
                            }
                            line += ` %NAME% %GRAY%[%SOCKETS%]${styleRef}`;
                            lines += line + '\n';
                        } else {
                            // 'any' - generate two lines: ETH first (gray), then non-ETH (white+gray)
                            // Line 1: ETH - all gray
                            let ethLine = `ItemDisplay[NMAG ${item.code} ETH${sockCondition}${edCondition}${filtLvlCondition}]: %GRAY% %NAME% [%SOCKETS%]${styleRef}`;
                            lines += ethLine + '\n';
                            
                            // Line 2: Non-ETH - white name, gray sockets
                            let nonEthLine = `ItemDisplay[NMAG ${item.code}${sockCondition}${edCondition}${filtLvlCondition}]:`;
                            if (state.useCustomColors && state.fontColor) {
                                nonEthLine += ` %${state.fontColor}%`;
                            } else {
                                nonEthLine += ` %WHITE%`;
                            }
                            nonEthLine += ` %NAME% %GRAY%[%SOCKETS%]${styleRef}`;
                            lines += nonEthLine + '\n';
                        }
                    } else {
                        // Build hide condition - match the show conditions
                        let ethCondition = '';
                        if (state.ethFilter === 'eth-only') {
                            ethCondition = ' ETH';
                        } else if (state.ethFilter === 'non-eth') {
                            ethCondition = ' !ETH';
                        }
                        
                        let sockCondition = '';
                        if (state.sockFilter !== 'any') {
                            sockCondition = ` SOCK=${state.sockFilter}`;
                        }
                        
                        let edCondition = '';
                        if (state.edFilter === '15') {
                            edCondition = ' ED=15';
                        } else if (state.edFilter === '14+') {
                            edCondition = ' ED>13';
                        } else if (state.edFilter === '13+') {
                            edCondition = ' ED>12';
                        } else if (state.edFilter === '12+') {
                            edCondition = ' ED>11';
                        } else if (state.edFilter === '10+') {
                            edCondition = ' ED>9';
                        }
                        
                        lines += `ItemDisplay[NMAG ${item.code}${ethCondition}${sockCondition}${edCondition}]:\n`;
                    }
                });
                
                return hasItems ? lines + '\n' : '';
            }
            
            filter += generateUniqueItemLines(jewelryAndCharms, 'jewelryCharms', 'Unique Jewelry & Charms');
            filter += generateUniqueItemLines(classSpecificUniques, 'classUniques', 'Class-Specific Uniques');
            filter += generateUniqueItemLines(eliteUniqueWeapons, 'eliteWeapons', 'Elite Unique Weapons');
            filter += generateUniqueItemLines(eliteUniqueArmor, 'eliteArmor', 'Elite Unique Armor');
            filter += generateUniqueItemLines(exceptionalUniqueWeapons, 'excWeapons', 'Exceptional Unique Weapons');
            filter += generateUniqueItemLines(exceptionalUniqueArmor, 'excArmor', 'Exceptional Unique Armor');
            filter += generateUniqueItemLines(normalUniqueWeapons, 'normWeapons', 'Normal Unique Weapons');
            filter += generateUniqueItemLines(normalUniqueArmor, 'normArmor', 'Normal Unique Armor');

            // === SET ITEMS ===
            filter += '\n// === SET ITEMS ===\n\n';
            filter += generateSetItemLines(highLevelSets, 'highSets', 'High-Level Set Items');
            filter += generateSetItemLines(midLevelSets, 'midSets', 'Mid-Level Set Items');
            filter += generateSetItemLines(lowLevelSets, 'lowSets', 'Low-Level Set Items');

            // === MAGIC ITEMS ===
            filter += '\n// === MAGIC ITEMS ===\n\n';
            filter += generateMagicRareItemLines(magicJewelry, 'magicJewelry', 'Magic Jewelry & Jewels', 'MAG');
            filter += generateMagicRareItemLines(magicCharms, 'magicCharms', 'Magic Charms', 'MAG');
            filter += generateMagicRareItemLines(magicCraftingBases, 'magicCrafting', 'Magic Crafting Bases', 'MAG');

            // === RARE ITEMS ===
            filter += '\n// === RARE ITEMS ===\n\n';
            filter += generateMagicRareItemLines(rareJewelry, 'rareJewelry', 'Rare Jewelry & Jewels', 'RARE');
            filter += generateMagicRareItemLines(rareClassItems, 'rareClassItems', 'Rare Class-Specific Items', 'RARE');
            filter += generateMagicRareItemLines(rareEliteBases, 'rareEliteBases', 'Rare Elite Bases', 'RARE');

            // === NMAG RUNEWORD BASES ===
            filter += '\n// === NMAG RUNEWORD BASES ===\n\n';
            filter += generateNmagItemLines(nmagPolearms, 'nmagPolearms', 'NMAG: Polearms (Insight, Infinity, Obedience)');
            filter += generateNmagItemLines(nmagSwords, 'nmagSwords', 'NMAG: Swords (Spirit, Grief)');
            filter += generateNmagItemLines(nmagAxes, 'nmagAxes', 'NMAG: Axes (Grief, Beast, Death)');
            filter += generateNmagItemLines(nmagMaces, 'nmagMaces', 'NMAG: Maces (BoTD, Heart of the Oak)');
            filter += generateNmagItemLines(nmagStaves, 'nmagStaves', 'NMAG: Staves (CTA, Memory');
            filter += generateNmagItemLines(nmagBows, 'nmagBows', 'NMAG: Bows (Faith, Ice, Brand, Insight)');
            filter += generateNmagItemLines(nmagLightArmor, 'nmagLightArmor', 'NMAG: Light Armor (Enigma, Fortitude, CoH)');
            filter += generateNmagItemLines(nmagHeavyArmor, 'nmagHeavyArmor', 'NMAG: Heavy Armor (Fortitude, CoH, Bramble)');
            filter += generateNmagItemLines(nmagShieldsGeneric, 'nmagShieldsGeneric', 'NMAG: Shields - Generic (Spirit, Dream, Splendor)');
            filter += generateNmagItemLines(nmagShieldsPaladin, 'nmagShieldsPaladin', 'NMAG: Shields - Paladin (Spirit, Exile)');
            filter += generateNmagItemLines(nmagHelms, 'nmagHelms', 'NMAG: Helms (Delirium, Dream)');
            filter += generateNmagItemLines(nmagClassSpecific, 'nmagClassSpecific', 'NMAG: Class-Specific');

            // === FILTER CLOSING ===
            if (globalSettings.hideJunk) {
                filter += '\n// Hide junk items\n';
                filter += 'ItemDisplay[(ARMOR OR WEAPON) INF]:\n';
            }
            if (globalSettings.showAll) {
                filter += '\n// Show all remaining items\n';
                filter += 'ItemDisplay[]: %NAME%\n';
            }

            document.getElementById('filter-output').value = filter;
            updateOutputStats();
        }

        // Helper function to generate FILTLVL condition from filterLevels array
        function generateFilterLevelCondition(filterLevels) {
            if (!globalSettings.enableFilterLevels) return '';
            
            // Check if all levels are enabled
            const enabledLevels = filterLevels.map((enabled, idx) => enabled ? idx + 1 : null).filter(l => l !== null);
            if (enabledLevels.length === 10) return ''; // All levels, no condition needed
            if (enabledLevels.length === 0) return ''; // None enabled, item won't show anyway
            
            // Find consecutive ranges
            const ranges = [];
            let rangeStart = enabledLevels[0];
            let rangeEnd = enabledLevels[0];
            
            for (let i = 1; i <= enabledLevels.length; i++) {
                const currentLevel = enabledLevels[i];
                
                if (currentLevel === rangeEnd + 1) {
                    rangeEnd = currentLevel;
                } else {
                    // End of range, save it
                    if (rangeStart === rangeEnd) {
                        ranges.push(`FILTERLVL=${rangeStart}`);
                    } else if (rangeEnd === rangeStart + 1) {
                        ranges.push(`FILTERLVL=${rangeStart}`);
                        ranges.push(`FILTERLVL=${rangeEnd}`);
                    } else {
                        ranges.push(`FILTERLVL>=${rangeStart} FILTERLVL<=${rangeEnd}`);
                    }
                    
                    if (i < enabledLevels.length) {
                        rangeStart = currentLevel;
                        rangeEnd = currentLevel;
                    }
                }
            }
            
            // If multiple ranges/levels, we need multiple ItemDisplay lines or complex conditions
            // For simplicity, return conditions that can be combined with OR logic
            return ranges.length > 0 ? ' ' + ranges.join(' OR ') : '';
        }

        // Convert hex color to RGB format for filter
        function hexToRGB(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `${r} ${g} ${b}`;
        }

        // Convert hex color to RGB(r/g/b) format for ItemStyle
        function hexToRGBSlash(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `${r}/${g}/${b}`;
        }

        // Update output statistics
        function updateOutputStats() {
            const output = document.getElementById('filter-output').value;
            const lines = output.split('\n').length;
            const chars = output.length;
            document.getElementById('line-count').textContent = lines;
            document.getElementById('char-count').textContent = chars;
        }

        // Highlight and scroll to item in output
        function highlightItemInOutput(itemCode, prefix = null) {
            const textarea = document.getElementById('filter-output');
            const text = textarea.value;
            
            // Build pattern based on whether we have a prefix
            let pattern;
            if (prefix) {
                // Search for specific prefixed item: ItemDisplay[NMAG 7s8]:
                pattern = new RegExp(`ItemDisplay\\[${prefix} ${itemCode}[^\\]]*\\]:`, 'i');
            } else {
                // Search for simple item: ItemDisplay[r01]:
                pattern = new RegExp(`ItemDisplay\\[${itemCode}[^\\]]*\\]:`, 'i');
            }
            
            const match = text.match(pattern);
            
            if (match) {
                const startPos = match.index;
                const endPos = startPos + match[0].length;
                
                // Use setSelectionRange to automatically scroll into view
                textarea.focus();
                textarea.setSelectionRange(startPos, endPos);
                
                // Add highlight effect
                textarea.classList.add('highlight-active');
                
                // Remove selection and highlight after a moment
                setTimeout(() => {
                    textarea.setSelectionRange(endPos, endPos); // Move cursor to end, removing selection
                    textarea.blur(); // Remove focus
                }, 300);
                
                setTimeout(() => {
                    textarea.classList.remove('highlight-active');
                }, 1000);
            }
        }

        // Modal Management Functions
        let currentModalItem = null;

        function openItemSettings(category, itemKey, itemName, itemType = 'unique') {
            currentModalItem = { category, itemKey, itemType };
            
            const modal = document.getElementById('itemSettingsModal');
            const modalTitle = document.getElementById('modalItemName');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = itemName;
            
            // Populate modal with appropriate controls
            modalBody.innerHTML = generateModalContent(category, itemKey, itemType);
            
            modal.classList.add('show');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function closeItemSettings(event) {
            // Only close if clicking overlay or close button
            if (event && event.target.closest('.modal-container') && !event.target.classList.contains('modal-close')) {
                return;
            }
            
            const modal = document.getElementById('itemSettingsModal');
            modal.classList.remove('show');
            document.body.style.overflow = ''; // Restore scrolling
            currentModalItem = null;
        }

        function generateModalContent(category, itemKey, itemType) {
            const state = filterState[category]?.[itemKey] || {};
            let html = '';

            // NMAG-specific controls
            if (itemType === 'nmag') {
                // Eth Filter
                html += '<div class="modal-section">';
                html += '<h4 class="modal-section-title">Ethereal Filter</h4>';
                html += '<div class="modal-control-group">';
                html += '<select class="modal-select" onchange="updateModalEthFilter(\'' + category + '\', \'' + itemKey + '\', this.value)">';
                const ethFilter = state.ethFilter || 'both';
                html += '<option value="both"' + (ethFilter === 'both' ? ' selected' : '') + '>Both Eth and Non-Eth</option>';
                html += '<option value="eth-only"' + (ethFilter === 'eth-only' ? ' selected' : '') + '>Ethereal Only</option>';
                html += '<option value="non-eth"' + (ethFilter === 'non-eth' ? ' selected' : '') + '>Non-Ethereal Only</option>';
                html += '</select>';
                html += '</div>';
                html += '</div>';

                // Socket Filter
                html += '<div class="modal-section">';
                html += '<h4 class="modal-section-title">Sockets</h4>';
                html += '<div class="socket-checkbox-container">';
                const sockFilter = state.sockFilter || [];
                
                // Determine max sockets from bases object in item_metadata.js
                const basesKey = state.name.replace(/ /g, '_');
                const baseItem = bases[basesKey];
                let maxSockets = baseItem?.max_sockets || 6;
                
                // Override for class-specific items if bases lookup failed
                if (category === 'nmagClassSpecific') {
                    if (itemKey === 'CL2') {
                        maxSockets = 2; // Necro Shrunken Heads
                    } else if (itemKey === 'CL1' || itemKey === 'CL5' || itemKey === 'WP11') {
                        maxSockets = 3; // Druid Pelts, Assassin Claws, Sorceress Orbs
                    }
                }
                
                ['0', '2', '3', '4', '5', '6'].filter(sock => parseInt(sock) <= maxSockets).forEach(sock => {
                    const checked = sockFilter.includes(sock) ? 'checked' : '';
                    const label = sock === '0' ? '0 Sockets' : `${sock} Socket${parseInt(sock) > 1 ? 's' : ''}`;
                    html += `
                        <label class="socket-checkbox-label">
                            <input type="checkbox" ${checked} 
                                onchange="updateModalSocket('${category}', '${itemKey}', '${sock}', this.checked)">
                            <span>${label}</span>
                        </label>
                    `;
                });
                html += '</div>';
                html += '</div>';

                // ED Filter
                html += '<div class="modal-section">';
                html += '<h4 class="modal-section-title">Enhanced Damage</h4>';
                html += '<div class="modal-control-group">';
                html += '<select class="modal-select" onchange="updateModalEDFilter(\'' + category + '\', \'' + itemKey + '\', this.value)">';
                const edFilter = state.edFilter || 'any';
                html += '<option value="any"' + (edFilter === 'any' ? ' selected' : '') + '>Any ED</option>';
                html += '<option value="10+"' + (edFilter === '10+' ? ' selected' : '') + '>10% ED or higher</option>';
                html += '<option value="12+"' + (edFilter === '12+' ? ' selected' : '') + '>12% ED or higher</option>';
                html += '<option value="13+"' + (edFilter === '13+' ? ' selected' : '') + '>13% ED or higher</option>';
                html += '<option value="14+"' + (edFilter === '14+' ? ' selected' : '') + '>14% ED or higher</option>';
                html += '<option value="15"' + (edFilter === '15' ? ' selected' : '') + '>15% ED only</option>';
                html += '</select>';
                html += '</div>';
                html += '</div>';
            }

            // Custom Colors Section
            html += '<div class="modal-section">';
            html += '<h4 class="modal-section-title">Custom Colors</h4>';
            html += '<div class="modal-control-group">';
            
            // Custom colors toggle
            const customEnabled = state.useCustomColors ? 'checked' : '';
            html += `
                <label class="modal-checkbox-label">
                    <input type="checkbox" ${customEnabled} 
                        onchange="toggleModalCustomColor('${category}', '${itemKey}', this.checked, '${itemType}')">
                    <span>Enable Custom Colors</span>
                </label>
            `;

            if (state.useCustomColors) {
                // Font Color
                html += '<div class="modal-color-row">';
                html += '<span class="modal-color-label">Font Color:</span>';
                html += '<select class="modal-select" onchange="updateModalFontColor(\'' + category + '\', \'' + itemKey + '\', this.value, \'' + itemType + '\')">';
                html += '<option value="">Default</option>';
                FONT_COLORS.forEach(fc => {
                    const selected = state.fontColor === fc ? 'selected' : '';
                    html += `<option value="${fc}" ${selected}>${fc}</option>`;
                });
                html += '</select>';
                html += '<button class="modal-clear-btn" onclick="clearModalFontColor(\'' + category + '\', \'' + itemKey + '\', \'' + itemType + '\')">Clear</button>';
                html += '</div>';

                // Border Color
                html += '<div class="modal-color-row">';
                html += '<span class="modal-color-label">Border Color:</span>';
                const borderColor = state.borderColor || '#ffffff';
                html += '<input type="color" class="modal-color-input" value="' + borderColor + '" ';
                html += 'onchange="updateModalBorderColor(\'' + category + '\', \'' + itemKey + '\', this.value, \'' + itemType + '\')">';
                html += '<button class="modal-clear-btn" onclick="clearModalBorderColor(\'' + category + '\', \'' + itemKey + '\', \'' + itemType + '\')">Clear</button>';
                html += '</div>';

                // Background Color
                html += '<div class="modal-color-row">';
                html += '<span class="modal-color-label">Background Color:</span>';
                const bgColor = state.backgroundColor || '#000000';
                html += '<input type="color" class="modal-color-input" value="' + bgColor + '" ';
                html += 'onchange="updateModalBackgroundColor(\'' + category + '\', \'' + itemKey + '\', this.value, \'' + itemType + '\')">';
                html += '<button class="modal-clear-btn" onclick="clearModalBackgroundColor(\'' + category + '\', \'' + itemKey + '\', \'' + itemType + '\')">Clear</button>';
                html += '</div>';
            }
            
            html += '</div>';
            html += '</div>';

            // Notify Section
            html += '<div class="modal-section">';
            html += '<h4 class="modal-section-title">Notifications</h4>';
            html += '<div class="modal-control-group">';
            const notifyChecked = state.chatNotification ? 'checked' : '';
            html += `
                <label class="modal-checkbox-label">
                    <input type="checkbox" ${notifyChecked} 
                        onchange="updateModalNotify('${category}', '${itemKey}', this.checked, '${itemType}')">
                    <span>Enable chat notification when this item drops</span>
                </label>
            `;
            html += '</div>';
            html += '</div>';

            // Display Options Section
            html += '<div class="modal-section">';
            html += '<h4 class="modal-section-title">Display Options</h4>';
            html += '<div class="modal-control-group">';
            const clickboxChecked = state.biggerClickbox ? 'checked' : '';
            html += `
                <label class="modal-checkbox-label">
                    <input type="checkbox" ${clickboxChecked} 
                        onchange="updateModalBiggerClickbox('${category}', '${itemKey}', this.checked, '${itemType}')">
                    <span>Bigger clickbox (adds spacing around item name)</span>
                </label>
            `;
            html += '</div>';
            html += '</div>';

            return html;
        }

        // Modal update functions
        function updateModalFilterLevel(category, itemKey, levelIndex, checked, itemType) {
            if (!filterState[category]) filterState[category] = {};
            if (!filterState[category][itemKey]) filterState[category][itemKey] = { show: true, filterLevels: [] };
            if (!filterState[category][itemKey].filterLevels) filterState[category][itemKey].filterLevels = [];
            
            filterState[category][itemKey].filterLevels[levelIndex] = checked;
            generateFilter();

            // Get item code for highlighting
            const item = findItemByKey(category, itemKey);
            if (item) {
                const prefix = getItemPrefix(itemType);
                setTimeout(() => highlightItemInOutput(item.code, prefix), 100);
            }
        }

        function setAllModalLevels(category, itemKey, checked, itemType) {
            if (!filterState[category]) filterState[category] = {};
            if (!filterState[category][itemKey]) filterState[category][itemKey] = { show: true, filterLevels: [] };
            if (!filterState[category][itemKey].filterLevels) filterState[category][itemKey].filterLevels = [];
            
            for (let i = 0; i < 10; i++) {
                filterState[category][itemKey].filterLevels[i] = checked;
            }
            
            // Refresh modal content
            openItemSettings(category, itemKey, document.getElementById('modalItemName').textContent, itemType);
            generateFilter();

            const item = findItemByKey(category, itemKey);
            if (item) {
                const prefix = getItemPrefix(itemType);
                setTimeout(() => highlightItemInOutput(item.code, prefix), 100);
            }
        }

        function toggleModalCustomColor(category, itemKey, checked, itemType) {
            if (!filterState[category]) filterState[category] = {};
            if (!filterState[category][itemKey]) filterState[category][itemKey] = { show: true };
            
            filterState[category][itemKey].useCustomColors = checked;
            
            // Refresh modal to show/hide color controls
            openItemSettings(category, itemKey, document.getElementById('modalItemName').textContent, itemType);
            generateFilter();

            const item = findItemByKey(category, itemKey);
            if (item) {
                const prefix = getItemPrefix(itemType);
                setTimeout(() => highlightItemInOutput(item.code, prefix), 100);
            }
        }

        function updateModalFontColor(category, itemKey, color, itemType) {
            if (!filterState[category]) filterState[category] = {};
            if (!filterState[category][itemKey]) filterState[category][itemKey] = { shown: true };
            
            filterState[category][itemKey].fontColor = color;
            generateFilter();

            const item = findItemByKey(category, itemKey);
            if (item) {
                const prefix = getItemPrefix(itemType);
                setTimeout(() => highlightItemInOutput(item.code, prefix), 100);
            }
        }

        function clearModalFontColor(category, itemKey, itemType) {
            updateModalFontColor(category, itemKey, '', itemType);
            openItemSettings(category, itemKey, document.getElementById('modalItemName').textContent, itemType);
        }

        function updateModalBorderColor(category, itemKey, color, itemType) {
            if (!filterState[category]) filterState[category] = {};
            if (!filterState[category][itemKey]) filterState[category][itemKey] = { shown: true };
            
            filterState[category][itemKey].borderColor = color;
            generateFilter();

            const item = findItemByKey(category, itemKey);
            if (item) {
                const prefix = getItemPrefix(itemType);
                setTimeout(() => highlightItemInOutput(item.code, prefix), 100);
            }
        }

        function clearModalBorderColor(category, itemKey, itemType) {
            if (filterState[category]?.[itemKey]) {
                delete filterState[category][itemKey].borderColor;
            }
            openItemSettings(category, itemKey, document.getElementById('modalItemName').textContent, itemType);
            generateFilter();

            const item = findItemByKey(category, itemKey);
            if (item) {
                const prefix = getItemPrefix(itemType);
                setTimeout(() => highlightItemInOutput(item.code, prefix), 100);
            }
        }

        function updateModalBackgroundColor(category, itemKey, color, itemType) {
            if (!filterState[category]) filterState[category] = {};
            if (!filterState[category][itemKey]) filterState[category][itemKey] = { shown: true };
            
            filterState[category][itemKey].backgroundColor = color;
            generateFilter();

            const item = findItemByKey(category, itemKey);
            if (item) {
                const prefix = getItemPrefix(itemType);
                setTimeout(() => highlightItemInOutput(item.code, prefix), 100);
            }
        }

        function clearModalBackgroundColor(category, itemKey, itemType) {
            if (filterState[category]?.[itemKey]) {
                delete filterState[category][itemKey].backgroundColor;
            }
            openItemSettings(category, itemKey, document.getElementById('modalItemName').textContent, itemType);
            generateFilter();

            const item = findItemByKey(category, itemKey);
            if (item) {
                const prefix = getItemPrefix(itemType);
                setTimeout(() => highlightItemInOutput(item.code, prefix), 100);
            }
        }

        function updateModalNotify(category, itemKey, checked, itemType) {
            if (!filterState[category]) filterState[category] = {};
            if (!filterState[category][itemKey]) filterState[category][itemKey] = { show: true };
            
            filterState[category][itemKey].chatNotification = checked;
            generateFilter();

            const item = findItemByKey(category, itemKey);
            if (item) {
                const prefix = getItemPrefix(itemType);
                setTimeout(() => highlightItemInOutput(item.code, prefix), 100);
            }
        }

        function updateModalBiggerClickbox(category, itemKey, checked, itemType) {
            if (!filterState[category]) filterState[category] = {};
            if (!filterState[category][itemKey]) filterState[category][itemKey] = { show: true };
            
            filterState[category][itemKey].biggerClickbox = checked;
            generateFilter();

            const item = findItemByKey(category, itemKey);
            if (item) {
                const prefix = getItemPrefix(itemType);
                setTimeout(() => highlightItemInOutput(item.code, prefix), 100);
            }
        }

        // NMAG-specific modal functions
        function updateModalEthFilter(category, itemKey, value) {
            if (!filterState[category]) filterState[category] = {};
            if (!filterState[category][itemKey]) filterState[category][itemKey] = { shown: true };
            
            filterState[category][itemKey].ethFilter = value;
            generateFilter();

            const item = findItemByKey(category, itemKey);
            if (item) {
                setTimeout(() => highlightItemInOutput(item.code, 'NMAG'), 100);
            }
        }

        function updateModalSocket(category, itemKey, socketValue, checked) {
            if (!filterState[category]) filterState[category] = {};
            if (!filterState[category][itemKey]) filterState[category][itemKey] = { show: true, sockFilter: [] };
            if (!filterState[category][itemKey].sockFilter) filterState[category][itemKey].sockFilter = [];
            
            if (checked) {
                // Add socket value if not already present
                if (!filterState[category][itemKey].sockFilter.includes(socketValue)) {
                    filterState[category][itemKey].sockFilter.push(socketValue);
                }
            } else {
                // Remove socket value
                const index = filterState[category][itemKey].sockFilter.indexOf(socketValue);
                if (index > -1) {
                    filterState[category][itemKey].sockFilter.splice(index, 1);
                }
            }
            
            generateFilter();

            const item = findItemByKey(category, itemKey);
            if (item) {
                setTimeout(() => highlightItemInOutput(item.code, 'NMAG'), 100);
            }
        }

        function updateModalEDFilter(category, itemKey, value) {
            if (!filterState[category]) filterState[category] = {};
            if (!filterState[category][itemKey]) filterState[category][itemKey] = { shown: true };
            
            filterState[category][itemKey].edFilter = value;
            generateFilter();

            const item = findItemByKey(category, itemKey);
            if (item) {
                setTimeout(() => highlightItemInOutput(item.code, 'NMAG'), 100);
            }
        }

        // Helper functions
        function findItemByKey(category, itemKey) {
            // For simple categories (utility, runes, gems, misc), itemKey is the code
            const simpleCategoriesMap = {
                'utility': utilityItems,
                'runes': runeItems,
                'gems': gemItems,
                'misc': miscItems
            };
            
            if (simpleCategoriesMap[category]) {
                return simpleCategoriesMap[category].find(item => item.code === itemKey);
            }
            
            // For complex categories, look up by sanitized name or code
            const items = window[category];
            if (!items) return null;
            return items.find(item => {
                const sanitized = item.name.replace(/[\s']/g, '_');
                return sanitized === itemKey || item.code === itemKey;
            });
        }

        function getItemPrefix(itemType) {
            const prefixMap = {
                'unique': 'UNI',
                'set': 'SET',
                'magic': 'MAG',
                'rare': 'RARE',
                'nmag': 'NMAG'
            };
            return prefixMap[itemType] || null;
        }

        // Export filter
        function exportFilter() {
            const output = document.getElementById('filter-output').value;
            const blob = new Blob([output], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'FilterPhoenix_' + Date.now() + '.filter';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Copy to clipboard
        function copyToClipboard() {
            const output = document.getElementById('filter-output');
            output.select();
            document.execCommand('copy');
            alert('Filter copied to clipboard!');
        }

        // Import filter
        function importFilter(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                document.getElementById('filter-output').value = content;
                // TODO: Parse filter and update UI state
                updateOutputStats();
                alert('Filter imported! Manual parsing not yet implemented - you can edit the text directly.');
            };
            reader.readAsText(file);
        }

        // Allow manual edits to update stats
        document.getElementById('filter-output').addEventListener('input', updateOutputStats);

        // Toggle filter levels feature
        function toggleFilterLevels(enabled) {
            globalSettings.enableFilterLevels = enabled;
            const configSection = document.getElementById('filter-levels-config');
            
            if (enabled) {
                configSection.classList.add('active');
                renderLevelNamesConfig();
            } else {
                configSection.classList.remove('active');
            }
            
            // Re-render all sections to update UI
            renderUtilityItems();
            renderRuneItems();
            renderGemsItems();
            renderMiscItems();
            renderJewelryCharmsItems();
            renderClassUniquesItems();
            renderEliteWeaponsItems();
            renderEliteArmorItems();
            renderExcWeaponsItems();
            renderExcArmorItems();
            renderNormWeaponsItems();
            renderNormArmorItems();
            renderHighSetsItems();
            renderMidSetsItems();
            renderLowSetsItems();
            renderMagicJewelryItems();
            renderMagicCharmsItems();
            renderMagicCraftingItems();
            renderRareJewelryItems();
            renderRareClassItemsItems();
            renderRareEliteBasesItems();
            renderNmagPolearmsItems();
            renderNmagSwordsItems();
            renderNmagAxesItems();
            renderNmagMacesItems();
            renderNmagStavesItems();
            renderNmagBowsItems();
            renderNmagLightArmorItems();
            renderNmagHeavyArmorItems();
            renderNmagShieldsGenericItems();
            renderNmagShieldsPaladinItems();
            renderNmagHelmsItems();
            renderNmagClassSpecificItems();
            generateFilter();
        }

        // Toggle Hide Junk setting
        function toggleHideJunk(enabled) {
            globalSettings.hideJunk = enabled;
            generateFilter();
        }

        // Toggle Show All setting
        function toggleShowAll(enabled) {
            globalSettings.showAll = enabled;
            generateFilter();
        }

        // Render level names configuration inputs
        function renderLevelNamesConfig() {
            const container = document.getElementById('level-names-grid');
            container.innerHTML = '';
            
            for (let i = 0; i < 10; i++) {
                const wrapper = document.createElement('div');
                wrapper.className = 'level-name-input';
                wrapper.innerHTML = `
                    <label>Level ${i + 1}</label>
                    <input type="text" 
                        value="${globalSettings.levelNames[i]}" 
                        onchange="updateLevelName(${i}, this.value)"
                        placeholder="Level ${i + 1}">
                `;
                container.appendChild(wrapper);
            }
        }

        // Update level name
        function updateLevelName(level, name) {
            globalSettings.levelNames[level] = name.trim();
            // Re-render all sections to update checkboxes visibility
            renderUtilityItems();
            renderRuneItems();
            renderGemsItems();
            renderMiscItems();
            renderJewelryCharmsItems();
            renderClassUniquesItems();
            renderEliteWeaponsItems();
            renderEliteArmorItems();
            renderExcWeaponsItems();
            renderExcArmorItems();
            renderNormWeaponsItems();
            renderNormArmorItems();
            renderHighSetsItems();
            renderMidSetsItems();
            renderLowSetsItems();
            renderMagicJewelryItems();
            renderMagicCharmsItems();
            renderMagicCraftingItems();
            renderRareJewelryItems();
            renderRareClassItemsItems();
            renderRareEliteBasesItems();
            renderNmagPolearmsItems();
            renderNmagSwordsItems();
            renderNmagAxesItems();
            renderNmagMacesItems();
            renderNmagStavesItems();
            renderNmagBowsItems();
            renderNmagLightArmorItems();
            renderNmagHeavyArmorItems();
            renderNmagShieldsGenericItems();
            renderNmagShieldsPaladinItems();
            renderNmagHelmsItems();
            renderNmagClassSpecificItems();
            generateFilter();
        }

        // Update item filter level
        function updateItemLevel(category, code, level, checked) {
            filterState[category][code].filterLevels[level] = checked;
            generateFilter();
            setTimeout(() => highlightItemInOutput(code), 100);
        }

        // Set all levels for an item
        function setAllLevels(category, code, checked) {
            for (let i = 0; i < 10; i++) {
                filterState[category][code].filterLevels[i] = checked;
            }
            // Re-render the appropriate section to update checkboxes
            if (category === 'jewelryCharms') {
                renderJewelryCharmsItems();
            } else if (category === 'utility') {
                renderUtilityItems();
            } else if (category === 'runes') {
                renderRuneItems();
            } else if (category === 'gems') {
                renderGemsItems();
            } else if (category === 'misc') {
                renderMiscItems();
            } else if (category === 'classUniques') {
                renderClassUniquesItems();
            } else if (category === 'eliteWeapons') {
                renderEliteWeaponsItems();
            } else if (category === 'eliteArmor') {
                renderEliteArmorItems();
            } else if (category === 'excWeapons') {
                renderExcWeaponsItems();
            } else if (category === 'excArmor') {
                renderExcArmorItems();
            } else if (category === 'normWeapons') {
                renderNormWeaponsItems();
            } else if (category === 'normArmor') {
                renderNormArmorItems();
            }
            generateFilter();
        }

        // Initialize
        renderUtilityItems();
        renderRuneItems();
        renderGemsItems();
        renderMiscItems();
        renderJewelryCharmsItems();
        renderClassUniquesItems();
        renderEliteWeaponsItems();
        renderEliteArmorItems();
        renderExcWeaponsItems();
        renderExcArmorItems();
        renderNormWeaponsItems();
        renderNormArmorItems();
        renderHighSetsItems();
        renderMidSetsItems();
        renderLowSetsItems();
        renderMagicJewelryItems();
        renderMagicCharmsItems();
        renderMagicCraftingItems();
        renderRareJewelryItems();
        renderRareClassItemsItems();
        renderRareEliteBasesItems();
        renderNmagPolearmsItems();
        renderNmagSwordsItems();
        renderNmagAxesItems();
        renderNmagMacesItems();
        renderNmagStavesItems();
        renderNmagBowsItems();
        renderNmagLightArmorItems();
        renderNmagHeavyArmorItems();
        renderNmagShieldsGenericItems();
        renderNmagShieldsPaladinItems();
        renderNmagHelmsItems();
        renderNmagClassSpecificItems();
        generateFilter();
    </script>

    <!-- Item Settings Modal -->
    <div class="modal-overlay" id="itemSettingsModal" onclick="closeItemSettings(event)">
        <div class="modal-container" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title" id="modalItemName"></h3>
                <button class="modal-close" onclick="closeItemSettings()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be populated dynamically -->
            </div>
        </div>
    </div>
</body>
</html>
