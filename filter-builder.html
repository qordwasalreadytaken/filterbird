<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FilterPhoenix - Visual Filter Builder</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: #1a1a1a;
            color: #e0e0e0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: #2a2a2a;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        h1 {
            margin: 0 0 10px 0;
            color: #fff;
        }

        .subtitle {
            color: #999;
            font-size: 14px;
        }

        .layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
        }

        .editor-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .section {
            background: #2a2a2a;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .section-header {
            padding: 15px 20px;
            background: #333;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            border-bottom: 1px solid #444;
        }

        .section-header:hover {
            background: #3a3a3a;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
        }

        .section-toggle {
            font-size: 20px;
            color: #999;
            transition: transform 0.2s;
        }

        .section.expanded .section-toggle {
            transform: rotate(90deg);
        }

        .section-content {
            display: none;
            padding: 15px 20px;
        }

        .section.expanded .section-content {
            display: block;
        }

        .preset-controls {
            margin-bottom: 15px;
            padding: 10px;
            background: #252525;
            border-radius: 4px;
        }

        .preset-controls label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            color: #aaa;
        }

        .preset-select {
            width: 100%;
            padding: 8px;
            background: #333;
            border: 1px solid #444;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 14px;
        }

        .item-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .item-row {
            padding: 10px;
            background: #252525;
            border-radius: 4px;
            display: grid;
            grid-template-columns: auto 1fr auto auto auto auto;
            gap: 10px;
            align-items: center;
        }

        .custom-color-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .custom-label {
            font-size: 11px;
            color: #999;
        }

        .colors-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .item-row:hover {
            background: #2a2a2a;
        }

        .item-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .item-name {
            font-size: 14px;
            color: #ddd;
        }

        .color-picker-wrapper {
            display: flex;
            align-items: center;
            gap: 5px;
            position: relative;
        }

        .color-clear-btn {
            width: 18px;
            height: 18px;
            padding: 0;
            background: #444;
            border: 1px solid #555;
            border-radius: 3px;
            color: #aaa;
            cursor: pointer;
            font-size: 12px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .color-clear-btn:hover {
            background: #555;
            color: #fff;
        }

        .color-label {
            font-size: 11px;
            color: #999;
            min-width: 50px;
        }

        .color-input {
            width: 50px;
            height: 28px;
            border: 1px solid #444;
            border-radius: 3px;
            cursor: pointer;
            background: #333;
        }

        .color-select {
            width: 100px;
            height: 28px;
            padding: 4px;
            border: 1px solid #444;
            border-radius: 3px;
            background: #333;
            color: #e0e0e0;
            font-size: 11px;
            cursor: pointer;
        }

        .output-panel {
            position: sticky;
            top: 20px;
            height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
        }

        .output-section {
            background: #2a2a2a;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }

        .output-header {
            padding: 15px 20px;
            background: #333;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .output-title {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
        }

        .output-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            background: #4a4a4a;
            border: 1px solid #555;
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #555;
        }

        .btn-primary {
            background: #0066cc;
            border-color: #0066cc;
        }

        .btn-primary:hover {
            background: #0052a3;
        }

        .output-textarea {
            flex: 1;
            padding: 15px;
            background: #1a1a1a;
            border: none;
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            resize: none;
            line-height: 1.5;
        }

        .output-textarea:focus {
            outline: none;
        }

        .item-count {
            font-size: 12px;
            color: #777;
            margin-left: 5px;
        }

        /* Hide default file input */
        input[type="file"] {
            display: none;
        }

        .filter-info {
            padding: 10px 20px;
            background: #252525;
            border-top: 1px solid #444;
            font-size: 12px;
            color: #999;
        }

        .global-settings {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .global-settings h3 {
            margin: 0 0 15px 0;
            color: #fff;
            font-size: 16px;
        }

        .filter-levels-config {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #444;
        }

        .filter-levels-config.active {
            display: block;
        }

        .level-names-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .level-name-input {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .level-name-input label {
            font-size: 11px;
            color: #999;
        }

        .level-name-input input {
            padding: 6px 8px;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 3px;
            color: #e0e0e0;
            font-size: 12px;
        }

        .levels-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 10px;
        }

        .levels-selector.disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        .levels-label {
            font-size: 11px;
            color: #999;
        }

        .level-checkboxes {
            display: flex;
            gap: 4px;
        }

        .level-checkbox-wrapper {
            position: relative;
            display: inline-block;
        }

        .level-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .level-checkbox-label {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10px;
            color: #666;
            pointer-events: none;
            font-weight: bold;
        }

        .level-checkbox:checked + .level-checkbox-label {
            color: #0066cc;
        }

        .btn-link {
            background: none;
            border: none;
            color: #0066cc;
            cursor: pointer;
            font-size: 11px;
            padding: 2px 6px;
            text-decoration: underline;
        }

        .btn-link:hover {
            color: #0052a3;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>FilterPhoenix - Visual Filter Builder</h1>
            <div class="subtitle">Point-and-click interface for creating Diablo II item filters</div>
        </header>

        <div class="layout">
            <div class="editor-panel">
                <!-- Global Settings -->
                <div class="global-settings">
                    <h3>Global Settings</h3>
                    <div>
                        <label>
                            <input type="checkbox" id="enable-filter-levels" onchange="toggleFilterLevels(this.checked)">
                            Enable Filter Levels (1-10)
                        </label>
                    </div>
                    <div class="filter-levels-config" id="filter-levels-config">
                        <p style="font-size: 12px; color: #999; margin: 0 0 10px 0;">Name your filter levels (used for strictness control):</p>
                        <div class="level-names-grid" id="level-names-grid">
                            <!-- Level name inputs will be generated here -->
                        </div>
                    </div>
                </div>

                <!-- Utility Items Section -->
                <div class="section" id="utility-section">
                    <div class="section-header" onclick="toggleSection('utility-section')">
                        <div>
                            <span class="section-title">Utility Items</span>
                            <span class="item-count" id="utility-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyUtilityPreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                                <option value="essential-only">Essential Only (Potions + Scrolls)</option>
                                <option value="endgame">Endgame (Hide low potions)</option>
                            </select>
                        </div>
                        <div class="item-list" id="utility-items"></div>
                    </div>
                </div>

                <!-- Runes Section -->
                <div class="section" id="runes-section">
                    <div class="section-header" onclick="toggleSection('runes-section')">
                        <div>
                            <span class="section-title">Runes</span>
                            <span class="item-count" id="runes-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyRunePreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                                <option value="hide-low">Hide Low Runes (El-Ort)</option>
                                <option value="mid-plus">Mid+ Runes Only (Thul+)</option>
                                <option value="high-only">High Runes Only (Pul+)</option>
                            </select>
                        </div>
                        <div class="item-list" id="runes-items"></div>
                    </div>
                </div>

                <!-- Gems Section -->
                <div class="section" id="gems-section">
                    <div class="section-header" onclick="toggleSection('gems-section')">
                        <div>
                            <span class="section-title">Gems</span>
                            <span class="item-count" id="gems-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyGemPreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                                <option value="perfect-only">Perfect Only</option>
                                <option value="flawless-plus">Flawless+</option>
                                <option value="regular-plus">Regular+</option>
                            </select>
                        </div>
                        <div class="item-list" id="gems-items"></div>
                    </div>
                </div>

                <!-- PoD/Misc Section -->
                <div class="section" id="misc-section">
                    <div class="section-header" onclick="toggleSection('misc-section')">
                        <div>
                            <span class="section-title">PoD/Misc Items</span>
                            <span class="item-count" id="misc-count">(0/0 shown)</span>
                        </div>
                        <span class="section-toggle">▶</span>
                    </div>
                    <div class="section-content">
                        <div class="preset-controls">
                            <label>Quick Preset:</label>
                            <select class="preset-select" onchange="applyMiscPreset(this.value)">
                                <option value="">-- Select Preset --</option>
                                <option value="show-all">Show All</option>
                                <option value="hide-all">Hide All</option>
                                <option value="essentials">Essentials (Keys/Organs/Essences/Orbs)</option>
                            </select>
                        </div>
                        <div class="item-list" id="misc-items"></div>
                    </div>
                </div>
            </div>

            <!-- Output Panel -->
            <div class="output-panel">
                <div class="output-section">
                    <div class="output-header">
                        <span class="output-title">Filter Output</span>
                        <div class="output-actions">
                            <label for="import-file" class="btn">Import Filter</label>
                            <input type="file" id="import-file" accept=".filter" onchange="importFilter(event)">
                            <button class="btn btn-primary" onclick="exportFilter()">Export</button>
                            <button class="btn" onclick="copyToClipboard()">Copy</button>
                        </div>
                    </div>
                    <textarea class="output-textarea" id="filter-output" 
                        placeholder="Your filter will appear here... You can edit it manually."></textarea>
                    <div class="filter-info">
                        Lines: <span id="line-count">0</span> | 
                        Characters: <span id="char-count">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Available font colors for filter
        const FONT_COLORS = [
            'WHITE', 'RED', 'GREEN', 'BLUE', 'GOLD', 'GRAY', 'BLACK', 'TAN',
            'ORANGE', 'YELLOW', 'PURPLE', 'DGREEN', 'DARK_GREEN', 'BOLD',
            'CORAL', 'SAGE', 'TEAL', 'LGRAY', 'LIGHT_GRAY', 'NAVY', 'DBLUE',
            'DARK_BLUE', 'COBALT', 'DARK_PURPLE', 'DPURPLE', 'BROWN'
        ];

        // Item data
        const utilityItems = [
            { name: "Full Rejuvenation Potion", code: "rvl", category: "potion" },
            { name: "Rejuvenation Potion", code: "rvs", category: "potion" },
            { name: "Super Healing Potion", code: "hp5", category: "potion" },
            { name: "Greater Healing Potion", code: "hp4", category: "potion" },
            { name: "Healing Potion", code: "hp3", category: "potion" },
            { name: "Lesser Healing Potion", code: "hp2", category: "potion" },
            { name: "Minor Healing Potion", code: "hp1", category: "potion" },
            { name: "Super Mana Potion", code: "mp5", category: "potion" },
            { name: "Greater Mana Potion", code: "mp4", category: "potion" },
            { name: "Mana Potion", code: "mp3", category: "potion" },
            { name: "Lesser Mana Potion", code: "mp2", category: "potion" },
            { name: "Minor Mana Potion", code: "mp1", category: "potion" },
            { name: "Antidote Potion", code: "yps", category: "potion" },
            { name: "Thawing Potion", code: "wms", category: "potion" },
            { name: "Stamina Potion", code: "vps", category: "potion" },
            { name: "Tome of Town Portal", code: "tbk", category: "scroll" },
            { name: "Tome of Identify", code: "ibk", category: "scroll" },
            { name: "Scroll of Town Portal", code: "tsc", category: "scroll" },
            { name: "Scroll of Identify", code: "isc", category: "scroll" },
            { name: "Key", code: "key", category: "key" },
        ];

        const runeItems = [
            { name: "El Rune", code: "r01", level: 11, tier: 1 },
            { name: "Eld Rune", code: "r02", level: 11, tier: 1 },
            { name: "Tir Rune", code: "r03", level: 13, tier: 1 },
            { name: "Nef Rune", code: "r04", level: 13, tier: 1 },
            { name: "Eth Rune", code: "r05", level: 15, tier: 1 },
            { name: "Ith Rune", code: "r06", level: 15, tier: 1 },
            { name: "Tal Rune", code: "r07", level: 17, tier: 1 },
            { name: "Ral Rune", code: "r08", level: 19, tier: 1 },
            { name: "Ort Rune", code: "r09", level: 21, tier: 1 },
            { name: "Thul Rune", code: "r10", level: 23, tier: 2 },
            { name: "Amn Rune", code: "r11", level: 25, tier: 2 },
            { name: "Sol Rune", code: "r12", level: 27, tier: 2 },
            { name: "Shael Rune", code: "r13", level: 29, tier: 2 },
            { name: "Dol Rune", code: "r14", level: 31, tier: 2 },
            { name: "Hel Rune", code: "r15", level: 0, tier: 2 },
            { name: "Io Rune", code: "r16", level: 35, tier: 2 },
            { name: "Lum Rune", code: "r17", level: 37, tier: 2 },
            { name: "Ko Rune", code: "r18", level: 39, tier: 2 },
            { name: "Fal Rune", code: "r19", level: 41, tier: 2 },
            { name: "Lem Rune", code: "r20", level: 43, tier: 3 },
            { name: "Pul Rune", code: "r21", level: 45, tier: 3 },
            { name: "Um Rune", code: "r22", level: 47, tier: 3 },
            { name: "Mal Rune", code: "r23", level: 49, tier: 3 },
            { name: "Ist Rune", code: "r24", level: 51, tier: 3 },
            { name: "Gul Rune", code: "r25", level: 53, tier: 3 },
            { name: "Vex Rune", code: "r26", level: 55, tier: 3 },
            { name: "Ohm Rune", code: "r27", level: 57, tier: 3 },
            { name: "Lo Rune", code: "r28", level: 59, tier: 3 },
            { name: "Sur Rune", code: "r29", level: 61, tier: 3 },
            { name: "Ber Rune", code: "r30", level: 63, tier: 3 },
            { name: "Jah Rune", code: "r31", level: 65, tier: 3 },
            { name: "Cham Rune", code: "r32", level: 67, tier: 3 },
            { name: "Zod Rune", code: "r33", level: 69, tier: 3 },
        ];

        const gemItems = [
            { name: "Perfect Sapphire", code: "gpb", level: 5, type: "sapphire" },
            { name: "Perfect Emerald", code: "gpg", level: 5, type: "emerald" },
            { name: "Perfect Topaz", code: "gpy", level: 5, type: "topaz" },
            { name: "Perfect Ruby", code: "gpr", level: 5, type: "ruby" },
            { name: "Perfect Amethyst", code: "gpv", level: 5, type: "amethyst" },
            { name: "Perfect Diamond", code: "gpw", level: 5, type: "diamond" },
            { name: "Perfect Skull", code: "skz", level: 5, type: "skull" },
            { name: "Flawless Sapphire", code: "glb", level: 4, type: "sapphire" },
            { name: "Flawless Emerald", code: "glg", level: 4, type: "emerald" },
            { name: "Flawless Topaz", code: "gly", level: 4, type: "topaz" },
            { name: "Flawless Ruby", code: "glr", level: 4, type: "ruby" },
            { name: "Flawless Amethyst", code: "gzv", level: 4, type: "amethyst" },
            { name: "Flawless Diamond", code: "glw", level: 4, type: "diamond" },
            { name: "Flawless Skull", code: "skl", level: 4, type: "skull" },
            { name: "Sapphire", code: "gsb", level: 3, type: "sapphire" },
            { name: "Emerald", code: "gsg", level: 3, type: "emerald" },
            { name: "Topaz", code: "gsy", level: 3, type: "topaz" },
            { name: "Ruby", code: "gsr", level: 3, type: "ruby" },
            { name: "Amethyst", code: "gsv", level: 3, type: "amethyst" },
            { name: "Diamond", code: "gsw", level: 3, type: "diamond" },
            { name: "Skull", code: "sku", level: 3, type: "skull" },
            { name: "Flawed Sapphire", code: "gfb", level: 2, type: "sapphire" },
            { name: "Flawed Emerald", code: "gfg", level: 2, type: "emerald" },
            { name: "Flawed Topaz", code: "gfy", level: 2, type: "topaz" },
            { name: "Flawed Ruby", code: "gfr", level: 2, type: "ruby" },
            { name: "Flawed Amethyst", code: "gfv", level: 2, type: "amethyst" },
            { name: "Flawed Diamond", code: "gfw", level: 2, type: "diamond" },
            { name: "Flawed Skull", code: "skf", level: 2, type: "skull" },
            { name: "Chipped Sapphire", code: "gcb", level: 1, type: "sapphire" },
            { name: "Chipped Emerald", code: "gcg", level: 1, type: "emerald" },
            { name: "Chipped Topaz", code: "gcy", level: 1, type: "topaz" },
            { name: "Chipped Ruby", code: "gcr", level: 1, type: "ruby" },
            { name: "Chipped Amethyst", code: "gcv", level: 1, type: "amethyst" },
            { name: "Chipped Diamond", code: "gcw", level: 1, type: "diamond" },
            { name: "Chipped Skull", code: "skc", level: 1, type: "skull" },
        ];

        const miscItems = [
            { name: "Orb of Corruption", code: "cx5", category: "orb" },
            { name: "Orb of Alteration", code: "cx9", category: "orb" },
            { name: "Key of Terror", code: "pk1", category: "key" },
            { name: "Key of Hatred", code: "pk2", category: "key" },
            { name: "Key of Destruction", code: "pk3", category: "key" },
            { name: "Diablo's Horn", code: "dhn", category: "organ" },
            { name: "Baal's Eye", code: "bey", category: "organ" },
            { name: "Mephisto's Brain", code: "mbr", category: "organ" },
            { name: "Twisted Essence of Suffering", code: "tes", category: "essence" },
            { name: "Charged Essence of Hatred", code: "ceh", category: "essence" },
            { name: "Burning Essence of Terror", code: "bet", category: "essence" },
            { name: "Festering Essence of Destruction", code: "fed", category: "essence" },
            { name: "Token of Absolution", code: "toa", category: "essence" },
        ];

        // Global settings state
        const globalSettings = {
            enableFilterLevels: false,
            levelNames: [
                'Level 1', 'Level 2', 'Level 3', 'Level 4', 'Level 5',
                'Level 6', 'Level 7', 'Level 8', 'Level 9', 'Level 10'
            ]
        };

        // State management
        const filterState = {
            utility: {},
            runes: {},
            gems: {},
            misc: {}
        };

        // Initialize utility items state
        utilityItems.forEach(item => {
            filterState.utility[item.code] = {
                show: true,
                useCustomColors: false,
                chatNotification: false,
                fontColor: 'WHITE',
                borderColor: null,
                backgroundColor: null,
                filterLevels: [true, true, true, true, true, true, true, true, true, true]
            };
        });

        // Initialize rune items state
        runeItems.forEach(item => {
            filterState.runes[item.code] = {
                show: true,
                useCustomColors: false,
                chatNotification: false,
                fontColor: 'ORANGE',
                borderColor: null,
                backgroundColor: null,
                filterLevels: [true, true, true, true, true, true, true, true, true, true]
            };
        });

        // Initialize gems state
        gemItems.forEach(item => {
            filterState.gems[item.code] = {
                show: true,
                useCustomColors: false,
                chatNotification: false,
                fontColor: 'WHITE',
                borderColor: null,
                backgroundColor: null,
                filterLevels: [true, true, true, true, true, true, true, true, true, true]
            };
        });

        // Initialize misc items state
        miscItems.forEach(item => {
            filterState.misc[item.code] = {
                show: true,
                useCustomColors: false,
                chatNotification: false,
                fontColor: 'PURPLE',
                borderColor: null,
                backgroundColor: null,
                filterLevels: [true, true, true, true, true, true, true, true, true, true]
            };
        });

        // Render items
        function renderUtilityItems() {
            const container = document.getElementById('utility-items');
            container.innerHTML = '';
            
            utilityItems.forEach(item => {
                const state = filterState.utility[item.code];
                const row = document.createElement('div');
                row.className = 'item-row';
                
                // Build font color options
                const fontOptions = FONT_COLORS.map(color => 
                    `<option value="${color}" ${state.fontColor === color ? 'selected' : ''}>${color}</option>`
                ).join('');
                
                // Build filter levels checkboxes
                const levelCheckboxes = state.filterLevels.map((checked, idx) => `
                    <div class="level-checkbox-wrapper" title="${globalSettings.levelNames[idx]}">
                        <input type="checkbox" class="level-checkbox" 
                            ${checked ? 'checked' : ''}
                            onchange="updateItemLevel('utility', '${item.code}', ${idx}, this.checked)">
                        <span class="level-checkbox-label">${idx + 1}</span>
                    </div>
                `).join('');
                
                row.innerHTML = `
                    <input type="checkbox" class="item-checkbox" 
                        ${state.show ? 'checked' : ''} 
                        onchange="updateItemState('utility', '${item.code}', 'show', this.checked)">
                    <span class="item-name">${item.name}</span>
                    <div class="color-picker-wrapper">
                        <input type="checkbox" class="custom-color-checkbox" 
                            ${state.useCustomColors ? 'checked' : ''}
                            onchange="updateItemState('utility', '${item.code}', 'useCustomColors', this.checked)">
                        <span class="custom-label">Custom</span>
                    </div>
                    <div class="color-picker-wrapper">
                        <input type="checkbox" class="custom-color-checkbox" 
                            ${state.chatNotification ? 'checked' : ''}
                            onchange="updateItemState('utility', '${item.code}', 'chatNotification', this.checked)">
                        <span class="custom-label">Notify</span>
                    </div>
                    <div class="levels-selector ${!globalSettings.enableFilterLevels ? 'disabled' : ''}">
                        <span class="levels-label">Levels:</span>
                        <button class="btn-link" onclick="setAllLevels('utility', '${item.code}', true); event.preventDefault();" title="Select all levels">All</button>
                        <button class="btn-link" onclick="setAllLevels('utility', '${item.code}', false); event.preventDefault();" title="Deselect all levels">None</button>
                        <div class="level-checkboxes">
                            ${levelCheckboxes}
                        </div>
                    </div>
                    <div class="colors-container" style="${!state.useCustomColors ? 'opacity: 0.3; pointer-events: none;' : ''}">
                        <div class="color-picker-wrapper">
                            <span class="color-label">Font</span>
                            <select class="color-select" 
                                onchange="updateItemState('utility', '${item.code}', 'fontColor', this.value)">
                                ${fontOptions}
                            </select>
                            <button class="color-clear-btn" 
                                onclick="clearFontColor('utility', '${item.code}')"
                                title="Reset to default">×</button>
                        </div>
                        <div class="color-picker-wrapper">
                            <span class="color-label">Border</span>
                            <input type="color" class="color-input" value="${state.borderColor || '#808080'}"
                                onchange="updateItemState('utility', '${item.code}', 'borderColor', this.value)"
                                ${!state.borderColor ? 'style="opacity: 0.5;"' : ''}>
                            <button class="color-clear-btn" 
                                onclick="clearColor('utility', '${item.code}', 'borderColor')"
                                title="Clear border color">×</button>
                        </div>
                        <div class="color-picker-wrapper">
                            <span class="color-label">BG</span>
                            <input type="color" class="color-input" value="${state.backgroundColor || '#000000'}"
                                onchange="updateItemState('utility', '${item.code}', 'backgroundColor', this.value)"
                                ${!state.backgroundColor ? 'style="opacity: 0.5;"' : ''}>
                            <button class="color-clear-btn" 
                                onclick="clearColor('utility', '${item.code}', 'backgroundColor')"
                                title="Clear background color">×</button>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });

            updateItemCount('utility');
        }

        function renderRuneItems() {
            const container = document.getElementById('runes-items');
            container.innerHTML = '';
            
            runeItems.forEach(item => {
                const state = filterState.runes[item.code];
                const row = document.createElement('div');
                row.className = 'item-row';
                
                // Build font color options
                const fontOptions = FONT_COLORS.map(color => 
                    `<option value="${color}" ${state.fontColor === color ? 'selected' : ''}>${color}</option>`
                ).join('');
                
                // Build filter levels checkboxes
                const levelCheckboxes = state.filterLevels.map((checked, idx) => `
                    <div class="level-checkbox-wrapper" title="${globalSettings.levelNames[idx]}">
                        <input type="checkbox" class="level-checkbox" 
                            ${checked ? 'checked' : ''}
                            onchange="updateItemLevel('runes', '${item.code}', ${idx}, this.checked)">
                        <span class="level-checkbox-label">${idx + 1}</span>
                    </div>
                `).join('');
                
                row.innerHTML = `
                    <input type="checkbox" class="item-checkbox" 
                        ${state.show ? 'checked' : ''} 
                        onchange="updateItemState('runes', '${item.code}', 'show', this.checked)">
                    <span class="item-name">${item.name}</span>
                    <div class="color-picker-wrapper">
                        <input type="checkbox" class="custom-color-checkbox" 
                            ${state.useCustomColors ? 'checked' : ''}
                            onchange="updateItemState('runes', '${item.code}', 'useCustomColors', this.checked)">
                        <span class="custom-label">Custom</span>
                    </div>
                    <div class="color-picker-wrapper">
                        <input type="checkbox" class="custom-color-checkbox" 
                            ${state.chatNotification ? 'checked' : ''}
                            onchange="updateItemState('runes', '${item.code}', 'chatNotification', this.checked)">
                        <span class="custom-label">Notify</span>
                    </div>
                    <div class="levels-selector ${!globalSettings.enableFilterLevels ? 'disabled' : ''}">
                        <span class="levels-label">Levels:</span>
                        <button class="btn-link" onclick="setAllLevels('runes', '${item.code}', true); event.preventDefault();" title="Select all levels">All</button>
                        <button class="btn-link" onclick="setAllLevels('runes', '${item.code}', false); event.preventDefault();" title="Deselect all levels">None</button>
                        <div class="level-checkboxes">
                            ${levelCheckboxes}
                        </div>
                    </div>
                    <div class="colors-container" style="${!state.useCustomColors ? 'opacity: 0.3; pointer-events: none;' : ''}">
                        <div class="color-picker-wrapper">
                            <span class="color-label">Font</span>
                            <select class="color-select" 
                                onchange="updateItemState('runes', '${item.code}', 'fontColor', this.value)">
                                ${fontOptions}
                            </select>
                            <button class="color-clear-btn" 
                                onclick="clearFontColor('runes', '${item.code}')"
                                title="Reset to default">×</button>
                        </div>
                        <div class="color-picker-wrapper">
                            <span class="color-label">Border</span>
                            <input type="color" class="color-input" value="${state.borderColor || '#ff8000'}"
                                onchange="updateItemState('runes', '${item.code}', 'borderColor', this.value)"
                                ${!state.borderColor ? 'style="opacity: 0.5;"' : ''}>
                            <button class="color-clear-btn" 
                                onclick="clearColor('runes', '${item.code}', 'borderColor')"
                                title="Clear border color">×</button>
                        </div>
                        <div class="color-picker-wrapper">
                            <span class="color-label">BG</span>
                            <input type="color" class="color-input" value="${state.backgroundColor || '#000000'}"
                                onchange="updateItemState('runes', '${item.code}', 'backgroundColor', this.value)"
                                ${!state.backgroundColor ? 'style="opacity: 0.5;"' : ''}>
                            <button class="color-clear-btn" 
                                onclick="clearColor('runes', '${item.code}', 'backgroundColor')"
                                title="Clear background color">×</button>
                        </div>
                `;
                container.appendChild(row);
            });

            updateItemCount('runes');
        }

        function renderGemsItems() {
            const container = document.getElementById('gems-items');
            container.innerHTML = '';
            
            gemItems.forEach(item => {
                const state = filterState.gems[item.code];
                const row = document.createElement('div');
                row.className = 'item-row';
                
                // Build font color options
                const fontOptions = FONT_COLORS.map(color => 
                    `<option value="${color}" ${state.fontColor === color ? 'selected' : ''}>${color}</option>`
                ).join('');
                
                // Build filter levels checkboxes
                const levelCheckboxes = state.filterLevels.map((checked, idx) => `
                    <div class="level-checkbox-wrapper" title="${globalSettings.levelNames[idx]}">
                        <input type="checkbox" class="level-checkbox" 
                            ${checked ? 'checked' : ''}
                            onchange="updateItemLevel('gems', '${item.code}', ${idx}, this.checked)">
                        <span class="level-checkbox-label">${idx + 1}</span>
                    </div>
                `).join('');
                
                row.innerHTML = `
                    <input type="checkbox" class="item-checkbox" 
                        ${state.show ? 'checked' : ''} 
                        onchange="updateItemState('gems', '${item.code}', 'show', this.checked)">
                    <span class="item-name">${item.name}</span>
                    <div class="color-picker-wrapper">
                        <input type="checkbox" class="custom-color-checkbox" 
                            ${state.useCustomColors ? 'checked' : ''}
                            onchange="updateItemState('gems', '${item.code}', 'useCustomColors', this.checked)">
                        <span class="custom-label">Custom</span>
                    </div>
                    <div class="color-picker-wrapper">
                        <input type="checkbox" class="custom-color-checkbox" 
                            ${state.chatNotification ? 'checked' : ''}
                            onchange="updateItemState('gems', '${item.code}', 'chatNotification', this.checked)">
                        <span class="custom-label">Notify</span>
                    </div>
                    <div class="levels-selector ${!globalSettings.enableFilterLevels ? 'disabled' : ''}">
                        <span class="levels-label">Levels:</span>
                        <button class="btn-link" onclick="setAllLevels('gems', '${item.code}', true); event.preventDefault();" title="Select all levels">All</button>
                        <button class="btn-link" onclick="setAllLevels('gems', '${item.code}', false); event.preventDefault();" title="Deselect all levels">None</button>
                        <div class="level-checkboxes">
                            ${levelCheckboxes}
                        </div>
                    </div>
                    <div class="colors-container" style="${!state.useCustomColors ? 'opacity: 0.3; pointer-events: none;' : ''}">
                        <div class="color-picker-wrapper">
                            <span class="color-label">Font</span>
                            <select class="color-select" 
                                onchange="updateItemState('gems', '${item.code}', 'fontColor', this.value)">
                                ${fontOptions}
                            </select>
                            <button class="color-clear-btn" 
                                onclick="clearFontColor('gems', '${item.code}')"
                                title="Reset to default">×</button>
                        </div>
                        <div class="color-picker-wrapper">
                            <span class="color-label">Border</span>
                            <input type="color" class="color-input" value="${state.borderColor || '#808080'}"
                                onchange="updateItemState('gems', '${item.code}', 'borderColor', this.value)"
                                ${!state.borderColor ? 'style="opacity: 0.5;"' : ''}>
                            <button class="color-clear-btn" 
                                onclick="clearColor('gems', '${item.code}', 'borderColor')"
                                title="Clear border color">×</button>
                        </div>
                        <div class="color-picker-wrapper">
                            <span class="color-label">BG</span>
                            <input type="color" class="color-input" value="${state.backgroundColor || '#000000'}"
                                onchange="updateItemState('gems', '${item.code}', 'backgroundColor', this.value)"
                                ${!state.backgroundColor ? 'style="opacity: 0.5;"' : ''}>
                            <button class="color-clear-btn" 
                                onclick="clearColor('gems', '${item.code}', 'backgroundColor')"
                                title="Clear background color">×</button>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });

            updateItemCount('gems');
        }

        function renderMiscItems() {
            const container = document.getElementById('misc-items');
            container.innerHTML = '';
            
            miscItems.forEach(item => {
                const state = filterState.misc[item.code];
                const row = document.createElement('div');
                row.className = 'item-row';
                
                // Build font color options
                const fontOptions = FONT_COLORS.map(color => 
                    `<option value="${color}" ${state.fontColor === color ? 'selected' : ''}>${color}</option>`
                ).join('');
                
                // Build filter levels checkboxes
                const levelCheckboxes = state.filterLevels.map((checked, idx) => `
                    <div class="level-checkbox-wrapper" title="${globalSettings.levelNames[idx]}">
                        <input type="checkbox" class="level-checkbox" 
                            ${checked ? 'checked' : ''}
                            onchange="updateItemLevel('misc', '${item.code}', ${idx}, this.checked)">
                        <span class="level-checkbox-label">${idx + 1}</span>
                    </div>
                `).join('');
                
                row.innerHTML = `
                    <input type="checkbox" class="item-checkbox" 
                        ${state.show ? 'checked' : ''} 
                        onchange="updateItemState('misc', '${item.code}', 'show', this.checked)">
                    <span class="item-name">${item.name}</span>
                    <div class="color-picker-wrapper">
                        <input type="checkbox" class="custom-color-checkbox" 
                            ${state.useCustomColors ? 'checked' : ''}
                            onchange="updateItemState('misc', '${item.code}', 'useCustomColors', this.checked)">
                        <span class="custom-label">Custom</span>
                    </div>
                    <div class="color-picker-wrapper">
                        <input type="checkbox" class="custom-color-checkbox" 
                            ${state.chatNotification ? 'checked' : ''}
                            onchange="updateItemState('misc', '${item.code}', 'chatNotification', this.checked)">
                        <span class="custom-label">Notify</span>
                    </div>
                    <div class="levels-selector ${!globalSettings.enableFilterLevels ? 'disabled' : ''}">
                        <span class="levels-label">Levels:</span>
                        <button class="btn-link" onclick="setAllLevels('misc', '${item.code}', true); event.preventDefault();" title="Select all levels">All</button>
                        <button class="btn-link" onclick="setAllLevels('misc', '${item.code}', false); event.preventDefault();" title="Deselect all levels">None</button>
                        <div class="level-checkboxes">
                            ${levelCheckboxes}
                        </div>
                    </div>
                    <div class="colors-container" style="${!state.useCustomColors ? 'opacity: 0.3; pointer-events: none;' : ''}">
                        <div class="color-picker-wrapper">
                            <span class="color-label">Font</span>
                            <select class="color-select" 
                                onchange="updateItemState('misc', '${item.code}', 'fontColor', this.value)">
                                ${fontOptions}
                            </select>
                            <button class="color-clear-btn" 
                                onclick="clearFontColor('misc', '${item.code}')"
                                title="Reset to default">×</button>
                        </div>
                        <div class="color-picker-wrapper">
                            <span class="color-label">Border</span>
                            <input type="color" class="color-input" value="${state.borderColor || '#808080'}"
                                onchange="updateItemState('misc', '${item.code}', 'borderColor', this.value)"
                                ${!state.borderColor ? 'style="opacity: 0.5;"' : ''}>
                            <button class="color-clear-btn" 
                                onclick="clearColor('misc', '${item.code}', 'borderColor')"
                                title="Clear border color">×</button>
                        </div>
                        <div class="color-picker-wrapper">
                            <span class="color-label">BG</span>
                            <input type="color" class="color-input" value="${state.backgroundColor || '#000000'}"
                                onchange="updateItemState('misc', '${item.code}', 'backgroundColor', this.value)"
                                ${!state.backgroundColor ? 'style="opacity: 0.5;"' : ''}>
                            <button class="color-clear-btn" 
                                onclick="clearColor('misc', '${item.code}', 'backgroundColor')"
                                title="Clear background color">×</button>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });

            updateItemCount('misc');
        }

        // Update state and regenerate filter
        function updateItemState(category, code, property, value) {
            filterState[category][code][property] = value;
            
            // Re-render if useCustomColors changed to update UI
            if (property === 'useCustomColors') {
                if (category === 'utility') {
                    renderUtilityItems();
                } else if (category === 'runes') {
                    renderRuneItems();
                } else if (category === 'gems') {
                    renderGemsItems();
                } else if (category === 'misc') {
                    renderMiscItems();
                }
            }
            
            updateItemCount(category);
            generateFilter();
        }

        // Clear a color value
        function clearColor(category, code, property) {
            filterState[category][code][property] = null;
            if (category === 'utility') {
                renderUtilityItems();
            } else if (category === 'runes') {
                renderRuneItems();
            } else if (category === 'gems') {
                renderGemsItems();
            } else if (category === 'misc') {
                renderMiscItems();
            }
            generateFilter();
        }

        // Clear font color to default
        function clearFontColor(category, code) {
            let defaultColor = 'WHITE';
            if (category === 'runes') defaultColor = 'ORANGE';
            else if (category === 'misc') defaultColor = 'PURPLE';
            
            filterState[category][code].fontColor = defaultColor;
            if (category === 'utility') {
                renderUtilityItems();
            } else if (category === 'runes') {
                renderRuneItems();
            } else if (category === 'gems') {
                renderGemsItems();
            } else if (category === 'misc') {
                renderMiscItems();
            }
            generateFilter();
        }

        // Update item counts
        function updateItemCount(category) {
            const state = filterState[category];
            const total = Object.keys(state).length;
            const shown = Object.values(state).filter(item => item.show).length;
            document.getElementById(`${category}-count`).textContent = `(${shown}/${total} shown)`;
        }

        // Section toggling
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            section.classList.toggle('expanded');
        }

        // Presets
        function applyUtilityPreset(preset) {
            if (!preset) return;

            const essentialCodes = ['rvl', 'rvs', 'hp5', 'mp5', 'tbk', 'ibk', 'tsc', 'isc'];
            const lowPotions = ['hp1', 'hp2', 'hp3', 'mp1', 'mp2', 'mp3'];

            switch(preset) {
                case 'show-all':
                    Object.keys(filterState.utility).forEach(code => {
                        filterState.utility[code].show = true;
                    });
                    break;
                case 'hide-all':
                    Object.keys(filterState.utility).forEach(code => {
                        filterState.utility[code].show = false;
                    });
                    break;
                case 'essential-only':
                    Object.keys(filterState.utility).forEach(code => {
                        filterState.utility[code].show = essentialCodes.includes(code);
                    });
                    break;
                case 'endgame':
                    Object.keys(filterState.utility).forEach(code => {
                        filterState.utility[code].show = !lowPotions.includes(code);
                    });
                    break;
            }

            renderUtilityItems();
            generateFilter();
        }

        function applyRunePreset(preset) {
            if (!preset) return;

            switch(preset) {
                case 'show-all':
                    Object.keys(filterState.runes).forEach(code => {
                        filterState.runes[code].show = true;
                    });
                    break;
                case 'hide-all':
                    Object.keys(filterState.runes).forEach(code => {
                        filterState.runes[code].show = false;
                    });
                    break;
                case 'hide-low':
                    runeItems.forEach(item => {
                        filterState.runes[item.code].show = item.code > 'r09'; // After Ort
                    });
                    break;
                case 'mid-plus':
                    runeItems.forEach(item => {
                        filterState.runes[item.code].show = item.code >= 'r10'; // Thul+
                    });
                    break;
                case 'high-only':
                    runeItems.forEach(item => {
                        filterState.runes[item.code].show = item.code >= 'r21'; // Pul+
                    });
                    break;
            }

            renderRuneItems();
            generateFilter();
        }

        function applyGemPreset(preset) {
            if (!preset) return;

            switch(preset) {
                case 'show-all':
                    Object.keys(filterState.gems).forEach(code => {
                        filterState.gems[code].show = true;
                    });
                    break;
                case 'hide-all':
                    Object.keys(filterState.gems).forEach(code => {
                        filterState.gems[code].show = false;
                    });
                    break;
                case 'perfect-only':
                    gemItems.forEach(item => {
                        filterState.gems[item.code].show = item.level === 5;
                    });
                    break;
                case 'flawless-plus':
                    gemItems.forEach(item => {
                        filterState.gems[item.code].show = item.level >= 4;
                    });
                    break;
                case 'regular-plus':
                    gemItems.forEach(item => {
                        filterState.gems[item.code].show = item.level >= 3;
                    });
                    break;
            }

            renderGemsItems();
            generateFilter();
        }

        function applyMiscPreset(preset) {
            if (!preset) return;

            const essentials = ['cx5', 'cx9', 'pk1', 'pk2', 'pk3', 'dhn', 'bey', 'mbr', 'tes', 'ceh', 'bet', 'fed'];

            switch(preset) {
                case 'show-all':
                    Object.keys(filterState.misc).forEach(code => {
                        filterState.misc[code].show = true;
                    });
                    break;
                case 'hide-all':
                    Object.keys(filterState.misc).forEach(code => {
                        filterState.misc[code].show = false;
                    });
                    break;
                case 'essentials':
                    Object.keys(filterState.misc).forEach(code => {
                        filterState.misc[code].show = essentials.includes(code);
                    });
                    break;
            }

            renderMiscItems();
            generateFilter();
        }

        // Generate filter output
        function generateFilter() {
            let filter = '// FilterPhoenix Visual Filter Builder\n';
            filter += '// Generated: ' + new Date().toLocaleString() + '\n\n';

            // Add FilterLevel declarations if enabled
            if (globalSettings.enableFilterLevels) {
                filter += '// === FILTER LEVELS ===\n\n';
                for (let i = 0; i < 10; i++) {
                    filter += `FilterLevel[${i + 1}]: "${globalSettings.levelNames[i]}"\n`;
                }
                filter += '\n';
            }

            // Check if any items need custom styles (for border/background colors)
            let needsCustomStyle = false;
            
            utilityItems.forEach(item => {
                const state = filterState.utility[item.code];
                if (state.show) {
                    const needsBorder = state.useCustomColors && state.borderColor !== null;
                    const needsBackground = state.useCustomColors && state.backgroundColor !== null;
                    const needsNotification = state.chatNotification;
                    if (needsBorder || needsBackground || needsNotification) {
                        needsCustomStyle = true;
                    }
                }
            });

            runeItems.forEach(item => {
                const state = filterState.runes[item.code];
                if (state.show) {
                    const needsBorder = state.useCustomColors && state.borderColor !== null;
                    const needsBackground = state.useCustomColors && state.backgroundColor !== null;
                    const needsNotification = state.chatNotification;
                    if (needsBorder || needsBackground || needsNotification) {
                        needsCustomStyle = true;
                    }
                }
            });

            gemItems.forEach(item => {
                const state = filterState.gems[item.code];
                if (state.show) {
                    const needsBorder = state.useCustomColors && state.borderColor !== null;
                    const needsBackground = state.useCustomColors && state.backgroundColor !== null;
                    const needsNotification = state.chatNotification;
                    if (needsBorder || needsBackground || needsNotification) {
                        needsCustomStyle = true;
                    }
                }
            });

            miscItems.forEach(item => {
                const state = filterState.misc[item.code];
                if (state.show) {
                    const needsBorder = state.useCustomColors && state.borderColor !== null;
                    const needsBackground = state.useCustomColors && state.backgroundColor !== null;
                    const needsNotification = state.chatNotification;
                    if (needsBorder || needsBackground || needsNotification) {
                        needsCustomStyle = true;
                    }
                }
            });

            // Generate single ItemStyle declaration if needed
            if (needsCustomStyle) {
                filter += '// === CUSTOM STYLE ===\n\n';
                filter += 'ItemStyle[CustomDisplay]: NotificationColor = %ITEM%\n\n';
            }

            // Utility items
            filter += '// === UTILITY ITEMS ===\n\n';
            utilityItems.forEach(item => {
                const state = filterState.utility[item.code];
                if (state.show) {
                    // Generate filter level condition if enabled
                    const filtLvlCondition = generateFilterLevelCondition(state.filterLevels);
                    let line = `ItemDisplay[${item.code}${filtLvlCondition}]:`;
                    
                    // Only add colors if custom colors are enabled
                    if (state.useCustomColors && state.fontColor !== 'WHITE') {
                        line += ` %${state.fontColor}%`;
                    }
                    
                    line += ` %NAME%`;
                    
                    // Add style reference for border/background/notification if needed
                    if (state.useCustomColors || state.chatNotification) {
                        const needsBorder = state.useCustomColors && state.borderColor !== null;
                        const needsBackground = state.useCustomColors && state.backgroundColor !== null;
                        const needsNotification = state.chatNotification;
                        
                        if (needsBorder || needsBackground || needsNotification) {
                            const rgbParts = [];
                            if (needsNotification) {
                                rgbParts.push(`NotificationColor = ${state.fontColor}`);
                            }
                            if (needsBorder) {
                                const rgb = hexToRGBSlash(state.borderColor);
                                rgbParts.push(`BorderColor = RGB(${rgb})`);
                            }
                            if (needsBackground) {
                                const rgb = hexToRGBSlash(state.backgroundColor);
                                rgbParts.push(`BackgroundColor = RGB(${rgb})`);
                            }
                            line += ` <:CustomDisplay: ${rgbParts.join(', ')}>`;
                        }
                    }
                    
                    filter += line + '\n';
                } else {
                    filter += `ItemDisplay[${item.code}]:\n`;
                }
            });

            // Runes
            filter += '\n// === RUNES ===\n\n';
            runeItems.forEach(item => {
                const state = filterState.runes[item.code];
                if (state.show) {
                    // Generate filter level condition if enabled
                    const filtLvlCondition = generateFilterLevelCondition(state.filterLevels);
                    let line = `ItemDisplay[${item.code}${filtLvlCondition}]:`;
                    
                    // Only add colors if custom colors are enabled
                    if (state.useCustomColors && state.fontColor !== 'ORANGE') {
                        line += ` %${state.fontColor}%`;
                    }
                    
                    line += ` %NAME%`;
                    
                    // Add style reference for border/background/notification if needed
                    if (state.useCustomColors || state.chatNotification) {
                        const needsBorder = state.useCustomColors && state.borderColor !== null;
                        const needsBackground = state.useCustomColors && state.backgroundColor !== null;
                        const needsNotification = state.chatNotification;
                        
                        if (needsBorder || needsBackground || needsNotification) {
                            const rgbParts = [];
                            if (needsNotification) {
                                rgbParts.push(`NotificationColor = ${state.fontColor}`);
                            }
                            if (needsBorder) {
                                const rgb = hexToRGBSlash(state.borderColor);
                                rgbParts.push(`BorderColor = RGB(${rgb})`);
                            }
                            if (needsBackground) {
                                const rgb = hexToRGBSlash(state.backgroundColor);
                                rgbParts.push(`BackgroundColor = RGB(${rgb})`);
                            }
                            line += ` <:CustomDisplay: ${rgbParts.join(', ')}>`;
                        }
                    }
                    
                    filter += line + '\n';
                } else {
                    filter += `ItemDisplay[${item.code}]:\n`;
                }
            });

            // Gems
            filter += '\n// === GEMS ===\n\n';
            gemItems.forEach(item => {
                const state = filterState.gems[item.code];
                if (state.show) {
                    // Generate filter level condition if enabled
                    const filtLvlCondition = generateFilterLevelCondition(state.filterLevels);
                    let line = `ItemDisplay[${item.code}${filtLvlCondition}]:`;
                    
                    // Only add colors if custom colors are enabled
                    if (state.useCustomColors && state.fontColor !== 'WHITE') {
                        line += ` %${state.fontColor}%`;
                    }
                    
                    line += ` %NAME%`;
                    
                    // Add style reference for border/background/notification if needed
                    if (state.useCustomColors || state.chatNotification) {
                        const needsBorder = state.useCustomColors && state.borderColor !== null;
                        const needsBackground = state.useCustomColors && state.backgroundColor !== null;
                        const needsNotification = state.chatNotification;
                        
                        if (needsBorder || needsBackground || needsNotification) {
                            const rgbParts = [];
                            if (needsNotification) {
                                rgbParts.push(`NotificationColor = ${state.fontColor}`);
                            }
                            if (needsBorder) {
                                const rgb = hexToRGBSlash(state.borderColor);
                                rgbParts.push(`BorderColor = RGB(${rgb})`);
                            }
                            if (needsBackground) {
                                const rgb = hexToRGBSlash(state.backgroundColor);
                                rgbParts.push(`BackgroundColor = RGB(${rgb})`);
                            }
                            line += ` <:CustomDisplay: ${rgbParts.join(', ')}>`;
                        }
                    }
                    
                    filter += line + '\n';
                } else {
                    filter += `ItemDisplay[${item.code}]:\n`;
                }
            });

            // PoD/Misc Items
            filter += '\n// === POD/MISC ITEMS ===\n\n';
            miscItems.forEach(item => {
                const state = filterState.misc[item.code];
                if (state.show) {
                    // Generate filter level condition if enabled
                    const filtLvlCondition = generateFilterLevelCondition(state.filterLevels);
                    let line = `ItemDisplay[${item.code}${filtLvlCondition}]:`;
                    
                    // Only add colors if custom colors are enabled
                    if (state.useCustomColors && state.fontColor !== 'PURPLE') {
                        line += ` %${state.fontColor}%`;
                    }
                    
                    line += ` %NAME%`;
                    
                    // Add style reference for border/background/notification if needed
                    if (state.useCustomColors || state.chatNotification) {
                        const needsBorder = state.useCustomColors && state.borderColor !== null;
                        const needsBackground = state.useCustomColors && state.backgroundColor !== null;
                        const needsNotification = state.chatNotification;
                        
                        if (needsBorder || needsBackground || needsNotification) {
                            const rgbParts = [];
                            if (needsNotification) {
                                rgbParts.push(`NotificationColor = ${state.fontColor}`);
                            }
                            if (needsBorder) {
                                const rgb = hexToRGBSlash(state.borderColor);
                                rgbParts.push(`BorderColor = RGB(${rgb})`);
                            }
                            if (needsBackground) {
                                const rgb = hexToRGBSlash(state.backgroundColor);
                                rgbParts.push(`BackgroundColor = RGB(${rgb})`);
                            }
                            line += ` <:CustomDisplay: ${rgbParts.join(', ')}>`;
                        }
                    }
                    
                    filter += line + '\n';
                } else {
                    filter += `ItemDisplay[${item.code}]:\n`;
                }
            });

            document.getElementById('filter-output').value = filter;
            updateOutputStats();
        }

        // Helper function to generate FILTLVL condition from filterLevels array
        function generateFilterLevelCondition(filterLevels) {
            if (!globalSettings.enableFilterLevels) return '';
            
            // Check if all levels are enabled
            const enabledLevels = filterLevels.map((enabled, idx) => enabled ? idx + 1 : null).filter(l => l !== null);
            if (enabledLevels.length === 10) return ''; // All levels, no condition needed
            if (enabledLevels.length === 0) return ''; // None enabled, item won't show anyway
            
            // Find consecutive ranges
            const ranges = [];
            let rangeStart = enabledLevels[0];
            let rangeEnd = enabledLevels[0];
            
            for (let i = 1; i <= enabledLevels.length; i++) {
                const currentLevel = enabledLevels[i];
                
                if (currentLevel === rangeEnd + 1) {
                    rangeEnd = currentLevel;
                } else {
                    // End of range, save it
                    if (rangeStart === rangeEnd) {
                        ranges.push(`FILTLVL=${rangeStart}`);
                    } else if (rangeEnd === rangeStart + 1) {
                        ranges.push(`FILTLVL=${rangeStart}`);
                        ranges.push(`FILTLVL=${rangeEnd}`);
                    } else {
                        ranges.push(`FILTLVL>=${rangeStart} FILTLVL<=${rangeEnd}`);
                    }
                    
                    if (i < enabledLevels.length) {
                        rangeStart = currentLevel;
                        rangeEnd = currentLevel;
                    }
                }
            }
            
            // If multiple ranges/levels, we need multiple ItemDisplay lines or complex conditions
            // For simplicity, return conditions that can be combined with OR logic
            return ranges.length > 0 ? ' ' + ranges.join(' OR ') : '';
        }

        // Convert hex color to RGB format for filter
        function hexToRGB(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `${r} ${g} ${b}`;
        }

        // Convert hex color to RGB(r/g/b) format for ItemStyle
        function hexToRGBSlash(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `${r}/${g}/${b}`;
        }

        // Update output statistics
        function updateOutputStats() {
            const output = document.getElementById('filter-output').value;
            const lines = output.split('\n').length;
            const chars = output.length;
            document.getElementById('line-count').textContent = lines;
            document.getElementById('char-count').textContent = chars;
        }

        // Export filter
        function exportFilter() {
            const output = document.getElementById('filter-output').value;
            const blob = new Blob([output], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'FilterPhoenix_' + Date.now() + '.filter';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Copy to clipboard
        function copyToClipboard() {
            const output = document.getElementById('filter-output');
            output.select();
            document.execCommand('copy');
            alert('Filter copied to clipboard!');
        }

        // Import filter
        function importFilter(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                document.getElementById('filter-output').value = content;
                // TODO: Parse filter and update UI state
                updateOutputStats();
                alert('Filter imported! Manual parsing not yet implemented - you can edit the text directly.');
            };
            reader.readAsText(file);
        }

        // Allow manual edits to update stats
        document.getElementById('filter-output').addEventListener('input', updateOutputStats);

        // Toggle filter levels feature
        function toggleFilterLevels(enabled) {
            globalSettings.enableFilterLevels = enabled;
            const configSection = document.getElementById('filter-levels-config');
            
            if (enabled) {
                configSection.classList.add('active');
                renderLevelNamesConfig();
            } else {
                configSection.classList.remove('active');
            }
            
            // Re-render all sections to update UI
            renderUtilityItems();
            renderRuneItems();
            renderGemsItems();
            renderMiscItems();
            generateFilter();
        }

        // Render level names configuration inputs
        function renderLevelNamesConfig() {
            const container = document.getElementById('level-names-grid');
            container.innerHTML = '';
            
            for (let i = 0; i < 10; i++) {
                const wrapper = document.createElement('div');
                wrapper.className = 'level-name-input';
                wrapper.innerHTML = `
                    <label>Level ${i + 1}</label>
                    <input type="text" 
                        value="${globalSettings.levelNames[i]}" 
                        onchange="updateLevelName(${i}, this.value)"
                        placeholder="Level ${i + 1}">
                `;
                container.appendChild(wrapper);
            }
        }

        // Update level name
        function updateLevelName(level, name) {
            globalSettings.levelNames[level] = name || `Level ${level + 1}`;
            // Re-render all sections to update tooltips
            renderUtilityItems();
            renderRuneItems();
            renderGemsItems();
            renderMiscItems();
        }

        // Update item filter level
        function updateItemLevel(category, code, level, checked) {
            filterState[category][code].filterLevels[level] = checked;
            generateFilter();
        }

        // Set all levels for an item
        function setAllLevels(category, code, checked) {
            for (let i = 0; i < 10; i++) {
                filterState[category][code].filterLevels[i] = checked;
            }
            // Re-render the appropriate section to update checkboxes
            if (category === 'utility') {
                renderUtilityItems();
            } else if (category === 'runes') {
                renderRuneItems();
            } else if (category === 'gems') {
                renderGemsItems();
            } else if (category === 'misc') {
                renderMiscItems();
            }
            generateFilter();
        }

        // Initialize
        renderUtilityItems();
        renderRuneItems();
        renderGemsItems();
        renderMiscItems();
        generateFilter();
    </script>
</body>
</html>
