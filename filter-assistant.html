<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>FilterPhoenix AI Assistant Beta - Create & Edit PoD Item Filters</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="stylesheet" type="text/css" href="./data/styling.css">
    <script type="text/javascript" src="./data/items.js"></script>
    <script type="text/javascript" src="./data/item_metadata.js"></script>
    <script type="text/javascript" src="./data/item_affixes.js"></script>
    <script type="text/javascript" src="./data/simulation.js"></script>
    <script type="text/javascript" src="./data/custom_items.js"></script>
    <script type="text/javascript" src="./data/colormap.js"></script>
    <script type="text/javascript" src="./data/skillmap.js"></script>
    <script type="text/javascript" src="./filter-ai-engine.js"></script>
    
    <style>
        /* Chat Interface Styles */
        .chat-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            border-radius: 10px;
        }
        
        .chat-header {
            text-align: center;
            color: #fff;
            margin-bottom: 30px;
        }
        
        .chat-messages {
            height: 400px;
            overflow-y: auto;
            border: 2px solid #333;
            background-color: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            max-width: 80%;
        }
        
        .user-message {
            background-color: #3a5998;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        
        .assistant-message {
            background-color: #4a4a4a;
            color: #fff;
            margin-right: auto;
        }
        
        .system-message {
            background-color: #2d5a2d;
            color: #90ee90;
            margin: 0 auto;
            text-align: center;
            font-style: italic;
        }
        
        .chat-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #555;
            background-color: #333;
            color: white;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .chat-send-btn {
            padding: 12px 20px;
            background-color: #5cb85c;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .chat-send-btn:hover {
            background-color: #4cae4c;
        }
        
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .quick-action-btn {
            padding: 8px 15px;
            background-color: #666;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .quick-action-btn:hover {
            background-color: #777;
        }
        
        .filter-preview {
            background-color: #2a2a2a;
            border: 2px solid #555;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .filter-preview h3 {
            color: #fff;
            margin-top: 0;
        }
        
        .filter-code {
            background-color: #1a1a1a;
            border: 1px solid #444;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #00ff00;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .test-item-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #2a2a2a;
            border-radius: 8px;
        }
        
        .suggested-rules {
            background-color: #3a3a3a;
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
        }
        
        .rule-suggestion {
            background-color: #4a4a4a;
            border: 1px solid #666;
            border-radius: 4px;
            padding: 8px;
            margin: 5px 0;
            cursor: pointer;
            color: #fff;
        }
        
        .rule-suggestion:hover {
            background-color: #5a5a5a;
        }
        
        .explanation {
            font-size: 12px;
            color: #ccc;
            margin-top: 5px;
        }
    </style>
</head>

<body style="background-color:black;" onload="initializeAssistant()">
    <div class="chat-container">
        <div class="chat-header">
            <h1>FilterPhoenix AI Assistant Beta</h1>
            <p>Create and edit Path of Diablo item filters with natural language</p>
        </div>
        
        <div class="quick-actions">
            <button class="quick-action-btn" onclick="quickAction('create-new')">üÜï Create New Filter</button>
            <button class="quick-action-btn" onclick="quickAction('hide-junk')">üóëÔ∏è Hide Junk Items</button>
            <button class="quick-action-btn" onclick="quickAction('highlight-runes')">‚ú® Highlight Runes</button>
            <button class="quick-action-btn" onclick="quickAction('show-uniques')">üåü Show Uniques</button>
            <button class="quick-action-btn" onclick="quickAction('currency-items')">üí∞ Currency Items</button>
            <button class="quick-action-btn" onclick="quickAction('endgame-filter')">‚öîÔ∏è Endgame Filter</button>
            <button class="quick-action-btn" onclick="quickAction('explain-filter')">‚ùì Explain Current Filter</button>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="message system-message">
                Welcome! I'm your FilterPhoenix AI Assistant. I can help you create, modify, analyze, and understand Path of Diablo item filters.
                <br><br>
                Try asking me things like:
                <ul style="text-align: left; display: inline-block;">
                    <li><strong>Filter Creation:</strong> "Create a filter that shows only high runes and uniques"</li>
                    <li><strong>Filter Modification:</strong> "Add unique rings to this filter line: ItemDisplay[SET]: %GREEN%"</li>
                    <li><strong>Filter Analysis:</strong> "Does this show war swords? ItemDisplay[UNI WEAPON]: %GOLD%"</li>
                    <li><strong>Community Filter Comparison:</strong> "Will mack filter show unique shako?"</li>
                    <li><strong>Specific Item Lookup:</strong> "Does josko filter show rare diadem?"</li>
                    <li><strong>General Questions:</strong> "What does this filter line do?", followed by paste of a filter line</li>
                </ul>
                <br>
                <em>I can analyze any of these community filters: mack, magfilter3, qord, arniml, kyv, pilla, josko, hornblower, rented</em>
            </div>
        </div>
        
        <div class="chat-input-container">
            <input type="text" class="chat-input" id="chatInput" placeholder="Ask me anything about creating or editing your filter..." onkeypress="handleKeyPress(event)">
            <button class="chat-send-btn" onclick="sendMessage()">Send</button>
        </div>
        
        <div class="filter-preview" id="filterPreview" style="display: none;">
            <h3>üîß Generated Filter Code</h3>
            <div class="filter-code" id="filterCode"></div>
            <div style="margin-top: 10px;">
                <button class="quick-action-btn" onclick="testFilter()">üß™ Test Filter</button>
                <button class="quick-action-btn" onclick="downloadFilter()">üíæ Download Filter</button>
                <button class="quick-action-btn" onclick="copyToClipboard()">üìã Copy to Clipboard</button>
            </div>
        </div>
        
        <div class="test-item-section" id="testSection" style="display: none;">
            <h3 style="color: #fff;">üß™ Test Your Filter</h3>
            <p style="color: #ccc;">Select an item to see how your filter would display it:</p>
            
            <!-- Embed FilterPhoenix simulation components -->
            <div style="background-color: #2a2a2a; border-radius: 8px; padding: 15px; margin: 15px 0;">
                <h4 style="color: #fff; margin-top: 0;">FilterPhoenix Simulation Engine</h4>
                
                <!-- Item Selection (simplified from original FilterBird) -->
                <div style="margin-bottom: 10px;">
                    <label style="color: #ccc;" for="dropdown_item">Test Item:</label>
                    <select id="dropdown_item" style="margin-left: 10px; padding: 5px;" onChange="setItem(this.value)"></select>
                    <button onclick="simulate(1)" style="margin-left: 10px; padding: 5px 15px; background-color: #5cb85c; color: white; border: none; border-radius: 4px;">üß™ Test Filter</button>
                </div>
                
                <!-- Character Level -->
                <div style="margin-bottom: 10px;">
                    <label style="color: #ccc;" for="dropdown_clvl">Character Level:</label>
                    <select id="dropdown_clvl" style="margin-left: 10px; padding: 5px;" onChange="setCLVL(this.value)"></select>
                    <label style="color: #ccc; margin-left: 20px;" for="filtlvl">Filter Level:</label>
                    <input id="filtlvl" type="number" min="0" max="9" value="2" style="margin-left: 10px; padding: 5px; width: 50px;" onchange="setFilterLevel(this.value)">
                </div>
                
                <!-- Filter Input Area -->
                <div style="margin-bottom: 10px;">
                    <label style="color: #ccc;">Filter Code:</label>
                    <textarea id="filter_text_1" style="width: 100%; height: 150px; margin-top: 5px; background-color: #1a1a1a; color: #00ff00; border: 1px solid #555; padding: 10px; font-family: monospace;"></textarea>
                </div>
                
                <!-- Output Areas -->
                <div style="background-color: #1a1a1a; border: 1px solid #555; padding: 10px; border-radius: 4px;">
                    <div style="color: #ccc; font-weight: bold; margin-bottom: 10px;">Simulation Results:</div>
                    <div id="o1" style="color: #90ee90; margin-bottom: 5px;"></div>
                    <div id="o2" style="color: #ffb366; margin-bottom: 5px;"></div>
                    <div id="o3" style="color: #ff6666; margin-bottom: 5px;"></div>
                    <div id="o4" style="color: #66b3ff; margin-bottom: 5px;"></div>
                    <div id="o5" style="color: #ffffff; margin-bottom: 10px;"></div>
                    
                    <!-- Visual Item Display Area -->
                    <div style="color: #ccc; font-weight: bold; margin-bottom: 10px;">Item Preview:</div>
                    <div id="output_area_1" style="position: relative; width: 100%; min-height: 100px; background-color: #0a0a0a; border: 1px solid #333; border-radius: 4px; padding: 10px;">
                        <div id="output_1" style="position: absolute; color: white; font-family: monospace; white-space: pre-wrap;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentFilter = '';
        let conversationHistory = [];
        let aiEngine = null;
        
        // Initialize the assistant
        function initializeAssistant() {
            // Check if required data is loaded
            console.log('Checking data availability...');
            console.log('item_metadata available:', typeof item_metadata !== 'undefined');
            console.log('items available:', typeof items !== 'undefined');
            
            if (typeof item_metadata !== 'undefined') {
                console.log('item_metadata entries:', Object.keys(item_metadata).length);
            }
            
            // Initialize the AI engine
            aiEngine = new FilterPhoenixAI();
            
            // Create additional elements that startup() expects
            createRequiredElements();
            
            // Initialize the existing FilterBird functionality
            if (typeof initial_load === 'function') {
                initial_load();
            }
            
            addMessage('assistant', 'FilterPhoenix AI Assistant initialized! I can help you create sophisticated filters, and you can test them using the built-in FilterPhoenix simulation below. What would you like to do today?');
        }
        
        // Create elements that FilterBird's startup() function expects
        function createRequiredElements() {
            const requiredElements = [
                { id: 'filter_text_2', tag: 'textarea', style: 'display: none;' },
                { id: 'background_1', tag: 'img', style: 'display: none;' },
                { id: 'background_2', tag: 'img', style: 'display: none;' },
                { id: 'original', tag: 'input', type: 'checkbox', style: 'display: none;' },
                { id: 'non_item_custom', tag: 'input', type: 'checkbox', style: 'display: none;' },
                { id: 'custom', tag: 'input', type: 'checkbox', style: 'display: none;' },
                { id: 'price', tag: 'input', type: 'number', value: '0', style: 'display: none;' },
                { id: 'dropdown_ilvl', tag: 'select', style: 'display: none;' },
                { id: 'dropdown_id', tag: 'select', style: 'display: none;' },
                { id: 'identified', tag: 'input', type: 'checkbox', style: 'display: none;' },
                { id: 'dropdown_group', tag: 'select', style: 'display: none;' },
                { id: 'dropdown_type', tag: 'select', style: 'display: none;' },
                { id: 'dropdown_base', tag: 'select', style: 'display: none;' },
                { id: 'dropdown_rarity', tag: 'select', style: 'display: none;' },
                { id: 'select_price', tag: 'div', style: 'display: none;' },
                { id: 'multiple_spacing', tag: 'div', style: 'display: none;' },
                { id: 'output_spacing', tag: 'div', style: 'display: none;' },
                { id: 'output_2', tag: 'div', style: 'display: none;' },
                { id: 'output_area_2', tag: 'div', style: 'position: relative; width: 400px; height: 200px; background-color: #1a1a1a; border: 1px solid #555; display: none;' },
                { id: 'item_desc1', tag: 'div', style: 'display: none;' },
                { id: 'item_desc2', tag: 'div', style: 'display: none;' }
            ];
            
            // Add a default option to dropdowns to prevent errors
            requiredElements.forEach(elem => {
                if (!document.getElementById(elem.id)) {
                    const element = document.createElement(elem.tag);
                    element.id = elem.id;
                    if (elem.type) element.type = elem.type;
                    if (elem.value) element.value = elem.value;
                    element.style.cssText = elem.style;
                    
                    // Add default options for select elements
                    if (elem.tag === 'select') {
                        for (let i = 0; i < 15; i++) {
                            const option = document.createElement('option');
                            option.value = i;
                            option.text = `Option ${i}`;
                            element.appendChild(option);
                        }
                    }
                    
                    document.body.appendChild(element);
                }
            });
            
            // Initialize settings object if it doesn't exist
            if (typeof window.settings === 'undefined') {
                window.settings = {
                    version: 0, // Path of Diablo
                    background: 1,
                    auto_simulate: 1,  // Enable auto-simulation
                    num_filters: 1,    // Single filter mode
                    nowrap_width: 800
                };
            }
            
            // Initialize character object if it doesn't exist (with default values from simulation.js)
            if (typeof window.character === 'undefined') {
                window.character = {
                    CLVL: 90,
                    CHARSTAT14: 199000,
                    CHARSTAT15: 199000,
                    DIFFICULTY: 2,
                    ILVL: 85,
                    CHARSTAT70: 0,
                    CHARSTAT13: 1000,
                    AMAZON: true,
                    ASSASSIN: false,
                    BARBARIAN: false,
                    DRUID: false,
                    NECROMANCER: false,
                    PALADIN: false,
                    SORCERESS: false,
                    SHOP: false,
                    EQUIPPED: false,
                    FILTLVL: 1
                };
            }
            
            // Initialize other required global variables
            if (typeof window.itemToCompare === 'undefined') {
                window.itemToCompare = {
                    name: "5000 Gold",
                    NAME: "5000 Gold", 
                    CODE: "GOLD",
                    GOLD: 5000,
                    ID: true,
                    always_id: true,
                    rarity: "regular"
                };
            }
            
            if (typeof window.item_old === 'undefined') {
                window.item_old = {};
            }
            
            if (typeof window.character_old === 'undefined') {
                window.character_old = {};
            }
            
            if (typeof window.settings_old === 'undefined') {
                window.settings_old = {};
            }
            
            if (typeof window.notices === 'undefined') {
                window.notices = {
                    duplicates: 0,
                    pd2_conditions: 0,
                    pod_conditions: 0,
                    colors: 0,
                    encoding: 0
                };
            }
            
            if (typeof window.item_settings === 'undefined') {
                window.item_settings = {
                    ID: false,
                    ILVL_return: 85
                };
            }
            
            // Create stub functions that startup() might call
            if (typeof window.toggleOriginalChoices !== 'function') {
                window.toggleOriginalChoices = function(checked) { /* stub */ };
            }
            if (typeof window.toggleNonItemDetails !== 'function') {
                window.toggleNonItemDetails = function(checked) { /* stub */ };
            }
            if (typeof window.toggleCustom !== 'function') {
                window.toggleCustom = function(checked) { /* stub */ };
            }
            
            // Create stub functions for custom item functionality
            if (typeof window.setGroup !== 'function') {
                window.setGroup = function(value) { /* stub */ };
            }
            if (typeof window.setType !== 'function') {
                window.setType = function(value) { /* stub */ };
            }
            if (typeof window.setBase !== 'function') {
                window.setBase = function(value) { /* stub */ };
            }
            if (typeof window.setRarity !== 'function') {
                window.setRarity = function(value) { /* stub */ };
            }
        }
        
        // Handle Enter key in chat input
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        // Send a message
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addMessage('user', message);
            input.value = '';
            
            // Process the user's request
            await processUserRequest(message);
        }
        
        // Add a message to the chat
        function addMessage(type, content) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            messageDiv.innerHTML = content;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Quick action buttons
        async function quickAction(action) {
            switch(action) {
                case 'create-new':
                    await processUserRequest('Create a new basic filter that shows important items and hides junk');
                    break;
                case 'hide-junk':
                    await processUserRequest('Add rules to hide low quality items and junk');
                    break;
                case 'highlight-runes':
                    await processUserRequest('Make all runes show with bright colors and notification sounds');
                    break;
                case 'show-uniques':
                    await processUserRequest('Show all unique items with special highlighting');
                    break;
                case 'currency-items':
                    await processUserRequest('Create a comprehensive currency filter with perfect gems, flawless gems, orb of corruption, orb of alteration, and all runes');
                    break;
                case 'endgame-filter':
                    await processUserRequest('Create an endgame filter that only shows valuable items');
                    break;
                case 'explain-filter':
                    if (currentFilter) {
                        await processUserRequest('Explain what my current filter does');
                    } else {
                        addMessage('assistant', 'No filter loaded yet. Create or load a filter first!');
                    }
                    break;
            }
        }
        
        // Main AI processing function
        async function processUserRequest(userInput) {
            addMessage('assistant', 'ü§î Processing your request...');
            
            try {
                // Use the AI engine to process the request
                const response = await aiEngine.processRequest(userInput, currentFilter);
                
                // Remove the "processing" message
                const messages = document.getElementById('chatMessages');
                messages.removeChild(messages.lastChild);
                
                addMessage('assistant', response.message);
                
                if (response.filter) {
                    currentFilter = response.filter;
                    showFilterPreview(response.filter);
                }
                
                if (response.suggestions && response.suggestions.length > 0) {
                    showSuggestions(response.suggestions);
                }
                
                if (response.explanation) {
                    addMessage('assistant', `<div class="explanation">${response.explanation}</div>`);
                }
                
            } catch (error) {
                // Remove the "processing" message
                const messages = document.getElementById('chatMessages');
                messages.removeChild(messages.lastChild);
                
                console.error('AI processing error:', error);
                addMessage('assistant', '‚ùå Sorry, I encountered an error processing your request. Please try rephrasing or being more specific.');
            }
        }
        
        // Show filter preview
        function showFilterPreview(filterCode) {
            document.getElementById('filterPreview').style.display = 'block';
            document.getElementById('filterCode').textContent = filterCode;
            document.getElementById('testSection').style.display = 'block';
            
            // Also populate the FilterPhoenix simulation area
            if (document.getElementById('filter_text_1')) {
                document.getElementById('filter_text_1').value = filterCode;
            }
        }
        
        // Show rule suggestions
        function showSuggestions(suggestions) {
            const suggestionsHtml = suggestions.map(suggestion => 
                `<div class="rule-suggestion" onclick="processUserRequest('${suggestion}')">${suggestion}</div>`
            ).join('');
            
            addMessage('assistant', `<div class="suggested-rules">
                <strong>üí° Suggestions for next steps:</strong>
                ${suggestionsHtml}
            </div>`);
        }
        
        // Populate test items dropdown
        function populateTestItems() {
            const select = document.getElementById('testItemSelect');
            
            // Add some common test items
            const testItems = [
                'Zod Rune', 'Ber Rune', 'Mal Rune', 'El Rune',
                'Shako (Unique)', 'Stormshield (Unique)', 'Tal Rasha\'s Guardianship',
                'Perfect Diamond', 'Chipped Emerald',
                'Grand Charm', 'Small Charm',
                'Throwing Axe', 'Flying Axe',
                'Leather Armor', 'Plate Mail',
                'Ring (Magic)', 'Amulet (Rare)',
                'Scroll of Town Portal', 'Antidote Potion'
            ];
            
            testItems.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                select.appendChild(option);
            });
        }
        
        // Test the current filter (simplified - uses FilterBird directly)
        function testFilter() {
            if (!currentFilter) {
                addMessage('assistant', '‚ùå No filter to test! Create or load a filter first.');
                return;
            }
            
            // Make sure the filter is in the textarea
            if (document.getElementById('filter_text_1')) {
                document.getElementById('filter_text_1').value = currentFilter;
            }
            
            addMessage('assistant', '‚úÖ Filter loaded into the simulation area below. Select an item and click "üß™ Test Filter" to see how it behaves!');
        }
        
        // Simple test runner that just calls FilterBird's simulate function
        function runFilterBirdTest() {
            if (typeof simulate === 'function') {
                simulate(1); // Call FilterBird's built-in simulation
                addMessage('assistant', '‚úÖ Filter test completed! Check the simulation results below.');
            } else {
                addMessage('assistant', '‚ùå FilterPhoenix simulation not available.');
            }
        }
        
        // Create a mock item for testing
        function createMockItem(itemName) {
            const item = {
                NAME: itemName,
                name: itemName,
                type: 'unknown',
                quality: 'normal',
                NORM: false,
                MAG: false,
                RARE: false,
                UNIQUE: false,
                SET: false,
                RUNE: false,
                GEM: false,
                SOCK: 0,
                ILVL: 50,
                QLVL: 30,
                ID: true,
                PRICE: 0,
                FILTERLVL: 2,
                ETH: false,
                INF: false
            };
            
            // Set properties based on item name
            if (itemName.includes('Rune')) {
                item.RUNE = extractRuneNumber(itemName);
                item.type = 'rune';
                item.quality = 'regular';  // Runes use 'regular' quality
                item.NMAG = true;
                item.NORM = false;
            } else if (itemName.includes('Unique') || itemName.includes('Shako') || itemName.includes('Stormshield')) {
                item.UNIQUE = true;
                item.type = 'unique';
                item.quality = 'unique';
                item.NORM = false;
            } else if (itemName.includes('Set') || itemName.includes('Tal Rasha')) {
                item.SET = true;
                item.type = 'set';
                item.quality = 'set';
                item.NORM = false;
            } else if (itemName.includes('Magic') || itemName.includes('Ring (Magic)')) {
                item.MAG = true;
                item.type = 'magic';
                item.quality = 'magic';
                item.NORM = false;
            } else if (itemName.includes('Rare') || itemName.includes('Amulet (Rare)')) {
                item.RARE = true;
                item.type = 'rare';
                item.quality = 'rare';
                item.NORM = false;
            } else if (itemName.includes('Diamond') || itemName.includes('Emerald')) {
                item.GEM = extractGemLevel(itemName);
                item.type = 'gem';
                item.quality = 'regular';  // Gems use 'regular' quality
                item.NMAG = true;
                item.NORM = false;
            } else {
                item.NORM = true;
                item.type = 'normal';
                item.quality = 'regular';  // Normal items use 'regular' quality
                item.NMAG = true;
            }
            
            // Set item type flags
            if (itemName.includes('Ring')) {
                item.RIN = true;
                item.WEAPON = false;
                item.ARMOR = false;
            } else if (itemName.includes('Amulet')) {
                item.AMU = true;
                item.WEAPON = false;
                item.ARMOR = false;
            } else if (itemName.includes('Charm')) {
                if (itemName.includes('Grand')) item.CM3 = true;
                else if (itemName.includes('Large')) item.CM2 = true;
                else item.CM1 = true;
                item.WEAPON = false;
                item.ARMOR = false;
            } else if (itemName.includes('Axe') || itemName.includes('Sword') || itemName.includes('Throwing')) {
                item.WEAPON = true;
                item.ARMOR = false;
                if (itemName.includes('Throwing') || itemName.includes('Flying')) {
                    item.WP5 = true; // Throwing weapons
                    item.THROWING = true;
                }
            } else if (itemName.includes('Armor') || itemName.includes('Helmet') || itemName.includes('Boots')) {
                item.ARMOR = true;
                item.WEAPON = false;
            }
            
            return item;
        }
        
        // Extract rune number from name
        function extractRuneNumber(runeName) {
            const runeNames = {
                'El': 1, 'Eld': 2, 'Tir': 3, 'Nef': 4, 'Eth': 5, 'Ith': 6, 'Tal': 7, 'Ral': 8,
                'Ort': 9, 'Thul': 10, 'Amn': 11, 'Sol': 12, 'Shael': 13, 'Dol': 14, 'Hel': 15,
                'Io': 16, 'Lum': 17, 'Ko': 18, 'Fal': 19, 'Lem': 20, 'Pul': 21, 'Um': 22,
                'Mal': 23, 'Ist': 24, 'Gul': 25, 'Vex': 26, 'Ohm': 27, 'Lo': 28, 'Sur': 29,
                'Ber': 30, 'Jah': 31, 'Cham': 32, 'Zod': 33
            };
            
            for (const [name, number] of Object.entries(runeNames)) {
                if (runeName.includes(name)) {
                    return number;
                }
            }
            return 1; // Default to El rune
        }
        
        // Extract gem level from name
        function extractGemLevel(gemName) {
            if (gemName.includes('Perfect')) return 5;
            if (gemName.includes('Flawless')) return 4;
            if (gemName.includes('Normal') || (!gemName.includes('Chipped') && !gemName.includes('Flawed'))) return 3;
            if (gemName.includes('Flawed')) return 2;
            if (gemName.includes('Chipped')) return 1;
            return 3; // Default to normal
        }
        
        // Get the item base for itemTemp
        function getItemBase(itemName) {
            if (itemName.includes('Rune')) return 'Rune';
            if (itemName.includes('Diamond') || itemName.includes('Emerald') || itemName.includes('Ruby') || 
                itemName.includes('Topaz') || itemName.includes('Sapphire') || itemName.includes('Amethyst') ||
                itemName.includes('Skull')) return 'Gem';
            if (itemName.includes('Ring')) return 'Ring';
            if (itemName.includes('Amulet')) return 'Amulet';
            if (itemName.includes('Grand Charm')) return 'Grand Charm';
            if (itemName.includes('Large Charm')) return 'Large Charm';
            if (itemName.includes('Small Charm')) return 'Small Charm';
            if (itemName.includes('Shako')) return 'Shako';
            if (itemName.includes('Stormshield')) return 'Monarch';
            if (itemName.includes('Flying Axe')) return 'Flying Axe';
            if (itemName.includes('Throwing Axe')) return 'Throwing Axe';
            if (itemName.includes('Armor') || itemName.includes('Plate')) return 'Plate Mail';
            if (itemName.includes('Potion')) return 'Potion';
            if (itemName.includes('Scroll')) return 'Scroll';
            return 'Unknown'; // Default
        }
        
        // Get the type_affix for itemTemp
        function getItemTypeAffix(itemName) {
            if (itemName.includes('Rune')) return 'rune';
            if (itemName.includes('Diamond') || itemName.includes('Emerald') || itemName.includes('Ruby') || 
                itemName.includes('Topaz') || itemName.includes('Sapphire') || itemName.includes('Amethyst') ||
                itemName.includes('Skull')) return 'gem';
            if (itemName.includes('Potion') || itemName.includes('Scroll')) return 'other';
            return 'equipment'; // Default for equipment items
        }
        
        // Simple rule matching for fallback
        function simpleRuleMatch(rule, itemName) {
            // Extract condition from rule
            const match = rule.match(/ItemDisplay\[(.*?)\]/);
            if (!match) return false;
            
            const condition = match[1];
            
            // Very basic matching - this could be enhanced
            if (condition.includes('RUNE') && itemName.includes('Rune')) return true;
            if (condition.includes('UNIQUE') && itemName.includes('Unique')) return true;
            if (condition.includes('SET') && itemName.includes('Set')) return true;
            if (condition.includes('GEM') && (itemName.includes('Diamond') || itemName.includes('Emerald'))) return true;
            if (condition.includes('RIN') && itemName.includes('Ring')) return true;
            if (condition.includes('AMU') && itemName.includes('Amulet')) return true;
            
            return false;
        }
        
        // Download filter
        function downloadFilter() {
            if (!currentFilter) {
                addMessage('assistant', '‚ùå No filter to download! Create a filter first.');
                return;
            }
            
            const blob = new Blob([currentFilter], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'filterbird-ai-generated.filter';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            addMessage('assistant', 'üíæ Filter downloaded! You can now use it in Path of Diablo.');
        }
        
        // Copy to clipboard
        function copyToClipboard() {
            if (!currentFilter) {
                addMessage('assistant', '‚ùå No filter to copy! Create a filter first.');
                return;
            }
            
            navigator.clipboard.writeText(currentFilter).then(() => {
                addMessage('assistant', 'üìã Filter copied to clipboard!');
            }).catch(() => {
                addMessage('assistant', '‚ùå Failed to copy to clipboard. Please copy manually from the preview above.');
            });
        }
        
        // Initialize FilterBird when page loads
        function initializeFilterBird() {
            console.log('Initializing FilterBird...');
            
            // Create required DOM elements first
            createRequiredElements();
            console.log('Required elements created');
            
            // Call startup() function from simulation.js
            if (typeof startup === 'function') {
                console.log('Calling startup() function...');
                startup();
                console.log('Startup completed');
                
                // Check if dropdowns are populated
                const itemDropdown = document.getElementById('dropdown_item');
                const clvlDropdown = document.getElementById('dropdown_clvl');
                
                if (itemDropdown) {
                    console.log('Item dropdown options count:', itemDropdown.options.length);
                }
                if (clvlDropdown) {
                    console.log('Character level dropdown options count:', clvlDropdown.options.length);
                }
                
                // Add some default filter code to demonstrate functionality
                const filterText = document.getElementById('filter_text_1');
                if (filterText && !filterText.value.trim()) {
                    filterText.value = `// Sample filter - shows high runes and unique items
ItemDisplay[RUNE>=20]: %PURPLE%¬´ %NAME% ¬ª
ItemDisplay[UNI]: %GOLD%* %NAME% *
ItemDisplay[SET]: %GREEN%+ %NAME% +
ItemDisplay[]: %NAME%`;
                }
                
                // Trigger initial simulation
                if (typeof simulate === 'function') {
                    console.log('Running initial simulation...');
                    simulate(1);
                }
            } else {
                console.error('startup() function not found');
            }
        }
        
        // Initialize when page loads
        window.addEventListener('load', function() {
            initializeFilterBird();
            
            // Add welcome message
            addMessage('assistant', 'üéÆ Welcome to FilterBird AI Assistant! I can help you create custom item filters for Path of Diablo using natural language. Try asking me something like: "Create a filter that shows high runes and unique items" or "I want to see all armor with defense over 500".');
        });
    </script>
</body>
</html>